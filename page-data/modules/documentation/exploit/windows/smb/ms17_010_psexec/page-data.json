{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/smb/ms17_010_psexec","result":{"data":{"moduleMetadataJson":{"id":"475e92ad-244a-5caf-b23c-687cf69bcf69","name":"MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution","fullname":"exploit/windows/smb/ms17_010_psexec","description":"This module will exploit SMB with vulnerabilities in MS17-010 to achieve a write-what-where\n        primitive. This will then be used to overwrite the connection session information with as an\n        Administrator session. From there, the normal psexec payload code execution is done.\n\n        Exploits a type confusion between Transaction and WriteAndX requests and a race condition in\n        Transaction requests, as seen in the EternalRomance, EternalChampion, and EternalSynergy\n        exploits. This exploit chain is more reliable than the EternalBlue exploit, but requires a\n        named pipe.","rank":300,"fields":{"detailsSlug":"/modules/details/exploit/windows/smb/ms17_010_psexec","documentationSlug":"/modules/documentation/exploit/windows/smb/ms17_010_psexec","referencesSlug":"/modules/references/exploit/windows/smb/ms17_010_psexec"},"documentation":{"html":"<p>MS17-010 are psexec are two of the most popular exploits against Microsoft Windows. This module bolts the two together.</p>\n<p>You can run any command as SYSTEM, or stage Meterpreter. Note: unlike EternalBlue, kernel shellcode is not used to stage Meterpreter, so you might have to evade your payloads.</p>\n<ul>\n<li>CVE-2017-0146 (EternalChampion/EternalSynergy) - exploit a race condition with Transaction requests</li>\n<li>CVE-2017-0143 (EternalRomance/EternalSynergy) - exploit a type confusion between WriteAndX and Transaction requests</li>\n</ul>\n<p>This module is highly reliable and preferred over EternalBlue where a Named Pipe is accessible for anonymous logins (generally, everything pre-Vista, and relatively common for domain computers in the wild).</p>\n<h2 id=\"vulnerable-server\" style=\"position:relative;\"><a href=\"#vulnerable-server\" aria-label=\"vulnerable server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Server</h2>\n<p>To be able to use exploit/windows/smb/ms17<em>010</em>psexec:</p>\n<ol>\n<li>You can OPTIONALLY use a valid username/password to bypass most of these requirements.</li>\n<li>The firewall must allow SMB traffic.</li>\n<li>The target must use SMBv1.</li>\n<li>The target must be missing the MS17-010 patch.</li>\n<li>The target must allow anonymous IPC$ and a Named Pipe.</li>\n</ol>\n<p>You can check all of these with the SMB MS17-010 and Pipe Auditor auxiliary scanner modules.</p>\n<p>If you're having trouble configuring an anonymous named pipe,\nMicrosoft's\n<a href=\"https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-access-named-pipes-that-can-be-accessed-anonymously\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">documentation</a>\non the topic may be helpful.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<p>At the minimum, you should be able use psexec to get a session with a valid credential using the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf &gt; use exploit/windows/smb/ms17_010_psexec\nmsf exploit(psexec) &gt; set RHOST 192.168.1.80\nRHOST =&gt; 192.168.1.80\nmsf exploit(psexec) &gt; exploit</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<p>By default, using exploit/windows/smb/ms17<em>010</em>psexec can be as simple as setting the RHOST option, and you're ready to go.</p>\n<p><strong>The NAMEDPIPE Option</strong></p>\n<p>By default, the module will scan for a list of common pipes for any available one. You can specify one by name.</p>\n<p><strong>The LEAKATTEMPTS Option</strong></p>\n<p>Information leaks are used to ensure stability of the exploit. Sometimes they don't pop on the first try.</p>\n<p><strong>The DBGTRACE Option</strong></p>\n<p>Used to debug, gives extremely verbose information.</p>\n<p><strong>The SMBUser Option</strong></p>\n<p>This is a valid Windows username.</p>\n<p><strong>The SMBPass option</strong></p>\n<p>This can be either the plain text version or the Windows hash.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<p><strong>Automatic Target</strong></p>\n<p>There are multiple targets available for exploit/windows/smb/psexec. The Automatic target is the default target. If the  Automatic target detects Powershell on the remote machine, it will try Powershell, otherwise it uses the natvie upload. Each target is explained below.</p>\n<p><strong>Powershell Target</strong></p>\n<p>The Powershell target forces the psexec module to run a Powershell command with a payload embedded in it. Since this approach does not leave anything on disk, it is a very powerful way to evade antivirus. However, older Windows machines might not support Powershell by default.</p>\n<p>Because of this, you will probably want to use the Automatic target setting. The automatic mode will check if the target supports Powershell before it tries it; the manually set Powershell target won't do that.</p>\n<p><strong>Native Upload Target</strong></p>\n<p>The Native target will attempt to upload the payload (executable) to SYSTEM32 (which can be modified with the\nSHARE datastore option), and then execute it with psexec.</p>\n<p>This approach is generally reliable, but has a high chance of getting caught by antivirus on the target. To counter this, you can try to use a template by setting the EXE::Path and EXE::Template datastore options. Or, you can supply your own custom EXE by setting the EXE::Custom option.</p>\n<p><strong>MOF Upload Target</strong></p>\n<p>The <a href=\"https://github.com/rapid7/metasploit-framework/wiki/How-to-use-WbemExec-for-a-write-privilege-attack-on-Windows\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MOF</a> target technically does not use psexec; it does not explicitly tell Windows to execute anything. All it does is upload two files: the payload (exe) in SYSTEM32 and a managed object\nformat file in SYSTEM32\\wbem\\mof\\ directory. When Windows sees the MOF file in that directory, it automatically runs it. Once executed, the code inside the MOF file basically tells Windows to execute our payload in SYSTEM32, and you get a session.</p>\n<p>Although it's a neat trick, Metasploit's MOF library only works against Windows XP and Windows Server 2003. And since it writes files to disk, there is also a high chance of getting\ncaught by antivirus on the target.</p>\n<p>The best way to counter antivirus is still the same. You can either use a different template by setting the EXE::Path and EXE::Template datastore options or you can supply your own custom EXE by setting the EXE::Custom option.</p>"}}},"pageContext":{"id":"475e92ad-244a-5caf-b23c-687cf69bcf69"}}}