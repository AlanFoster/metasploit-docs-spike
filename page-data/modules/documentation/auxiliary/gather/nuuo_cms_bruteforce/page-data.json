{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/auxiliary/gather/nuuo_cms_bruteforce","result":{"data":{"moduleMetadataJson":{"id":"951212ae-2afb-5bef-b44b-597d499b8e4c","name":"Nuuo Central Management Server User Session Token Bruteforce","fullname":"auxiliary/gather/nuuo_cms_bruteforce","description":"Nuuo Central Management Server below version 2.4 has a flaw where it sends the\n        heap address of the user object instead of a real session number when a user logs\n        in. This can be used to reduce the keyspace for the session number from 10 million\n        to 1.2 million, and with a bit of analysis it can be guessed in less than 500k tries.\n        This module does exactly that - it uses a computed occurence table to try the most common\n        combinations up to 1.2 million to try to guess a valid user session.\n        This session number can then be used to achieve code execution or download files - see\n        the other Nuuo CMS auxiliary and exploit modules.\n        Note that for this to work a user has to be logged into the system.","rank":300,"fields":{"detailsSlug":"/modules/details/auxiliary/gather/nuuo_cms_bruteforce","documentationSlug":"/modules/documentation/auxiliary/gather/nuuo_cms_bruteforce"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>Nuuo CMS Session Bruteforce</p>\n<p>The NUUO CMS protocol uses session tokens in a similar way to HTTP cookies. As mentioned in the summary, if a USERLOGIN request is sent with a correct username and password, a \"User-Session-No\" token will be returned. The number returned is composed of 8 digits, so if an attacker wanted to guess it, they would have 10 million possibilities, and would be able to bruteforce it on average after 5 million tries.</p>\n<p>The function responsible for creating a new user is at offset 0x454E80 in CMS_Server.exe version 2.1. It sets up a new user object and returns the session token to the calling function. This function has what is probably a coding error - the number returned is actually not a number, but the heap address of the user object created by invoking \"new()\" in the user object class. An assembly snippet is shown below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">.text:00454E80 000                 push    0FFFFFFFFh\n.text:00454E82 004                 push    offset loc_5E2013\n.text:00454E87 008                 mov     eax, large fs:0\n.text:00454E8D 008                 push    eax\n.text:00454E8E 00C                 sub     esp, 8    \n.text:00454E91 014                 push    ebp\n.text:00454E92 018                 push    esi\n.text:00454E93 01C                 push    edi\n.text:00454E94 020                 mov     eax, dword_68D134\n.text:00454E99 020                 xor     eax, esp   \n.text:00454E9B 020                 push    eax\n.text:00454E9C 024                 lea     eax, [esp+24h+var_C]\n.text:00454EA0 024                 mov     large fs:0, eax\n.text:00454EA6 024                 mov     ebp, ecx\n.text:00454EA8 024                 lea     edi, [ebp+43Ch] \n.text:00454EAE 024                 push    edi             ; lpCriticalSection_EnterCriticalSection\n.text:00454EAF 028                 mov     [esp+28h+var_10], edi\n.text:00454EB3 028                 call    ds:EnterCriticalSection\n.text:00454EB9 024                 push    1B8h            ; unsigned int\n.text:00454EBE 028                 mov     [esp+28h+var_4], 0\n.text:00454EC6 028                 call    ??2@YAPAXI@Z    ; new() operator, returns object in eax\n(...)</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>After the call to ??2@YAPAXI@Z in .text:00454EC6, the session number is returned to the calling function (sub_457100), which then stores it and sends it back to the client as the valid session number:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">NUCM/1.0 200 OK\nUser-Valid: %d\nServer-Version: %s\nIni-Version: %d\nLicense-Number: %d\nUser-Session-No: %u &lt;---- session number, which is a hexadecimal memory address converted to decimal</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>These session numbers (tokens) are not that easy to predict, however after collecting thousands of samples I was able to build a table of the most common occurrences, which reduces the possibilities from 10 million to about 1.2 million. In practice, the tokens can usually be guessed between in less than 500,000 attempts - an improvement of 95% over standard bruteforcing. It is likely this can be further improved with some deeper analysis, but due to time constraints this was not investigated further. The tables used to do the bruteforcing are in Appendix #C.</p>\n<p>This attack is perfectly feasible despite the high number of attempts needed. Firstly, there is no bruteforce protection on the CMS server, so we can just flood it with requests and find the session number in less than an hour.\nSecondly, due to the nature of this application, it is normal to have the software clients logged in for a long amount of time (days, weeks) in order to monitor the video cameras controlled by CMS.</p>\n<p>It is worth noticing that when a user logs in, the session has to be maintained by periodically sending a PING request. To bruteforce the session, we send each guess with a PING request until a 200 OK message is received. </p>\n<p><a href=\"d1.nuuo.com/NUUO/CMS/\">NUUO Central Management Server (CMS): all versions below 2.4.0</a></p>\n<ul>\n<li>1.5.2 OK</li>\n<li>2.1.0 OK</li>\n<li>2.3.0 OK</li>\n</ul>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"tested-on-windows-10-pro-x64-running-ncs-server-v210\" style=\"position:relative;\"><a href=\"#tested-on-windows-10-pro-x64-running-ncs-server-v210\" aria-label=\"tested on windows 10 pro x64 running ncs server v210 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tested on Windows 10 Pro x64 running NCS Server v2.1.0</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf5 auxiliary(gather/nuuo_cms_bruteforce) &gt; set rhosts 172.22.222.200\nrhosts =&gt; 172.22.222.200\nmsf5 auxiliary(gather/nuuo_cms_bruteforce) &gt; exploit\n\n[*] 172.22.222.200:5180 - Bruteforcing session - this might take a while, go get some coffee!\n[*] 172.22.222.200:5180 - Generating 2621440 session tokens\n[+] 172.22.222.200:5180 - Found valid user session: 42094216\n[*] 172.22.222.200:5180 - Time taken: 1384.588721601991 seconds; total tries 590893\n[*] Auxiliary module execution completed\nmsf5 auxiliary(gather/nuuo_cms_bruteforce) &gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"951212ae-2afb-5bef-b44b-597d499b8e4c"}}}