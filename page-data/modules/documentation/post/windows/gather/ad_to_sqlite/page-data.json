{"componentChunkName":"component---src-templates-module-documentation-template-tsx","path":"/modules/documentation/post/windows/gather/ad_to_sqlite","result":{"data":{"moduleMetadataJson":{"id":"e8b4bd92-fc71-504e-8c32-d3eb3b37aa6b","name":"AD Computer, Group and Recursive User Membership to Local SQLite DB","fullname":"post/windows/gather/ad_to_sqlite","description":"This module will gather a list of AD groups, identify the users (taking into account recursion)\n        and write this to a SQLite database for offline analysis and query using normal SQL syntax.","rank":300,"fields":{"detailsSlug":"/modules/details/post/windows/gather/ad_to_sqlite","documentationSlug":"/modules/documentation/post/windows/gather/ad_to_sqlite"},"documentation":{"html":"<h2 id=\"introduction\" style=\"position:relative;\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>This is a post exploitation module which has the effect of copying the AD groups, user membership\n(taking into account nested groups), user information and computers to a local SQLite database.\nThis is particularly useful for red teaming and simulated attack engagements because it offers\nthe ability to gain situational awareness of the target's domain completely offline. Examples of\nqueries that can be run locally include:</p>\n<ul>\n<li>Identification of members in a particular group (e.g. 'Domain Admins'), taking into account\nmembers of nested groups.</li>\n<li>Organizational hierarchy information (if the manager LDAP attribute is used).</li>\n<li>Ability to determine group membership and user membership (e.g. 'What groups are these users a\nmember of?', 'What users are members of these groups?', 'List all members who are effectively\nmembers of the Domain Admins group who are not disabled' etc)</li>\n<li>Expansion of the userAccountControl and sAMAccountType variables for querying ease.</li>\n<li>Generation of a list of DNS hostnames, computer names, operating system versions etc of each\ndomain joined computer.</li>\n<li>Identification of security groups that have managers.</li>\n<li>Exporting anything above in different formats, including those which can be imported into\nother tools.</li>\n</ul>\n<h2 id=\"mechanism\" style=\"position:relative;\"><a href=\"#mechanism\" aria-label=\"mechanism permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mechanism</h2>\n<p>This module makes heavy usage of ADSI and performs the following basic steps:</p>\n<p><strong>User and group acquisition</strong></p>\n<ul>\n<li>Perform an ADSI query to list all active directory groups and store them in the local ad_groups\ntable (parsing attributes which contain flags).</li>\n<li>Loop through them and, for each group, launch another LDAP query to list the effective members of\nthe group (using the LDAP<em>MATCHING</em>RULE<em>IN</em>CHAIN OID). The effect is that it will reveal all\neffective members of that group, even if they are not direct members of the group.</li>\n<li>For each user, perform another query to obtain user specific attributes and insert them into the\nlocal ad_users table.</li>\n<li>Insert a new row into the ad_mapping table associating the user RID with the group RID.</li>\n</ul>\n<p><strong>Computer acquisition</strong></p>\n<ul>\n<li>Perform an ADSI query to list all computers in the domain.</li>\n<li>Parse any attributes containing flags (userAccountControl, sAMAccountType) and insert them into\nthe local ad_computers table.</li>\n</ul>\n<h2 id=\"module-specific-options\" style=\"position:relative;\"><a href=\"#module-specific-options\" aria-label=\"module specific options permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Module Specific Options</h2>\n<table>\n<thead>\n<tr>\n<th>Option</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>GROUP_FILTER</td>\n<td>Additional LDAP filters to apply when building the initial list of groups.</td>\n</tr>\n<tr>\n<td>SHOW_COMPUTERS</td>\n<td>If set to TRUE, this will write a line-by-line list of computers, in the format: <code class=\"language-text\">Computer [Name][DNS][RID]</code> to the console. For example: <code class=\"language-text\">Computer [W2K8DC][W2K8DC.goat.stu][1000]</code></td>\n</tr>\n<tr>\n<td>SHOW_USERGROUPS</td>\n<td>If set to TRUE, this will write a line-by-line list of user to group memberships, in the format: <code class=\"language-text\">Group [Group Name][Group RID] has member [Username][User RID]</code>. For example: <code class=\"language-text\">Group [Domain Users][513] has member [it.director][1132]</code>. This can be used mainly for progress, but it may be simpler to cat and grep for basic queries. However, the real power of this module comes from the ability to rapidly perform queries against the SQLite database.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"sqlite-database\" style=\"position:relative;\"><a href=\"#sqlite-database\" aria-label=\"sqlite database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLite Database</h2>\n<p><strong>Construction</strong></p>\n<p>The following tables will be present in the local SQLite database. The ad<em>* tables use the RID of\nthe user, computer or group as the primary key, and the view</em>mapping table effectively joins the\nad<em>mapping table with ad</em>users.* and ad_groups.* by RID.</p>\n<p>Note that the purpose of the less obvious flags is documented in the source code, along with\nreferences to MSDN and Technet where appropriate, so this can be easily looked up during an\nengagement without needing to refer to this page.</p>\n<table>\n<thead>\n<tr>\n<th>Table Name</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ad_computers</td>\n<td>Information on each of the domain joined computers.</td>\n</tr>\n<tr>\n<td>ad_users</td>\n<td>Information on each of the domain users.</td>\n</tr>\n<tr>\n<td>ad_groups</td>\n<td>Information on each of the active directory groups.</td>\n</tr>\n<tr>\n<td>ad_mapping</td>\n<td>Links the users table to the groups table (i.e. can be used to show which users are effectively members of which groups).</td>\n</tr>\n<tr>\n<td>view_mapping</td>\n<td>Joins the ad<em>mapping table to the ad</em>users and ad_groups table, provided for convenience. This will be the table that most queries will be run against.</td>\n</tr>\n</tbody>\n</table>\n<p>Within each table, the naming convention for the columns is to prefix anything in the\nad<em>computers table with c</em>, anything in the ad<em>users table with u</em> and anything in the\nad<em>groups table with g</em>. This convention makes the joins between tables much more intuitive.</p>\n<p><strong>ad_computers</strong></p>\n<p>The table below shows the columns in the ad<em>computers table. The fields in capitals at the end\n(c</em>ADS<em>* and c</em>SAM_*) are expanded from the userAccountControl and sAMAccountType attributes to\nprovide an easy way to perform the queries against individual flags.</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>c_rid</td>\n<td>INTEGER</td>\n<td>The relative identifier which is derived from the objectSid (i.e. the last group of digits).</td>\n</tr>\n<tr>\n<td>c_distinguishedName</td>\n<td>TEXT</td>\n<td>The main 'fully qualified' reference to the object. See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/aa366101%28v=vs.85%29.aspx\">Distinguished Names</a>.</td>\n</tr>\n<tr>\n<td>c_cn</td>\n<td>TEXT</td>\n<td>The name that represents an object. Used to perform searches.</td>\n</tr>\n<tr>\n<td>c_sAMAccountType</td>\n<td>INTEGER</td>\n<td>This attribute contains information about every account type object. As this can only have one value, it would be more efficient to implement a lookup table for this, but I have included individual flags simply for consistency.</td>\n</tr>\n<tr>\n<td>c_sAMAccountName</td>\n<td>TEXT</td>\n<td>The logon name used to support clients and servers running earlier versions of the operating system.</td>\n</tr>\n<tr>\n<td>c_dNSHostName</td>\n<td>TEXT</td>\n<td>The name of computer, as registered in DNS.</td>\n</tr>\n<tr>\n<td>c_displayName</td>\n<td>TEXT</td>\n<td>The display name for an object. This is usually the combination of the users first name, middle initial, and last name.</td>\n</tr>\n<tr>\n<td>c_logonCount</td>\n<td>INTEGER</td>\n<td>The number of times the account has successfully logged on. A value of 0 indicates that the value is unknown.</td>\n</tr>\n<tr>\n<td>c_userAccountControl</td>\n<td>INTEGER</td>\n<td>Flags that control the behavior of the user account. See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/ms680832%28v=vs.85%29.aspx\">Use-Account-Control attribute</a> for a description, but they are also parsed and stored in the c<em>ADS</em>UF_* columns below.</td>\n</tr>\n<tr>\n<td>c_primaryGroupID</td>\n<td>INTEGER</td>\n<td>Contains the relative identifier (RID) for the primary group of the user. By default, this is the RID for the Domain Users group.</td>\n</tr>\n<tr>\n<td>c_badPwdCount</td>\n<td>INTEGER</td>\n<td>The number of times the user tried to log on to the account using an incorrect password. A value of 0 indicates that the value is unknown.</td>\n</tr>\n<tr>\n<td>c_description</td>\n<td>TEXT</td>\n<td>Contains the description to display for an object.</td>\n</tr>\n<tr>\n<td>c_comment</td>\n<td>TEXT</td>\n<td>The user's comment. This string can be a null string. Sometimes passwords or sensitive information can be stored here.</td>\n</tr>\n<tr>\n<td>c_operatingSystem</td>\n<td>TEXT</td>\n<td>The Operating System name, for example, Windows Vista Enterprise.</td>\n</tr>\n<tr>\n<td>c_operatingSystemServicePack</td>\n<td>TEXT</td>\n<td>The operating system service pack ID string (for example, SP3).</td>\n</tr>\n<tr>\n<td>c_operatingSystemVersion</td>\n<td>TEXT</td>\n<td>The operating system version string, for example, 4.0.</td>\n</tr>\n<tr>\n<td>c_whenChanged</td>\n<td>TEXT</td>\n<td>The date when this object was last changed. This value is not replicated and exists in the global catalog.</td>\n</tr>\n<tr>\n<td>c_whenCreated</td>\n<td>TEXT</td>\n<td>The date when this object was created. This value is replicated and is in the global catalog.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF_SCRIPT</td>\n<td>INTEGER</td>\n<td>If 1, the logon script is executed.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF_ACCOUNTDISABLE</td>\n<td>INTEGER</td>\n<td>If 1, the user account is disabled.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>HOMEDIR</em>REQUIRED</td>\n<td>INTEGER</td>\n<td>If 1, the home directory is required.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF_LOCKOUT</td>\n<td>INTEGER</td>\n<td>If 1, the account is currently locked out.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>PASSWD</em>NOTREQD</td>\n<td>INTEGER</td>\n<td>If 1, no password is required.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>PASSWD</em>CANT_CHANGE</td>\n<td>INTEGER</td>\n<td>If 1, the user cannot change the password.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>ENCRYPTED</em>TEXT<em>PASSWORD</em>ALLOWED</td>\n<td>INTEGER</td>\n<td>If 1, the user can send an encrypted password.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>TEMP</em>DUPLICATE_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is an account for users whose primary account is in another domain. This account provides user access to this domain, but not to any domain that trusts this domain. Also known as a local user account.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>NORMAL</em>ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a default account type that represents a typical user.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>INTERDOMAIN</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a permit to trust account for a system domain that trusts other domains.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>WORKSTATION</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a computer account for a computer that is a member of this domain.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>SERVER</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a computer account for a system backup domain controller that is a member of this domain.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>DONT</em>EXPIRE_PASSWD</td>\n<td>INTEGER</td>\n<td>If 1, the password for this account will never expire.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>MNS</em>LOGON_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is an MNS logon account.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>SMARTCARD</em>REQUIRED</td>\n<td>INTEGER</td>\n<td>If 1, the user must log on using a smart card.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>TRUSTED</em>FOR_DELEGATION</td>\n<td>INTEGER</td>\n<td>If 1, the service account (user or computer account), under which a service runs, is trusted for Kerberos delegation. Any such service can impersonate a client requesting the service.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>NOT</em>DELEGATED</td>\n<td>INTEGER</td>\n<td>If 1, the security context of the user will not be delegated to a service even if the service account is set as trusted for Kerberos delegation.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>USE</em>DES<em>KEY</em>ONLY</td>\n<td>INTEGER</td>\n<td>If 1, restrict this principal to use only Data Encryption Standard (DES) encryption types for keys.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>DONT</em>REQUIRE_PREAUTH</td>\n<td>INTEGER</td>\n<td>If 1, this account does not require Kerberos pre-authentication for logon.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>PASSWORD</em>EXPIRED</td>\n<td>INTEGER</td>\n<td>If 1, the user password has expired. This flag is created by the system using data from the Pwd-Last-Set attribute and the domain policy.</td>\n</tr>\n<tr>\n<td>c<em>ADS</em>UF<em>TRUSTED</em>TO<em>AUTHENTICATE</em>FOR_DELEGATION</td>\n<td>INTEGER</td>\n<td>If 1, the account is enabled for delegation. This is a security-sensitive setting; accounts with this option enabled should be strictly controlled. This setting enables a service running under the account to assume a client identity and authenticate as that user to other remote servers on the network.</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>DOMAIN_OBJECT</td>\n<td>INTEGER</td>\n<td>See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/ms679637%28v=vs.85%29.aspx\">SAM-Account-Type</a> attribute. If 1, this flag is set.</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>GROUP_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>NON<em>SECURITY</em>GROUP_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>ALIAS_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>NON<em>SECURITY</em>ALIAS_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>USER_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>NORMAL<em>USER</em>ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>MACHINE_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>APP<em>BASIC</em>GROUP</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>APP<em>QUERY</em>GROUP</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>c<em>SAM</em>ACCOUNT<em>TYPE</em>MAX</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n</tbody>\n</table>\n<p><strong>ad_users</strong></p>\n<p>The table below shows the columns in the ad<em>computers table. The fields in capitals at the end\n(c</em>ADS<em>* and c</em>SAM_*) are expanded from the userAccountControl and sAMAccountType attributes to\nprovide an easy way to perform the queries against individual flags.</p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>u_rid</td>\n<td>INTEGER</td>\n<td>The relative identifier which is derived from the objectSid (i.e. the last group of digits).</td>\n</tr>\n<tr>\n<td>u_distinguishedName</td>\n<td>TEXT</td>\n<td>The main 'fully qualified' reference to the object. See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/aa366101%28v=vs.85%29.aspx\">Distinguished Names</a>.</td>\n</tr>\n<tr>\n<td>u_cn</td>\n<td>TEXT</td>\n<td>The name that represents an object. Used to perform searches.</td>\n</tr>\n<tr>\n<td>u_sAMAccountType</td>\n<td>INTEGER</td>\n<td>This attribute contains information about every account type object. As this can only have one value, it would be more efficient to implement a lookup table for this, but I have included individual flags simply for consistency.</td>\n</tr>\n<tr>\n<td>u_sAMAccountName</td>\n<td>TEXT</td>\n<td>The logon name used to support clients and servers running earlier versions of the operating system.</td>\n</tr>\n<tr>\n<td>u_dNSHostName</td>\n<td>TEXT</td>\n<td>The name of computer, as registered in DNS.</td>\n</tr>\n<tr>\n<td>u_displayName</td>\n<td>TEXT</td>\n<td>The display name for an object. This is usually the combination of the users first name, middle initial, and last name.</td>\n</tr>\n<tr>\n<td>u_logonCount</td>\n<td>INTEGER</td>\n<td>The number of times the account has successfully logged on. A value of 0 indicates that the value is unknown.</td>\n</tr>\n<tr>\n<td>u_userPrincipalName</td>\n<td>TEXT</td>\n<td>Technically, this is an Internet-style login name for a user based on the Internet standard RFC 822. By convention and in practice, it is the user's e-mail address.</td>\n</tr>\n<tr>\n<td>u_displayName</td>\n<td>TEXT</td>\n<td>N/A</td>\n</tr>\n<tr>\n<td>u_adminCount</td>\n<td>INTEGER</td>\n<td>Indicates that a given object has had its ACLs changed to a more secure value by the system because it was a member of one of the administrative groups (directly or transitively).</td>\n</tr>\n<tr>\n<td>u_userAccountControl</td>\n<td>INTEGER</td>\n<td>Flags that control the behavior of the user account. See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/ms680832%28v=vs.85%29.aspx\">User-Account-Control</a> for a description, but they are also parsed and stored in the c<em>ADS</em>UF_* columns below.</td>\n</tr>\n<tr>\n<td>u_primaryGroupID</td>\n<td>INTEGER</td>\n<td>Contains the relative identifier (RID) for the primary group of the user. By default, this is the RID for the Domain Users group.</td>\n</tr>\n<tr>\n<td>u_badPwdCount</td>\n<td>INTEGER</td>\n<td>The number of times the user tried to log on to the account using an incorrect password. A value of 0 indicates that the value is unknown.</td>\n</tr>\n<tr>\n<td>u_description</td>\n<td>TEXT</td>\n<td>Contains the description to display for an object.</td>\n</tr>\n<tr>\n<td>u_title</td>\n<td>TEXT</td>\n<td>Contains the user's job title. This property is commonly used to indicate the formal job title, such as Senior Programmer, rather than occupational class.</td>\n</tr>\n<tr>\n<td>u_manager</td>\n<td>TEXT</td>\n<td>The distinguished name of this user's manager.</td>\n</tr>\n<tr>\n<td>u_comment</td>\n<td>TEXT</td>\n<td>The user's comment. This string can be a null string. Sometimes passwords or sensitive information can be stored here.</td>\n</tr>\n<tr>\n<td>u_whenChanged</td>\n<td>TEXT</td>\n<td>The date when this object was last changed. This value is not replicated and exists in the global catalog.</td>\n</tr>\n<tr>\n<td>u_whenCreated</td>\n<td>TEXT</td>\n<td>The date when this object was created. This value is replicated and is in the global catalog.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF_SCRIPT</td>\n<td>INTEGER</td>\n<td>If 1, the logon script is executed.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF_ACCOUNTDISABLE</td>\n<td>INTEGER</td>\n<td>If 1, the user account is disabled.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>HOMEDIR</em>REQUIRED</td>\n<td>INTEGER</td>\n<td>If 1, the home directory is required.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF_LOCKOUT</td>\n<td>INTEGER</td>\n<td>If 1, the account is currently locked out.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>PASSWD</em>NOTREQD</td>\n<td>INTEGER</td>\n<td>If 1, no password is required.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>PASSWD</em>CANT_CHANGE</td>\n<td>INTEGER</td>\n<td>If 1, the user cannot change the password.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>ENCRYPTED</em>TEXT<em>PASSWORD</em>ALLOWED</td>\n<td>INTEGER</td>\n<td>If 1, the user can send an encrypted password.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>TEMP</em>DUPLICATE_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is an account for users whose primary account is in another domain. This account provides user access to this domain, but not to any domain that trusts this domain. Also known as a local user account.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>NORMAL</em>ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a default account type that represents a typical user.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>INTERDOMAIN</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a permit to trust account for a system domain that trusts other domains.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>WORKSTATION</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a computer account for a computer that is a member of this domain.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>SERVER</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is a computer account for a system backup domain controller that is a member of this domain.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>DONT</em>EXPIRE_PASSWD</td>\n<td>INTEGER</td>\n<td>If 1, the password for this account will never expire.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>MNS</em>LOGON_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this is an MNS logon account.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>SMARTCARD</em>REQUIRED</td>\n<td>INTEGER</td>\n<td>If 1, the user must log on using a smart card.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>TRUSTED</em>FOR_DELEGATION</td>\n<td>INTEGER</td>\n<td>If 1, the service account (user or computer account), under which a service runs, is trusted for Kerberos delegation. Any such service can impersonate a client requesting the service.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>NOT</em>DELEGATED</td>\n<td>INTEGER</td>\n<td>If 1, the security context of the user will not be delegated to a service even if the service account is set as trusted for Kerberos delegation.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>USE</em>DES<em>KEY</em>ONLY</td>\n<td>INTEGER</td>\n<td>If 1, restrict this principal to use only Data Encryption Standard (DES) encryption types for keys.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>DONT</em>REQUIRE_PREAUTH</td>\n<td>INTEGER</td>\n<td>If 1, this account does not require Kerberos pre-authentication for logon.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>PASSWORD</em>EXPIRED</td>\n<td>INTEGER</td>\n<td>If 1, the user password has expired. This flag is created by the system using data from the Pwd-Last-Set attribute and the domain policy.</td>\n</tr>\n<tr>\n<td>u<em>ADS</em>UF<em>TRUSTED</em>TO<em>AUTHENTICATE</em>FOR_DELEGATION</td>\n<td>INTEGER</td>\n<td>If 1, the account is enabled for delegation. This is a security-sensitive setting; accounts with this option enabled should be strictly controlled. This setting enables a service running under the account to assume a client identity and authenticate as that user to other remote servers on the network.</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>DOMAIN_OBJECT</td>\n<td>INTEGER</td>\n<td>See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/ms679637%28v=vs.85%29.aspx\">SAM-Account-Type</a>. If 1, this flag is set.</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>GROUP_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>NON<em>SECURITY</em>GROUP_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>ALIAS_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>NON<em>SECURITY</em>ALIAS_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>USER_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>NORMAL<em>USER</em>ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>MACHINE_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>APP<em>BASIC</em>GROUP</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>APP<em>QUERY</em>GROUP</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>u<em>SAM</em>ACCOUNT<em>TYPE</em>MAX</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n</tbody>\n</table>\n<p><strong>ad_groups</strong></p>\n<p>The table below shows the columns in the ad_groups table. </p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>g_rid</td>\n<td>INTEGER</td>\n<td>The relative identifier which is derived from the objectSid (i.e. the last group of digits).</td>\n</tr>\n<tr>\n<td>g_distinguishedName</td>\n<td>TEXT</td>\n<td>The main 'fully qualified' reference to the object. See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/aa366101%28v=vs.85%29.aspx\">Distinguished Names</a>.</td>\n</tr>\n<tr>\n<td>g_sAMAccountType</td>\n<td>INTEGER</td>\n<td>This attribute contains information about every account type object. As this can only have one value, it would be more efficient to implement a lookup table for this, but I have included individual flags simply for consistency.</td>\n</tr>\n<tr>\n<td>g_sAMAccountName</td>\n<td>TEXT</td>\n<td>The logon name used to support clients and servers running earlier versions of the operating system.</td>\n</tr>\n<tr>\n<td>g_adminCount</td>\n<td>INTEGER</td>\n<td>Indicates that a given object has had its ACLs changed to a more secure value by the system because it was a member of one of the administrative groups (directly or transitively).</td>\n</tr>\n<tr>\n<td>g_description</td>\n<td>TEXT</td>\n<td>Contains the description to display for an object.</td>\n</tr>\n<tr>\n<td>g_comment</td>\n<td>TEXT</td>\n<td>The user's comment. This string can be a null string. Sometimes passwords or sensitive information can be stored here.</td>\n</tr>\n<tr>\n<td>g_whenChanged</td>\n<td>TEXT</td>\n<td>The date when this object was last changed. This value is not replicated and exists in the global catalog.</td>\n</tr>\n<tr>\n<td>g_whenCreated</td>\n<td>TEXT</td>\n<td>The date when this object was created. This value is replicated and is in the global catalog.</td>\n</tr>\n<tr>\n<td>g_managedby</td>\n<td>TEXT</td>\n<td>The manager of this group.</td>\n</tr>\n<tr>\n<td>g_cn</td>\n<td>TEXT</td>\n<td>The common name of the group.</td>\n</tr>\n<tr>\n<td>g_groupType</td>\n<td>INTEGER</td>\n<td>Contains a set of flags that define the type and scope of a group object. These are expanded in the g<em>GT</em>* fields below.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP<em>CREATED</em>BY_SYSTEM</td>\n<td>INTEGER</td>\n<td>If 1, this is a group that is created by the system.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP<em>SCOPE</em>GLOBAL</td>\n<td>INTEGER</td>\n<td>If 1, this is a group with global scope.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP<em>SCOPE</em>LOCAL</td>\n<td>INTEGER</td>\n<td>If 1, this is a group with domain local scope.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP<em>SCOPE</em>UNIVERSAL</td>\n<td>INTEGER</td>\n<td>If 1, this is a group with universal scope.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP<em>SAM</em>APP_BASIC</td>\n<td>INTEGER</td>\n<td>If 1, this specifies an APP_BASIC group for Windows Server Authorisation Manager.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP<em>SAM</em>APP_QUERY</td>\n<td>INTEGER</td>\n<td>If 1, this specifies an APP_QUERY group for Windows Server Authorisation Manager.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP_SECURITY</td>\n<td>INTEGER</td>\n<td>If 1, this specifies a security group.</td>\n</tr>\n<tr>\n<td>g<em>GT</em>GROUP_DISTRIBUTION</td>\n<td>INTEGER</td>\n<td>If 1, this specifies a distribution group (this is the inverse of g<em>GT</em>GROUP_SECURITY). I have included it so that distribution groups can be identified more easily (query readability).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>DOMAIN_OBJECT</td>\n<td>INTEGER</td>\n<td>See <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/ms679637%28v=vs.85%29.aspx\">SAM-Account-Type</a>. If 1, this flag is set.</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>GROUP_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>NON<em>SECURITY</em>GROUP_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>ALIAS_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>NON<em>SECURITY</em>ALIAS_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>USER_OBJECT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>NORMAL<em>USER</em>ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>MACHINE_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>TRUST_ACCOUNT</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>APP<em>BASIC</em>GROUP</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>APP<em>QUERY</em>GROUP</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n<tr>\n<td>g<em>SAM</em>ACCOUNT<em>TYPE</em>MAX</td>\n<td>INTEGER</td>\n<td>If 1, this flag is set (sAMAccountType attribute).</td>\n</tr>\n</tbody>\n</table>\n<p><strong>ad_mapping</strong></p>\n<p>The table below shows the columns in the ad_mapping table. This is used to link users to groups. </p>\n<table>\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n<th>Purpose</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>user_rid</td>\n<td>INTEGER</td>\n<td>The RID of a user</td>\n</tr>\n<tr>\n<td>group_rid</td>\n<td>INTEGER</td>\n<td>The RID of a group</td>\n</tr>\n</tbody>\n</table>\n<p>For example, if a particular record had a user<em>rid of 1000 and a group</em>rid of 1001, this would\nimply that the user whose RID is 1000 is a member of the group whose RID is 1001. Use the\nview_mapping view in order to do any meaningful queries, but its content is derived from this one.</p>\n<p><strong>view_mapping</strong></p>\n<p>This table is a combination of ad<em>groups.* and ad</em>users.<em>. Therefore, the fields are the\ncombination of the u_</em> and the g_* fields shown above.</p>\n<h2 id=\"database-structure\" style=\"position:relative;\"><a href=\"#database-structure\" aria-label=\"database structure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Database Structure</h2>\n<p>There are a few design choices that I have deliberately made which I have given an explanation for\nbelow. This is because the reasons for them may not be obvious.</p>\n<p>The users, groups and computers are based on the same class, so the \"proper\" way to do this would\nbe to place them all into one table and then restrict results based on sAMAccountType to determine\nwhat type of object it is. In addition, the userAccountControl and sAMAccountType and groupType\nattributes have been split out into individual columns which is, from a technical point of view,\nunnecessary duplication.</p>\n<p>The reason for this is ease of use; we are much more intuitively familiar with users, groups and\ncomputers being different objects (even if they are all really the same thing), and it is much\neasier to understand and formulate a query such as:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">SELECT u_sAMAccountName from ad_users where u_ADS_UF_LOCKOUT = 0 and u_SAM_NORMAL_USER_ACCOUNT = 1</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>than:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">SELECT u_sAMAccountName from ad_users where ((u_userAccountControl&amp;0x00000010) = 0) and ((u_sAMAccountType&amp;0x30000000) &gt; 0)</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>This is also true of the sAMAccountType value; this is a code which has a 1:1 mapping with MSDN\nconstants (i.e. they are not flags) and it would be more efficient to implement a simple lookup table.\nHowever, for consistency, I have implemented the columns for the possible values in the same way as\nthe attributes which comprise multiple values in the form of flags.</p>\n<p>This database is designed for quick-and-dirty queries, not to be an efficient AD database, and the\nbenefits of the ease of access significantly outweighs the slight performance impact.</p>\n<h2 id=\"conversion-to-unicode\" style=\"position:relative;\"><a href=\"#conversion-to-unicode\" aria-label=\"conversion to unicode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conversion to Unicode</h2>\n<p>All of the strings injected into the database have been converted to UTF-8 (encode('UTF-8')) which,\nat first glance, does not seem necessary. The reason is documented <a href=\"https://github.com/rails/rails/issues/1965\">here</a>;\nnamely that SQLite stores Unicode strings as 'text' but non-converted strings as 'blobs' regardless\nof the type affinity. Omitting the unicode conversion meant that most of the text queries did not\nwork properly because the database was treating the text fields as raw binary data.</p>\n<h2 id=\"multi-valued-attributes\" style=\"position:relative;\"><a href=\"#multi-valued-attributes\" aria-label=\"multi valued attributes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Multi valued attributes</h2>\n<p>With the exception of the memberOf attribute, it is assumed that other attributes are single\nvalued, which may result in a small about of information being missed. For example, the\ndescription attribute can (in some circumstances) be multi-valued but the ADSI queries will only\nreturn the first value.</p>\n<p>This will not make any practical difference for the vast majority of enterprise domains. </p>\n<h2 id=\"database-queries\" style=\"position:relative;\"><a href=\"#database-queries\" aria-label=\"database queries permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Database Queries</h2>\n<p>Sqlite3 supports a number of output formats (use .mode for all options). These can be used to\neasily present the searched data.</p>\n<p>For example, line mode is useful to see all fields in an easy to view form. The example query\nsearches for all information about the user whose username is 'unprivileged.user'</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sqlite&gt; .mode line\nsqlite&gt; select * from ad_users where u_sAMAccountName = &quot;unprivileged.user&quot;;\n                                          u_rid = 1127\n                            u_distinguishedName = CN=Unprivileged User,CN=Users,DC=goat,DC=stu\n                                  u_description = Do not delete. Default pass set to password123\n                                  u_displayName = Unprivileged User\n                               u_sAMAccountType = 805306368\n                               u_sAMAccountName = unprivileged.user\n                                   u_logonCount = 1\n                           u_userAccountControl = 512\n                               u_primaryGroupID = 513\n                                           u_cn = Unprivileged User\n                                   u_adminCount = 1\n                                  u_badPwdCount = 0\n                            u_userPrincipalName = unprivileged.user@goat.stu\n                                      u_comment = \n                                        u_title = \n                                      u_manager = CN=Stuart Morgan - User,CN=Users,DC=goat,DC=stu\n                                  u_whenCreated = 2015-12-20 20:10:54.000\n                                  u_whenChanged = 2015-12-20 23:12:48.000\n                                u_ADS_UF_SCRIPT = 0\n                        u_ADS_UF_ACCOUNTDISABLE = 0\n                      u_ADS_UF_HOMEDIR_REQUIRED = 0\n                               u_ADS_UF_LOCKOUT = 0\n                        u_ADS_UF_PASSWD_NOTREQD = 0\n                    u_ADS_UF_PASSWD_CANT_CHANGE = 0\n       u_ADS_UF_ENCRYPTED_TEXT_PASSWORD_ALLOWED = 0\n                u_ADS_UF_TEMP_DUPLICATE_ACCOUNT = 0\n                        u_ADS_UF_NORMAL_ACCOUNT = 1\n             u_ADS_UF_INTERDOMAIN_TRUST_ACCOUNT = 0\n             u_ADS_UF_WORKSTATION_TRUST_ACCOUNT = 0\n                  u_ADS_UF_SERVER_TRUST_ACCOUNT = 0\n                    u_ADS_UF_DONT_EXPIRE_PASSWD = 0\n                     u_ADS_UF_MNS_LOGON_ACCOUNT = 0\n                    u_ADS_UF_SMARTCARD_REQUIRED = 0\n                u_ADS_UF_TRUSTED_FOR_DELEGATION = 0\n                         u_ADS_UF_NOT_DELEGATED = 0\n                      u_ADS_UF_USE_DES_KEY_ONLY = 0\n                  u_ADS_UF_DONT_REQUIRE_PREAUTH = 0\n                      u_ADS_UF_PASSWORD_EXPIRED = 0\nu_ADS_UF_TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION = 0\n                            u_SAM_DOMAIN_OBJECT = 0\n                             u_SAM_GROUP_OBJECT = 0\n                u_SAM_NON_SECURITY_GROUP_OBJECT = 0\n                             u_SAM_ALIAS_OBJECT = 0\n                u_SAM_NON_SECURITY_ALIAS_OBJECT = 0\n                      u_SAM_NORMAL_USER_ACCOUNT = 1\n                          u_SAM_MACHINE_ACCOUNT = 0\n                            u_SAM_TRUST_ACCOUNT = 0\n                          u_SAM_APP_BASIC_GROUP = 0\n                          u_SAM_APP_QUERY_GROUP = 0\n                         u_SAM_ACCOUNT_TYPE_MAX = 0</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>SQLite can generate output in HTML format with headers. For example, the query below displays the\nusername, email address and number of times that the user has logged on for all users who have a\nmanager with the word 'Stuart' somewhere in the DN.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sqlite&gt; .mode html\nsqlite&gt; .headers on                                   \nsqlite&gt; select u_sAMAccountName,u_userPrincipalName,u_logonCount from ad_users where u_manager LIKE &#39;%Stuart%&#39;;\n&lt;TR&gt;&lt;TH&gt;u_sAMAccountName&lt;/TH&gt;\n&lt;TH&gt;u_userPrincipalName&lt;/TH&gt;\n&lt;TH&gt;u_logonCount&lt;/TH&gt;\n&lt;/TR&gt;\n&lt;TR&gt;&lt;TD&gt;unprivileged.user&lt;/TD&gt;\n&lt;TD&gt;unprivileged.user@goat.stu&lt;/TD&gt;\n&lt;TD&gt;1&lt;/TD&gt;\n&lt;/TR&gt;\nsqlite&gt; </code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The same query can be used in INSERT mode, in which the results will be displayed as a series of\nSQL insert statements for importing into another database:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sqlite&gt; .mode insert\nsqlite&gt; select u_sAMAccountName,u_userPrincipalName,u_logonCount from ad_users where u_manager LIKE &#39;%Stuart%&#39;;\nINSERT INTO table(u_sAMAccountName,u_userPrincipalName,u_logonCount) VALUES(&#39;unprivileged.user&#39;,&#39;unprivileged.user@goat.stu&#39;,1);</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>The default mode (list) will display the results with a pipe character separating the fields:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">sqlite&gt; .mode list\nsqlite&gt; select u_sAMAccountName,u_userPrincipalName,u_logonCount from ad_users where u_manager LIKE &#39;%Stuart%&#39;;\nu_sAMAccountName u_userPrincipalName u_logonCount\nunprivileged.user unprivileged.user@goat.stu 1</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>There are a number of other ways that this information could be presented; please play with SQLite\nin order to learn how to use them.</p>\n<h2 id=\"example-queries\" style=\"position:relative;\"><a href=\"#example-queries\" aria-label=\"example queries permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example Queries</h2>\n<p>A number of example queries are shown below, in order to give an idea of how easy it is to build up\ncomplex queries.</p>\n<p>Search for all users who have a title, description or comment and display this information along\nwith their username:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select u_sAMAccountName,u_title,u_description,u_comment from ad_users where (u_title != &quot;&quot; or u_description != &quot;&quot; or u_comment != &quot;&quot;);</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Display all stored fields for all users whose accounts are not disabled, have a password that does\nnot expire, have a name starting with 'Frank' and have logged on more than once.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select * from ad_users where u_ADS_UF_ACCOUNTDISABLE=0 and u_ADS_UF_DONT_EXPIRE_PASSWD=1 and u_cn LIKE &#39;Frank%&#39; and u_logonCount&gt;1;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Get the list of group RIDs that have a name which do not have the word 'admin' in them somewhere\n(perhaps useful to construct a golden ticket with access to pretty much all groups except anything\nwith 'admin' in it), might be useful to evade a very basic form of monitoring perhaps?</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select DISTINCT g_rid from ad_groups where g_sAMAccountName NOT LIKE &#39;%admin%&#39;;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Search for all users who are members of the 'Domain Admins' group and display their username.\nNote that this will include those in nested groups.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select u_sAMAccountName from view_mapping where g_sAMAccountName = &#39;Domain Admins&#39;;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Show the groups that the user 'stufus' is a member of and write the output to /tmp/groups.txt\n(e.g. for usage in a different tool):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">.once /tmp/groups.txt\nselect g_sAMAccountName from view_mapping where u_sAMAccountName = &#39;stufus&#39;;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Imagine you have compromised passwords or accounts for user1, user2, user3 and user4. Show the AD\ngroups which, between them all, you have access to.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select DISTINCT g_sAMAccountName from view_mapping where u_sAMAccountName IN (&#39;user1&#39;,&#39;user2&#39;,&#39;user3&#39;,&#39;user4&#39;);</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Retrieve the list of group names common to both 'user1' and 'user2' and display the group RID,\ngroup name and group description. This could be useful if you were aware that both these users\nare in a group that has access to a very specific resource but are in a large number of separate\nother groups.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select v1.g_rid,v1.g_sAMAccountName,v1.g_description FROM view_mapping v1 INNER JOIN view_mapping v2 ON v1.g_rid = v2.g_rid where v1.u_sAMAccountName = &#39;user1&#39; and v2.u_sAMAccountName = &#39;user2&#39;;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Show the name, DNS hostname and OS information for each of the computers in the domain:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select c_cn,c_dNSHostName,c_operatingSystem,c_operatingSystemVersion,c_operatingSystemServicePack from ad_computers;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Display the same columns as above but only show machines in the 'Domain Controllers' OU (you can't\nnormally search by DN because it isn't a \"real\" attribute when querying through LDAP, but as it is\na normal text field in the database, you can use regular expressions and normal string matching):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select c_cn,c_dNSHostName,c_operatingSystem,c_operatingSystemVersion,c_operatingSystemServicePack from ad_computers where c_distinguishedName LIKE &#39;%OU=Domain Controllers%&#39;;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Show all fields for computers that have the c<em>ADS</em>UF<em>WORKSTATION</em>TRUST_ACCOUNT set to 1 (which\nseems to be everything except domain controllers) on my test system:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select * from ad_computers where c_ADS_UF_WORKSTATION_TRUST_ACCOUNT = 1;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Show all fields for computers whose operating system is Windows XP, Windows 2000 or Windows 2003\n(note that you need regular expression support in SQLite):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select * from ad_computers where c_operatingSystem REGEXP &#39;(XP|200[03])&#39;;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>...and if you don't have regular expression support:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select * from ad_computers where c_operatingSystem LIKE &#39;%XP%&#39; OR c_operatingSystem LIKE &#39;%2000%&#39; OR c_operatingSystem LIKE &#39;%2003%&#39;;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Search for all members of all groups who are (amongst other things) members of any group managed\nby anyone whose CN starts with 'Unprivileged User' and return their username only:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">select DISTINCT u_sAMAccountName from view_mapping where g_rid IN (select g_rid from view_mapping where g_managedBy LIKE &#39;CN=Unprivileged User%&#39;);</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2 id=\"scenarios\" style=\"position:relative;\"><a href=\"#scenarios\" aria-label=\"scenarios permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scenarios</h2>\n<p><strong>Group Policy Objects</strong></p>\n<p>This cannot be used to gain a complete understanding of effective permissions because it does not\nanalyze group policy objects. For example, a group policy may add inconspicuous groups to\nprivileged groups and privileged groups, such as Domain Admins, may be removed from local\nadministrator groups due to GPP. Therefore, this will give a reliable overview of the effective\n'static' permissions but cannot be completely relied on for overall effective permissions.</p>\n<p><strong>Domain Controller interaction</strong></p>\n<p>The acquisition of domain information does involve repeated queries against the domain controllers.\nHowever, all interaction with AD uses native functionality and has not been noted to cause\nperformance problems when tested. This was recently tested on a live engagement on a domain that\nhas just under 11,000 groups and a similar number of users. Admittedly it took about an hour to\npull down everything (as opposed to the 1 minute to replicate the LDAP database) but the final\ndatabase size was 19,255,296 bytes, so perfectly manageable.</p>"}}},"pageContext":{"id":"e8b4bd92-fc71-504e-8c32-d3eb3b37aa6b"}}}