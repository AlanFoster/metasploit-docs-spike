{"componentChunkName":"component---src-templates-wiki-template-tsx","path":"/wiki/Misc/Work-needed-to-allow-msfdb-to-use-postgresql-common","result":{"data":{"markdownRemark":{"id":"8821acfa-325a-509d-b56a-22d111682a5d","frontmatter":{"title":"Work needed to allow msfdb to use postgresql common","root":null},"html":"<h1 id=\"work-needed-to-allow-msfdb-to-use-postgresql-common\" style=\"position:relative;\"><a href=\"#work-needed-to-allow-msfdb-to-use-postgresql-common\" aria-label=\"work needed to allow msfdb to use postgresql common permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Work needed to allow msfdb to use postgresql-common</h1>\n<p>Linux distributions, such as Debian and Kali Linux, use <a href=\"https://salsa.debian.org/postgresql/postgresql-common\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">postgresql-common (Multi-Version/Multi-Cluster PostgreSQL architecture)</a> wrappers to interact with one or more PostgreSQL installations. Therefore, commands such as <code class=\"language-text\">initdb</code> and <code class=\"language-text\">pg_ctl</code> are not in the user's <code class=\"language-text\">PATH</code>. <code class=\"language-text\">msfdb</code> currently assumes these programs are available in the <code class=\"language-text\">PATH</code>. In order to support platforms that use the <code class=\"language-text\">postgresql-common</code> wrappers, <code class=\"language-text\">msfdb</code> would need to determine if it is running on such a platform and modify the commands used to perform the various setup and configuration operations. See the section \"msfdb support for postgresql-common\" for additional details.</p>\n<h2 id=\"msfdb-support-for-postgresql-common\" style=\"position:relative;\"><a href=\"#msfdb-support-for-postgresql-common\" aria-label=\"msfdb support for postgresql common permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">msfdb</code> support for postgresql-common</h2>\n<h3 id=\"requirements\" style=\"position:relative;\"><a href=\"#requirements\" aria-label=\"requirements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Requirements</h3>\n<ul>\n<li>Determine if the system is using <code class=\"language-text\">postgresql-common</code>.</li>\n<li>Ideally, allow a user without elevated privileges to setup a database for use with Metasploit.</li>\n<li>Determine the current version of PostgreSQL on the system when multiple versions might be installed in parallel.</li>\n<li>\n<p>The port number used for the server when <code class=\"language-text\">pg_createcluster</code> is run without a port number option defaults to the \"next free port starting from 5432\". If we don't specify the port number when calling <code class=\"language-text\">pg_createcluster</code> we can scrape the port number from the <code class=\"language-text\">pg_lsclusters</code> output.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters --no-header | awk &#39;/^9.6/ { if ($2 == &quot;msf&quot;) { print $3; } }&#39;\n5433</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n</li>\n</ul>\n<h3 id=\"notes\" style=\"position:relative;\"><a href=\"#notes\" aria-label=\"notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Notes</h3>\n<p>Debian's <a href=\"https://salsa.debian.org/postgresql/postgresql-common\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">postgresql-common (Multi-Version/Multi-Cluster PostgreSQL architecture)</a> contains PostgreSQL wrapper tools:</p>\n<ul>\n<li><code class=\"language-text\">pg_lsclusters</code>: list all available clusters with their status and configuration</li>\n<li>\n<p><code class=\"language-text\">pg_createcluster</code>: wrapper for <code class=\"language-text\">initdb</code>, sets up the necessary configuration structure</p>\n<ul>\n<li><code class=\"language-text\">pg_createcluster [options] version name [-- initdb options]</code></li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">pg_ctlcluster</code>: wrapper for <code class=\"language-text\">pg_ctl</code>, control the cluster postgres server</p>\n<ul>\n<li>pg<em>ctlcluster [options] cluster-version cluster-name action -- [pg</em>ctl options]</li>\n<li>where action = start|stop|restart|reload|promote</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">pg_dropcluster</code>: remove a cluster and its configuration</p>\n<ul>\n<li>pg_dropcluster [--stop] cluster-version cluster-name</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">pg_wrapper</code>: wrapper for PostgreSQL client commands</p>\n<ul>\n<li>client-program [--cluster version/cluster] [...]</li>\n<li>( client-program: psql, createdb, dropuser, and all other client programs installed in /usr/lib/postgresql/ version/bin).</li>\n</ul>\n</li>\n</ul>\n<p>The \"database cluster\" simply refers to a set of databases on a single server rather than a group of multiple database servers.</p>\n<h3 id=\"manually-create-and-initialize-msf-database-using-postgresql-common\" style=\"position:relative;\"><a href=\"#manually-create-and-initialize-msf-database-using-postgresql-common\" aria-label=\"manually create and initialize msf database using postgresql common permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Manually create and initialize MSF database using postgresql-common</h3>\n<h4 id=\"issues\" style=\"position:relative;\"><a href=\"#issues\" aria-label=\"issues permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issues</h4>\n<p>Encountered permissions issues when attempting to create a cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">pg_createcluster --user=$(whoami) --encoding=UTF8 9.6 msf -- --username=$(whoami) --auth-host=trust --auth-local=trust\ninstall: cannot change permissions of ‘/etc/postgresql/9.6/msf’: No such file or directory\nError: could not create configuration directory; you might need to run this program with root privileges</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Requiring root privileges may be prohibitive to user installs of MSF. How can we create a cluster without root privileges? Adding the user to the postgres group and attempting to <code class=\"language-text\">sudo -u postgres</code> the command, however, resulted in the same error message. Looking closer at the various commands and discovered the following in the man page for <code class=\"language-text\">pg_wrapper</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT\n    This specifies an alternative base directory for cluster configurations. This is usually\n    /etc/postgresql/, but for testing/development purposes you can change this to point to e. g. your\n    home directory, so that you can use the postgresql-common tools without root privileges.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<h4 id=\"working-solution\" style=\"position:relative;\"><a href=\"#working-solution\" aria-label=\"working solution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Working Solution</h4>\n<ul>\n<li>Create cluster (\"initdb\") to set up the necessary configuration structure:</li>\n</ul>\n<p>Note, running <code class=\"language-text\">mkdir -p $HOME/.local/etc/postgresql;</code> before the <code class=\"language-text\">pg_createcluster</code> command didn't stop the \"install: cannot change owner and permissions of ‘/home/msfdev/.local/etc/postgresql/9.6’: Operation not permitted\" message from appearing. This appears to be a warning only and doesn't seem to affect cluster creation.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">mkdir -p $HOME/.local/var/log/postgresql; PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_createcluster --user=$(whoami) --datadir=$HOME/msf-db-datadir --socketdir=$HOME/.local/var/run/postgresql --logfile=$HOME/.local/var/log/postgresql/postgresql-version-msf.log --encoding=UTF8 9.6 msf -- --username=$(whoami) --auth-host=trust --auth-local=trust\ninstall: cannot change owner and permissions of ‘/home/msfdev/.local/etc/postgresql/9.6’: Operation not permitted\nCreating new cluster 9.6/msf ...\nconfig /home/msfdev/.local/etc/postgresql/9.6/msf\ndata /home/msfdev/msf-db-datadir\nlocale en_US.UTF-8\nsocket /home/msfdev/.local/var/run/postgresql\nport 5433</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Check cluster was successfully created and appears in the list of all available clusters:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters\nVer Cluster Port Status Owner Data directory Log file\n9.6 msf 5433 down msfdev /home/msfdev/msf-db-datadir /home/msfdev/.local/var/log/postgresql/postgresql-version-msf.log</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Start postmaster server for the cluster (\"pg_ctl\"):</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_ctlcluster 9.6 msf start</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<ul>\n<li>Check that the cluster was successfully started:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters\nVer Cluster Port Status Owner Data directory Log file\n9.6 msf 5433 online msfdev /home/msfdev/msf-db-datadir /home/msfdev/.local/var/log/postgresql/postgresql-version-msf.log</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Perform <code class=\"language-text\">msfdb</code>'s <code class=\"language-text\">write_db_config</code> method work by manually creating the <code class=\"language-text\">~/.msf4/database.yml</code> file.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">development: &amp;pgsql\n  adapter: postgresql\n  database: msf\n  username: msf\n  password: Password123\n  host: 127.0.0.1\n  port: 5433\n  pool: 200\n\nproduction: &amp;production\n  &lt;&lt;: *pgsql\n\ntest:\n  &lt;&lt;: *pgsql\n  database: msftest\n  username: msftest\n  password: Password123</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Create database users:</li>\n</ul>\n<p>Note, these steps are from <code class=\"language-text\">msfdb</code>'s <code class=\"language-text\">init_db</code> method. The following example only creates the main MSF user account and not the test account.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql psql --cluster 9.6/msf -c &quot;create user msf with password &#39;Password123&#39;;&quot; postgres\nCREATE ROLE\nPG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql psql --cluster 9.6/msf -c &quot;alter role msf createdb;&quot; postgres\nALTER ROLE\nPG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql psql --cluster 9.6/msf -c &quot;alter role msf with password &#39;Password123&#39;;&quot; postgres\nALTER ROLE\nPG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql createdb --cluster 9.6/msf -O msf -h 127.0.0.1 -U msf -E UTF-8 -T template0 msf</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Perform <code class=\"language-text\">msfdb</code>'s <code class=\"language-text\">write_db_client_auth_config</code> method work, except it needs to write the <code class=\"language-text\">pg_hba.conf</code> file now stored in under <code class=\"language-text\">PG_CLUSTER_CONF_ROOT</code> and inside the <code class=\"language-text\">version/cluster-name</code> directory. In this example that location is: <code class=\"language-text\">$HOME/.local/etc/postgresql/9.6/msf/pg_hba.conf</code>.</li>\n<li>Perform <code class=\"language-text\">msfdb</code>'s <code class=\"language-text\">restart_db</code> method work, by stopping and then starting the server. Stop and then start postmaster server for the cluster (\"pg_ctl\"):</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_ctlcluster 9.6 msf stop\nPG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_ctlcluster 9.6 msf start</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<ul>\n<li>Check that the cluster was successfully started:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters\nVer Cluster Port Status Owner Data directory Log file\n9.6 msf 5433 online msfdev /home/msfdev/msf-db-datadir /home/msfdev/.local/var/log/postgresql/postgresql-version-msf.log</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Create initial database schema:</li>\n</ul>\n<p>Note, these steps are from <code class=\"language-text\">msfdb</code>'s <code class=\"language-text\">init_db</code> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">cd ~/metasploit-framework\nbundle exec rake db:migrate</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<ul>\n<li>Start <code class=\"language-text\">msfconsole</code> and verify postgresql connection using the <code class=\"language-text\">db_status</code> command:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\"># disable or remove ~/.msf4/config if it is configured to auto connect to a data service\nmv ~/.msf4/config ~/.msf4/config.disable\n./msfconsole\n...\nmsf5 &gt; db_status \n[*] Connected to msf. Connection type: postgresql.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Drop (delete) the cluster:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_dropcluster 9.6 msf</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>"}},"pageContext":{"id":"8821acfa-325a-509d-b56a-22d111682a5d"}}}