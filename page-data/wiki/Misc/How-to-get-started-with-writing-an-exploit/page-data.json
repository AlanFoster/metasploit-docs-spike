{"componentChunkName":"component---src-templates-wiki-template-tsx","path":"/wiki/Misc/How-to-get-started-with-writing-an-exploit","result":{"data":{"markdownRemark":{"id":"1d447bbb-cb24-54c9-bd52-e7e87e6c4efc","frontmatter":{"title":"How to get started with writing an exploit","root":null},"html":"<p>The real kung-fu behind exploit development isn't actually about which language you choose to build it, it's about your precise understanding of how an input is processed by the application you're debugging, and how to gain control by manipulating it. That's right, the keyword is \"debugging.\" Your binjitsu (reverse-engineering) is where the real kung-fu is. However, if your goal isn't just about popping a calculator, but actually want to weaponize, to maintain, and to provide use in the practical world, you need a development framework. And this is where Metasploit comes in. It's a framework that's free and open-source, actively contributed by researchers around the world. So when you write a Metasploit exploit, you don't have to worry about any <a href=\"http://en.wikipedia.org/wiki/Dependency_hell\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dependency issues</a>, or having the wrong version, or not having enough payloads for different pentesting scenarios to choose from, etc. The idea is all you need to do is focus on building that exploit, and nothing more.</p>\n<h3 id=\"plan-your-module\" style=\"position:relative;\"><a href=\"#plan-your-module\" aria-label=\"plan your module permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Plan your module</h3>\n<p>Unlike writing a proof-of-concept, when you write a Metasploit module you need to think about how users might use it in the real world. Stealth is usually an important element to think about. Can your exploit achieve code execution without dropping a file? Can the input look more random so it's more difficult to detect? How about obfuscation? Is it generating unnecessary traffic? Can it be more stable without crashing the system so much, etc, etc.</p>\n<p>Also, try to be precise about exploitable requirements. Usually, a bug is specific to a range of versions, or even builds. If you can't automatically check that, you need to at least mention it in the description somewhere. Some of your exploit's techniques might also be application-specific. For example, you can take advantage of a specific behavior in the application to generate heap allocations the way you want, but maybe it's more noisy in the newer version so that gives you some stability issues. Does it need a 3rd-party component to work that may not even be installed by everyone? Even if it is, is the component revised often that could make your exploit less reliable?</p>\n<p>Know that in the real world, your exploit can break or fail in a lot of different ways. You should try to find out and fix it during the development and testing phase before learning the hard way.</p>\n<h3 id=\"ranking\" style=\"position:relative;\"><a href=\"#ranking\" aria-label=\"ranking permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ranking</h3>\n<p>As you can see, reliability is important to Metasploit, and we try to be more friendly about this for the users. I know what you're thinking: \"Well, if they're using the exploit they should understand how it works, so they know what they're getting themselves into.\" In the perfect world, yes. Knowing how a vulnerability works or how an exploit works will only benefit the user, but you see, we don't live in the perfect world. If you're in the middle of a penetration test, it's very unlikely to always find the time to recreate the vulnerable environment, strip the exploit to the most basic form to debug what's going on, and then do testing. Chances are you have a tight schedule to break into a large network, so you need to use your time carefully. Because of this, it's important to at least have a good description and good references for the module. And of course, a ranking system that can be trusted.</p>\n<p>The Metasploit Framework has seven different rankings to indicate how reliable an exploit is. See [[Exploit Ranking]] for more details.</p>\n<h3 id=\"template\" style=\"position:relative;\"><a href=\"#template\" aria-label=\"template permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Template</h3>\n<p>If you have read this far, we think you are pretty impressive because it's a lot to digest. You are probably wondering why we haven't had a single line of code to share in the write-up. Well, as you recall, exploit development is mostly about your reversing skills. If you have all that, we shouldn't be telling you how to write an exploit. What we've done so far is hopefully get your mindset dialed-in correctly about what it means to become a Metasploit exploit developer for the security community, the rest is more about how to use our mixins to build that exploit. Well, there are A LOT of mixins so it's impossible to go over all of them in a single page, so you must either read the <a href=\"https://dev.metasploit.com/api/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API documentation</a>, existing <a href=\"https://github.com/rapid7/metasploit-framework/tree/master/modules/exploits\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">code examples</a>, or look for more wiki pages we've written to cover specific mixins.</p>\n<p>For example, if you're looking for a writeup about how to interact with an HTTP server, you might be interested in: <a href=\"https://github.com/rapid7/metasploit-framework/wiki/How-to-Send-an-HTTP-Request-Using-HTTPClient\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to send an HTTP Request Using HTTPClient</a>. If you're interested in browser exploit writing, definitely check out: <a href=\"https://github.com/rapid7/metasploit-framework/wiki/How-to-write-a-browser-exploit-using-BrowserExploitServer\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to write a browser exploit using BrowserExploitServer</a>, etc.</p>\n<p>But of course, to begin you most likely need a template to work with, and here it is. We'll also explain how to fill out the required fields:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token comment\">##</span>\n<span class=\"token comment\"># This module requires Metasploit: http://metasploit.com/download</span>\n<span class=\"token comment\"># Current source: https://github.com/rapid7/metasploit-framework</span>\n<span class=\"token comment\">##</span>\n\n<span class=\"token keyword\">require</span> <span class=\"token string\">'msf/core'</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MetasploitModule</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">Msf</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Exploit</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Remote</span>\n  <span class=\"token constant\">Rank</span> <span class=\"token operator\">=</span> <span class=\"token constant\">NormalRanking</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">initialize</span></span><span class=\"token punctuation\">(</span>info<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>update_info<span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'Name'</span>           <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"[Vendor] [Software] [Root Cause] [Vulnerability type]\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'Description'</span>    <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">%q{\n        Say something that the user might need to know\n      }</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'License'</span>        <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token constant\">MSF_LICENSE</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'Author'</span>         <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span> <span class=\"token string\">'Name'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'References'</span>     <span class=\"token operator\">=</span><span class=\"token operator\">></span>\n        <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">[</span> <span class=\"token string\">'URL'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span> <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'Platform'</span>       <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">'win'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'Targets'</span>        <span class=\"token operator\">=</span><span class=\"token operator\">></span>\n        <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">[</span> <span class=\"token string\">'System or software version'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n              <span class=\"token string\">'Ret'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">0x41414141</span> <span class=\"token comment\"># This will be available in `target.ret`</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'Payload'</span>        <span class=\"token operator\">=</span><span class=\"token operator\">></span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token string\">'BadChars'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"\\x00\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'Privileged'</span>     <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'DisclosureDate'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'DefaultTarget'</span>  <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">check</span></span>\n    <span class=\"token comment\"># For the check command</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">exploit</span></span>\n    <span class=\"token comment\"># Main function</span>\n  <span class=\"token keyword\">end</span>\n\n<span class=\"token keyword\">end</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The <strong>Name</strong> field should begin with the name of the vendor, followed by the software. Ideally the \"Root Cause\" field means which component or function the bug is found. And finally, the type of vulnerability the module is exploiting.</p>\n<p>The <strong>Description</strong> field should explain what the module does, things to watch out for, specific requirements, the more the better. The goal is to let the user understand what he's using without the need to actually read the module's source and figure things out. And trust me, most of them don't.</p>\n<p>The <strong>Author</strong> field is where you put your name. The format should be \"Name \". If you want to have your Twitter handle there, leave it as a comment, for example: \"Name # handle\"</p>\n<p>The <strong>References</strong> field is an array of <a href=\"https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/module/reference.rb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">references</a> related to the vulnerability or the exploit. For example: an advisory, a blog post, etc. Make sure you use known reference identifiers -- see [[Metasploit module reference identifiers]] for a list.</p>\n<p>The <strong>Platform</strong> field indicates what platforms are supported, for example: win, linux, osx, unix, bsd.</p>\n<p>The <strong>Targets</strong> field is an array of systems, applications, setups, or specific versions your exploit is targeting. The second element or each target array is where you store specific metadata about that target, for example: a specific offset, a gadget, a ret address, etc. When a target is selected by the user, the metadata is loaded and tracked by a \"target index\", and can be retrieved by using the <code class=\"language-text\">target</code> method.</p>\n<p>The <strong>Payloads</strong> field specifies how the payload should be encoded and generated. You can specify: <code class=\"language-text\">Space</code>, <code class=\"language-text\">SaveRegisters</code>, <code class=\"language-text\">Prepend</code>, <code class=\"language-text\">PrependEncoder</code>, <code class=\"language-text\">BadChars</code>, <code class=\"language-text\">Append</code>, <code class=\"language-text\">AppendEncoder</code>, <code class=\"language-text\">MaxNops</code>, <code class=\"language-text\">MinNops</code>, <code class=\"language-text\">Encoder</code>, <code class=\"language-text\">Nop</code>, <code class=\"language-text\">EncoderType</code>, <code class=\"language-text\">EncoderOptions</code>, <code class=\"language-text\">ExtendedOptions</code>, <code class=\"language-text\">EncoderDontFallThrough</code>.</p>\n<p>The <strong>DisclosureDate</strong> is about when the vulnerability was disclosed in public, in the format of: \"M D Y\". For example: \"Apr 04 2014\"</p>\n<p>Your exploit should also have a <code class=\"language-text\">check</code> method to support the check command, but this is optional in case it's not possible.</p>\n<p>And finally, the <code class=\"language-text\">exploit</code> method is like your main method. Start writing your code there.</p>\n<p>An example exploit module is also available: <a href=\"https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/example.rb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">example.rb</a></p>\n<h3 id=\"basic-git-commands\" style=\"position:relative;\"><a href=\"#basic-git-commands\" aria-label=\"basic git commands permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Basic git commands</h3>\n<p>Metasploit no longer uses svn for source code management, instead we use git, so knowing some tricks with git go a long way. We're not here to lecture you about how awesome git is, we know it has a learning curve and it's not surprising to find new users making mistakes. Every once a while, your git \"rage\" will kick in, and we understand. However, it's important for you to take advantage of branching.</p>\n<p>Every time you make a module, or make some changes to existing code, you should not do so on the default master branch. Why? Because when you do a <code class=\"language-text\">msfupdate</code>, which is Metasploit's utility for updating your repository, it will do a git reset before merging the changes, and all your code go bye-bye.</p>\n<p>Another mistake people tend to do is have all the changes on master before submitting a pull request. This is a bad idea, because most likely you're submitting other crap you don't intend to change, and/or you're probably asking us to merge other unnecessary commit history when there only needs to be one commit. Thanks for contributing your module to the community, but no thanks to your crazy commit history.</p>\n<p>So as a habit, when you want to make something new, or change something, begin with a new branch that's up to date to master. First off, make sure you're on master. If you do a <code class=\"language-text\">git status</code> it will tell you what branch you're currently on:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ git status\n# On branch upstream-master\nnothing to commit, working directory clean</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Ok, now do a <code class=\"language-text\">git pull</code> to download the latest changes from Metasploit:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ git pull\nAlready up-to-date.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>At this point, you're ready to start a new branch. In this case, we'll name our new branch \"my<em>awesome</em>branch\":</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ git checkout -b my_awesome_branch\nSwitched to a new branch &#39;my_awesome_branch&#39;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>And then you can go ahead and add that module. Make sure it's in the appropriate path:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ git add [module path]</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>When you decide to save the changes, commit (if there's only one module, you can do <code class=\"language-text\">git commit -a</code> too so you don't have to type the module path. Note <code class=\"language-text\">-a</code> really means EVERYTHING):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ git commit [module path]</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>When you're done, push your changes, which will upload your code to your remote branch \"my<em>awesome</em>branch\". You must push your changes in order to submit the pull request, or share it with others on the Internet.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ git push origin my_awesome_branch</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h3 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h3>\n<p><a href=\"https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit.rb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit.rb</a></p>"}},"pageContext":{"id":"1d447bbb-cb24-54c9-bd52-e7e87e6c4efc"}}}