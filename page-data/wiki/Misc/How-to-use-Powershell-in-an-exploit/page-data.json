{"componentChunkName":"component---src-templates-wiki-template-tsx","path":"/wiki/Misc/How-to-use-Powershell-in-an-exploit","result":{"data":{"markdownRemark":{"id":"25712275-0821-54ca-b6e0-f48ae877057f","frontmatter":{"title":"How to use Powershell in an exploit","root":null},"html":"<p>PowerShell is a scripting language developed by Microsoft. It provides API access to almost everything in a Windows platform, less detectable by countermeasures, easy to learn, therefore it is incredibly powerful for penetration testing during post exploitation, or exploit development for payload execution. Take Metasploit's <a href=\"https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/smb/psexec_psh.rb\">windows/smb/psexec_psh.rb</a> module for example: it mimics the psexec utility from SysInternals, the payload is compressed and executed from the command line, which allows it to be somewhat stealthy against antivirus. There's only less than 30 lines of code in psexec_psh.rb (excluding the metadata that describes what the module is about), because most of the work is done by the Powershell mixin, nothing is easier than that.</p>\n<p>The command line will automatically attempt to detect the architecture (x86 or x86_64) that it is being run in, as well as the payload architecture that it contains. If there is a mismatch it will spawn the correct PowerShell architecture to inject the payload into, so there is no need to worry about the architecture of the target system. </p>\n<h3 id=\"requirements\" style=\"position:relative;\"><a href=\"#requirements\" aria-label=\"requirements permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Requirements</h3>\n<p>To use the PowerShell mixin, make sure you meet these requirements:</p>\n<ul>\n<li>The target machine supports PowerShell. Vista or newer should support it.</li>\n<li>You must have permission to execute powershell.exe</li>\n<li>You must be able to supply system command arguments.</li>\n<li>You must set up a command execution type attack in order to execute powershell.exe</li>\n</ul>\n<h3 id=\"usage\" style=\"position:relative;\"><a href=\"#usage\" aria-label=\"usage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Usage</h3>\n<ul>\n<li>To add PowerShell to your module, first you need to require it:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string\">'msf/core/exploit/powershell'</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<ul>\n<li>And then include the mixin within the scope of the <code class=\"language-text\">Metasploit3</code> class (or maybe <code class=\"language-text\">Metasploit4</code> for some)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token keyword\">include</span> <span class=\"token constant\">Msf</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Exploit</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Powershell</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<ul>\n<li>Use the <code class=\"language-text\">cmd_psh_payload</code> method to generate the PowerShell payload.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">cmd_psh_payload<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">.</span>encoded<span class=\"token punctuation\">,</span> payload_instance<span class=\"token punctuation\">.</span>arch<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>The actual output of <code class=\"language-text\">cmd_psh_payload</code> is a system command, which would look like the following format (as a one-liner):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">%COMSPEC% /B /C start powershell.exe -Command $si = New-Object\nSystem.Diagnostics.ProcessStartInfo;$si.FileName = &#39;powershell.exe&#39;;\n$si.Arguments = &#39; -EncodedCommand [BASE64 PAYLOAD] &#39;;\n$si.UseShellExecute = $false;\n$si.RedirectStandardOutput = $true;$si.WindowStyle = &#39;Hidden&#39;;\n$si.CreateNoWindow = $True;\n$p = [System.Diagnostics.Process]::Start($si);</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>A number of options can be used to adjust the final command depending on the circumstances of the exploit. By default the script is compressed but no encoding takes places of the wrapper. This produces a small command of around ~2000 characters (depending on the payload). </p>\n<p>Of these <code class=\"language-text\">encode_final_payload</code> is the most noteworthy as it will Base64 encode the full payload giving a very simple command with very few bad characters. However, the command length will increase as a result. Combining this with <code class=\"language-text\">remove_comspec</code> means the payload would very simply be:</p>\n<p><code class=\"language-text\">powershell.exe -nop -ep bypass -e AAAABBBBCCCCDDDD.....==</code></p>\n<p>Check out the other advanced options in the API documentation below.</p>\n<h3 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h3>\n<p><a href=\"https://dev.metasploit.com/api/Msf/Exploit/Powershell.html\">https://dev.metasploit.com/api/Msf/Exploit/Powershell.html</a></p>\n<p><a href=\"https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/powershell.rb\">https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/powershell.rb</a></p>\n<p><a href=\"https://github.com/rapid7/metasploit-framework/blob/master/data/exploits/powershell/powerdump.ps1\">https://github.com/rapid7/metasploit-framework/blob/master/data/exploits/powershell/powerdump.ps1</a></p>"}},"pageContext":{"id":"25712275-0821-54ca-b6e0-f48ae877057f"}}}