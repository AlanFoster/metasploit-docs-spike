{"componentChunkName":"component---src-templates-wiki-template-tsx","path":"/wiki/Misc/How-to-use-the-Msf-Exploit-Remote-Tcp-mixin","result":{"data":{"markdownRemark":{"id":"4c1af304-a941-5024-8f88-bc165a9d2e90","frontmatter":{"title":"How to use the Msf Exploit Remote Tcp mixin","root":null},"html":"<h1 id=\"how-to-use-the-msfexploitremotetcp-mixin\" style=\"position:relative;\"><a href=\"#how-to-use-the-msfexploitremotetcp-mixin\" aria-label=\"how to use the msfexploitremotetcp mixin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to use the Msf::Exploit::Remote::Tcp mixin</h1>\n<p>In Metasploit Framework, TCP sockets are implemented as Rex::Socket::Tcp, which extends the built-in Ruby Socket base class. You should always use the Rex socket instead of the native Ruby one because if not, your sockets are not manageable by the framework itself, and of course some features will be missing such as pivoting. The <a href=\"https://github.com/rapid7/metasploit-framework/blob/master/documentation/developers_guide.pdf\">Developer's Guide</a> in Metasploit's documentation directory explains how this works pretty well.</p>\n<p>For module development, normally you wouldn't be using Rex directly, so instead you'd be using the Msf::Exploit::Remote::Tcp mixin. The mixin already provides some useful features you don't really have to worry about during development, such as TCP evasions, proxies, SSL, etc. All you have to do is make that connection, send something, receive something, and you're done.</p>\n<p>Sounds pretty easy, right?</p>\n<h2 id=\"using-the-mixin\" style=\"position:relative;\"><a href=\"#using-the-mixin\" aria-label=\"using the mixin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using the mixin</h2>\n<p>To use the mixin, simply add the following statement within your module's <code class=\"language-text\">class Metasploit3</code> (or <code class=\"language-text\">class Metasploit4</code>) scope:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token keyword\">include</span> <span class=\"token constant\">Msf</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Exploit</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Remote</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Tcp</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>When the mixin is included, notice there will be the following datastore options registered under your module:</p>\n<ul>\n<li><strong>SSL</strong> - Negotiate SSL for outgoing connections.</li>\n<li><strong>SSLVersion</strong> - The SSL version used: SSL2, SSL3, TLS1. Default is TLS1.</li>\n<li><strong>SSLVerifyMode</strong> - Verification mode: CLIENT<em>ONCE, FAIL</em>IF<em>NO</em>PEER_CERT, NONE, PEER. Default is PEER.</li>\n<li><strong>Proxies</strong> - Allows your module to support proxies.</li>\n<li><strong>ConnectTimeout</strong> - Default is 10 seconds.</li>\n<li><strong>TCP::max<em>send</em>size</strong> - Evasive option. Maxiumum TCP segment size.</li>\n<li><strong>TCP::send_delay</strong> - Evasive option. Delays inserted before every send.</li>\n</ul>\n<p>If you wish to learn how to change the default value of a datastore option, please read \"<a href=\"https://github.com/rapid7/metasploit-framework/wiki/How-to-use-datastore-options#changing-the-default-value-for-a-datastore-option\">Changing the default value for a datastore option</a>\"</p>\n<h2 id=\"make-a-connection\" style=\"position:relative;\"><a href=\"#make-a-connection\" aria-label=\"make a connection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Make a connection</h2>\n<p>To make a connection, simply do the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">connect</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>When you do this, what happens is that the <code class=\"language-text\">connect</code> method will call <code class=\"language-text\">Rex::Socket::Tcp.create</code> to create the socket, and register it to framework. It automatically checks with the RHOST/RPORT datastore options (so it knows where to connect to), but you can also manually change this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token comment\"># This connects to metasploit.com</span>\nconnect<span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'RHOST'</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token string\">'208.118.237.137'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'RPORT'</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">80</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>The <code class=\"language-text\">connect</code> method will then return the Socket object, which is also accessible globally.</p>\n<p>But you see, there's a little more to it. The <code class=\"language-text\">connect</code> method can also raise some Rex exceptions that you might want to catch, including:</p>\n<ul>\n<li><strong>Rex::AddressInUse</strong> - Possible when it actually binds to the same IP/port.</li>\n<li><strong>::Errno::ETIMEDOUT</strong> - When Timeout.timeout() waits to long to connect.</li>\n<li><strong>Rex::HostUnreachable</strong> - Pretty self-explanatory.</li>\n<li><strong>Rex::ConnectionTimeout</strong> - Pretty self-explanatory.</li>\n<li><strong>Rex::ConnectionRefused</strong> - Pretty self-explanatory.</li>\n</ul>\n<p>So to sum it up, ideally when you use the <code class=\"language-text\">connect</code> method, you should rescue these:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token keyword\">rescue</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">AddressInUse</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Errno</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">ETIMEDOUT</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">HostUnreachable</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">ConnectionTimeout</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">ConnectionRefused</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>If you are curious where all these exceptions are raised, you can find them in <a href=\"https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/socket/comm/local.rb\">lib/rex/socket/comm/local.rb</a>.</p>\n<h2 id=\"sending-data\" style=\"position:relative;\"><a href=\"#sending-data\" aria-label=\"sending data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sending data</h2>\n<p>There are several ways to send data with the Tcp mixin. To make things easier and safer, we recommend just use the <code class=\"language-text\">put</code> method:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">sock<span class=\"token punctuation\">.</span>put <span class=\"token string\">\"Hello, World!\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>The reason the <code class=\"language-text\">put</code> method is safer is because it does not allow the routine to hang forever. By default, it doesn't wait, but if you want to make this more flexible, you can do this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token keyword\">begin</span>\n\tsock<span class=\"token punctuation\">.</span>put<span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'Timeout'</span><span class=\"token operator\">=</span><span class=\"token operator\">></span><span class=\"token number\">5</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">rescue</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Timeout</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Error</span>\n\t<span class=\"token comment\"># You can decide what to do if the writing times out</span>\n<span class=\"token keyword\">end</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"receiving-data\" style=\"position:relative;\"><a href=\"#receiving-data\" aria-label=\"receiving data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Receiving data</h2>\n<p>Now, let's talk about how to receive data. Mainly there are three methods you can use: <code class=\"language-text\">get_once</code>, <code class=\"language-text\">get</code>, and <code class=\"language-text\">timed_read</code>. The difference is that <code class=\"language-text\">get_once</code> will only try to poll the stream to see if there's any read data available <strong>one time</strong>, but the <code class=\"language-text\">get</code> method will keep reading until there is no more. As for <code class=\"language-text\">timed_read</code>, it's basically the <code class=\"language-text\">read</code> method wrapped around with a Timeout.</p>\n<p>The following demonstrates how <code class=\"language-text\">get_once</code> is used:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token keyword\">begin</span>\n\tbuf <span class=\"token operator\">=</span> sock<span class=\"token punctuation\">.</span>get_once\n<span class=\"token keyword\">rescue</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">EOFError</span>\n<span class=\"token keyword\">end</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Note that <code class=\"language-text\">get_once</code> may also return nil if there is no data read, or it hits a EOFError if it receives nil as data. So please make sure you're catching nil in your module.</p>\n<p>The data reading methods can be found in <a href=\"https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/io/stream.rb\">lib/rex/io/stream.rb</a>.</p>\n<h2 id=\"disconnecting\" style=\"position:relative;\"><a href=\"#disconnecting\" aria-label=\"disconnecting permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Disconnecting</h2>\n<p>To disconnect the connection, simply do:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\">disconnect</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>It is VERY important you disconnect in an <code class=\"language-text\">ensure</code> block, obviously to make sure you always disconnect if something goes wrong. If you don't do this, you may end up with a module that can only one request to the server (that very first one), and the rest are broken.</p>\n<h2 id=\"full-example\" style=\"position:relative;\"><a href=\"#full-example\" aria-label=\"full example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Full example</h2>\n<p>The following example should demonstrate how you would typically want to use the Tcp mixin:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token comment\"># Sends data to the remote machine</span>\n<span class=\"token comment\">#</span>\n<span class=\"token comment\"># @param data [String] The data to send</span>\n<span class=\"token comment\"># @return [String] The received data</span>\n<span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">send_recv_once</span></span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n\tbuf <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n\t<span class=\"token keyword\">begin</span>\n\t\tconnect\n\t\tsock<span class=\"token punctuation\">.</span>put<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n\t\tbuf <span class=\"token operator\">=</span> sock<span class=\"token punctuation\">.</span>get_once <span class=\"token operator\">||</span> <span class=\"token string\">''</span>\n\t<span class=\"token keyword\">rescue</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">AddressInUse</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Errno</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">ETIMEDOUT</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">HostUnreachable</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">ConnectionTimeout</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">Rex</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">ConnectionRefused</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Timeout</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Error</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">EOFError</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> e\n\t\telog<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>e<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token delimiter tag\">}</span></span> <span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>e<span class=\"token punctuation\">.</span>message<span class=\"token delimiter tag\">}</span></span>\\n<span class=\"token interpolation\"><span class=\"token delimiter tag\">#{</span>e<span class=\"token punctuation\">.</span>backtrace <span class=\"token operator\">*</span> <span class=\"token string\">\"\\n\"</span><span class=\"token delimiter tag\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">ensure</span>\n\t\tdisconnect\n\t<span class=\"token keyword\">end</span>\n\n\tbuf\n<span class=\"token keyword\">end</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}},"pageContext":{"id":"4c1af304-a941-5024-8f88-bc165a9d2e90"}}}