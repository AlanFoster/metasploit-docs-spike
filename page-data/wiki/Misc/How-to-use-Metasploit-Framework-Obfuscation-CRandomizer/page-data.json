{"componentChunkName":"component---src-templates-wiki-template-tsx","path":"/wiki/Misc/How-to-use-Metasploit-Framework-Obfuscation-CRandomizer","result":{"data":{"markdownRemark":{"id":"bfd967f0-516b-56bf-bd1f-fda1d9ed494b","frontmatter":{"title":"How to use Metasploit Framework Obfuscation CRandomizer","root":null},"html":"<h1 id=\"how-to-use-metasploitframeworkobfuscationcrandomizer\" style=\"position:relative;\"><a href=\"#how-to-use-metasploitframeworkobfuscationcrandomizer\" aria-label=\"how to use metasploitframeworkobfuscationcrandomizer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to use Metasploit::Framework::Obfuscation::CRandomizer</h1>\n<h2 id=\"what-is-crandomizer\" style=\"position:relative;\"><a href=\"#what-is-crandomizer\" aria-label=\"what is crandomizer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is CRandomizer</h2>\n<p>CRandomizer is an obfuscation feature in Metasploit Framework that allows you to randomize C code. It is done by injecting random statements such as native API calls, custom fake function calls, or other routines, etc. The CRandomizer is also supported by Metasploit Framework's code compiling API, which allows you to build a custom application that is unique (in terms of checksums), also harder to reverse-engineer.</p>\n<p>The randomness of the modification is based on a weight, an arbitrary number from 0 - 100. The higher the number, the more random the code gets.</p>\n<h2 id=\"components\" style=\"position:relative;\"><a href=\"#components\" aria-label=\"components permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Components</h2>\n<p>CRandomizer relies on Metasm to be able to parse C code. The following components are built to parse and modify the source code.</p>\n<h2 id=\"code-factory\" style=\"position:relative;\"><a href=\"#code-factory\" aria-label=\"code factory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Factory</h2>\n<p>Also known as <code class=\"language-text\">Metasploit::Framework::Obfuscation::CRandomizer::CodeFactory</code>.</p>\n<p>The <code class=\"language-text\">CodeFactory</code> module is used to make the random stubs that will get injected later in the source code. Currently, the things this class is capable of making include small stubs like if statements, a switch, fake functions, and Windows API calls, etc. Each stub tends to be small, and considered as benign by most AVs.</p>\n<p>Every class in CodeFactory, except for Base, FakeFunction, and FakeFunctionCollection, is a stub candidate that gets randomly selected and used in the source code. </p>\n<p>If a stub requires a native API call, then the class can specify <code class=\"language-text\">@dep</code> to set that dependency. If the source code does not support the API call, then the next stub candidate is used (or until one is found).</p>\n<p>For example, the <code class=\"language-text\">CRandomizer::CodeFactory::OutputDebugString</code> class is used to generate a fake OutputDebugString call, and the dependency is set as <code class=\"language-text\">[&#39;OutputDebugString&#39;]</code>. If the source code includes the Windows.h header, the CRandomizer knows it is okay to inject OutputDebugString. If not, CRandomizer will not use it.</p>\n<h2 id=\"modifier\" style=\"position:relative;\"><a href=\"#modifier\" aria-label=\"modifier permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Modifier</h2>\n<p>Also known as <code class=\"language-text\">Metasploit::Framework::Obfuscation::CRandomizer::Modifier</code>.</p>\n<p>The Modifier class decides how something should be modified, and actually modifies the source code, for example: a function, different if statements, loops, nested blocks, etc.</p>\n<p>While the modifier walks through the source, it will randomly inject extra code (provided by the CodeFactory class) at each statement, until there are no more functions to modify.</p>\n<h2 id=\"parser\" style=\"position:relative;\"><a href=\"#parser\" aria-label=\"parser permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Parser</h2>\n<p>Also known as <code class=\"language-text\">Metasploit::Framework::Obfuscation::CRandomizer::Parser</code>.</p>\n<p>The main purpose of the Parser class is to convert the source code into a parsable format using Metasm, and then pass the functions to the Modifier class to process.</p>\n<h2 id=\"utility\" style=\"position:relative;\"><a href=\"#utility\" aria-label=\"utility permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Utility</h2>\n<p>The Utility class provides quick-to-use methods that any CRandomizer classes could use.</p>\n<h1 id=\"code-example\" style=\"position:relative;\"><a href=\"#code-example\" aria-label=\"code example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code Example</h1>\n<h2 id=\"creating-a-new-stub\" style=\"position:relative;\"><a href=\"#creating-a-new-stub\" aria-label=\"creating a new stub permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating a new stub</h2>\n<p>First, add a new file under the code_factory with an arbitrary file name. For example: hello.rb. In this example, let's create a new stub that will printf() \"Hello World\". Your stub should be written as a class under the CodeFactory namespace, and make sure to inherit the Base class. Like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-ruby line-numbers\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string\">'metasploit/framework/obfuscation/crandomizer/code_factory/base'</span>\n\n<span class=\"token keyword\">module</span> <span class=\"token constant\">Metasploit</span>\n  <span class=\"token keyword\">module</span> <span class=\"token constant\">Framework</span>\n    <span class=\"token keyword\">module</span> <span class=\"token constant\">Obfuscation</span>\n      <span class=\"token keyword\">module</span> <span class=\"token constant\">CRandomizer</span>\n        <span class=\"token keyword\">module</span> <span class=\"token constant\">CodeFactory</span>\n\n          <span class=\"token keyword\">class</span> <span class=\"token class-name\">Printf</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">Base</span>\n            <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">initialize</span></span>\n              <span class=\"token keyword\">super</span>\n              <span class=\"token variable\">@dep</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'printf'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">end</span>\n\n            <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">stub</span></span>\n              <span class=\"token string\">%Q|\n              int printf(const char*);\n              void stub() {\n                printf(\"Hello World\");\n              }|</span>\n            <span class=\"token keyword\">end</span>\n          <span class=\"token keyword\">end</span>\n\n        <span class=\"token keyword\">end</span>\n      <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Notice a couple of things:</p>\n<ul>\n<li>Every class should have its own <code class=\"language-text\">stub</code> method. And this <code class=\"language-text\">stub</code> method should return a string that contains the code you wish to inject. In addition, your code should be written as a function so that Metasm knows how to pick it up, hence the printf is in a <code class=\"language-text\">void stub()</code> function.</li>\n<li>If your stub requires a native API (in this case, we are using <code class=\"language-text\">printf</code>), then you must add this function name in the <code class=\"language-text\">@dep</code> instance variable, which is an array.</li>\n<li>\n<p>Please keep in mind that your stub should remain simple and small, and not unique. For example, avoid:</p>\n<ul>\n<li>Allocate a huge chunk of memory</li>\n<li>Avoid marking or allocating executable memory</li>\n<li>Loops</li>\n<li>Load referenced section, resource, or .data</li>\n<li>Anti-debugging functions from the Windows API</li>\n<li>Lots of function calls</li>\n<li>Unique strings</li>\n<li>APIs that access the Windows registry or the file system</li>\n<li>XOR</li>\n<li>Shellcode</li>\n<li>Any other suspicious code patterns that are unique to malware.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"randomizing-source-code\" style=\"position:relative;\"><a href=\"#randomizing-source-code\" aria-label=\"randomizing source code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Randomizing source code</h2>\n<p>Please refer to tools/exploit/random<em>compile</em>c.rb for example.</p>"}},"pageContext":{"id":"bfd967f0-516b-56bf-bd1f-fda1d9ed494b"}}}