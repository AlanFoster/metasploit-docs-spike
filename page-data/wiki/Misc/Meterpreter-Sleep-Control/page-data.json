{"componentChunkName":"component---src-templates-wiki-template-tsx","path":"/wiki/Misc/Meterpreter-Sleep-Control","result":{"data":{"markdownRemark":{"id":"b30473f5-f0aa-58c9-ab28-bf3af8fc8d63","frontmatter":{"title":"Meterpreter Sleep Control","root":null},"html":"<p>There comes a time in the life of many a Meterpreter session when it needs to go quiet for a while. There are many reasons that this might be needed:</p>\n<ul>\n<li>During an assessment, the blue team may have detected suspicious activity, and communications is too noisy.</li>\n<li>Long term engagements require long-term shells, but the red team isn't awake 24-hours a day, and so keeping the communications active the whole time doesn't make sense.</li>\n<li>Users may just want to reduce the number of shells they have to worry about at a given time and want some of them to go away for a while.</li>\n</ul>\n<p>For these reasons, and more, the new <code class=\"language-text\">sleep</code> command in Meterpreter was created. This document explains what it is and how it works.</p>\n<h2 id=\"silent-shells\" style=\"position:relative;\"><a href=\"#silent-shells\" aria-label=\"silent shells permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Silent shells</h2>\n<p>Noise during an assessment is not necessarily a good thing. With the advent of Meterpreter's new support and control of <a href=\"https://github.com/rapid7/metasploit-framework/wiki/Meterpreter-Transport-Control\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">multiple transports</a>, Meterpreter has the ability to change transports and therefore change the traffic pattern for communication. However, sometimes this isn't enough and sometimes users want to be able to shut the session off temporarily.</p>\n<p>The <code class=\"language-text\">sleep</code> command is designed to do just that: make the current Meterpreter session go to sleep for a specified period of time, and the wake up again once that time has expired.</p>\n<p>During this dormant period, no socket is active, no requests are made, and no responses are given. From the perspective of Metasploit it's as if the Meterpreter session doesn't exist.</p>\n<p>The interface to the sleep command looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">meterpreter &gt; sleep\nUsage: sleep &lt;time&gt;\n\n  time: Number of seconds to wait (positive integer)\n\n  This command tells Meterpreter to go to sleep for the specified\n  number of seconds. Sleeping will result in the transport being\n  shut down and restarted after the designated timeout.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>As shown, <code class=\"language-text\">sleep</code> expects to be given a single postive integer value that represents the number of seconds that Meterpreter should be silent for. When run, the session will close, and then callback after the elapsed period of time. Given that Meterpreter lives in memory, this lack of communication will make it extremely difficult to track.</p>\n<p>The following shows a sample run where Meterpreter is put to sleep for 20 seconds, after which the session reconnects while the handler is still in background:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">meterpreter &gt; sleep 20\n[*] Telling the target instance to sleep for 20 seconds ...\n[+] Target instance has gone to sleep, terminating current session.\n\n[*] 10.1.10.35 - Meterpreter session 3 closed.  Reason: User exit\nmsf exploit(handler) &gt; [*] Meterpreter session 4 opened (10.1.10.40:6005 -&gt; 10.1.10.35:49315) at 2015-06-02 23:00:29 +1000\n\nmsf exploit(handler) &gt; sessions -i 4\n[*] Starting interaction with 4...\n\nmeterpreter &gt; getuid\nServer username: WIN-S45GUQ5KGVK\\OJ</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"under-the-hood\" style=\"position:relative;\"><a href=\"#under-the-hood\" aria-label=\"under the hood permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Under the hood</h2>\n<p>The implementation of this command was made rather simple as a result of the work that was done to support multiple transports. To facilitate this command, all that happens is:</p>\n<ul>\n<li>A transport change is invoked, but the transport that is selected as the \"next\" transport is the same as the currently active one.</li>\n<li>The transport is shut down and the session is closed.</li>\n<li>The timeout value is passed to a call to <code class=\"language-text\">sleep()</code>, forcing the main thread of execution to pause for the allotted period of time.</li>\n<li>Execution resumes, and the resumption of connectivity continues in the usual transport switching fashion, only in this case, the transport that is fired up is the one that was just shut down.</li>\n</ul>\n<p>In short, the <code class=\"language-text\">sleep</code> command is a transport switch to the current transport with a delay. Simple!</p>"}},"pageContext":{"id":"b30473f5-f0aa-58c9-ab28-bf3af8fc8d63"}}}