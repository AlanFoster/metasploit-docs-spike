{"componentChunkName":"component---src-templates-wiki-template-tsx","path":"/wiki/Misc/Meterpreter-HTTP-Communication","result":{"data":{"markdownRemark":{"id":"581abca5-3f1a-5833-bd8c-b69861bfaa04","frontmatter":{"title":"Meterpreter HTTP Communication","root":null},"html":"<p>The Meterpreter payload supports a number of [[transport|Meterpreter Transport Control]], including <code class=\"language-text\">reverse_http</code> and <code class=\"language-text\">reverse_https</code>. This document describes how these transports work.</p>\n<h3 id=\"the-initial-url\" style=\"position:relative;\"><a href=\"#the-initial-url\" aria-label=\"the initial url permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Initial URL</h3>\n<p>During the generation process for a new <code class=\"language-text\">reverse_http</code> or <code class=\"language-text\">reverse_https</code> payload, an initial connect-back URL will be created. This URL will be either \"short\" or \"long\" and the 8-bit checksum of this URL will be set to one of the <code class=\"language-text\">INIT_*</code> constants defined in the <a href=\"https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/payloads/meterpreter/uri_checksum.rb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">UriChecksum</a> mixin. The URL will be generated using the <a href=\"https://tools.ietf.org/html/rfc4648#section-5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">base64url</a> character set. The \"short\" URL will always be 5 bytes in length while the \"long\" URL will be between 30 and 128 bytes in length. Which variant is used is determined by the space constraints of the exploit that generates the payload. The \"long\" URL can also include an embedded Payload UUID.</p>\n<h3 id=\"the-connection-url\" style=\"position:relative;\"><a href=\"#the-connection-url\" aria-label=\"the connection url permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Connection URL</h3>\n<p>The HTTP handler within Metasploit will receive the request for the initial URL, determine which <code class=\"language-text\">INIT_*</code> checksum it correlates to, extract any embedded [[Payload UUID]], and then respond with either the second stage for staged payloads or a new URL for stageless payloads. The new URL is generated by the handler, will embed any Payload UUID that was included in the original request, and will hash to the value defined by the <code class=\"language-text\">URI_CHECKSUM_CONN</code> constant. Note that characters other than the base64url character set are ignored during calculation of the checksum.</p>\n<p>The connect URL must be unique between sessions in order for the sessions to function properly.</p>\n<h3 id=\"tls-certificate-pinning\" style=\"position:relative;\"><a href=\"#tls-certificate-pinning\" aria-label=\"tls certificate pinning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TLS Certificate Pinning</h3>\n<p>The Meterpreter HTTPS transport supports certificate pinning. This applies to the stageless payloads as well as Meterpreter payloads loaded with the <code class=\"language-text\">reverse_winhttps</code> stagers. At this time, some of the non-Windows stagers also support certificate pinning, but this is still a work in progress. Certificate pinning is enabled by setting the <code class=\"language-text\">StagerVerifySSLCert</code> option to <code class=\"language-text\">true</code> and by extracting a SHA1 hash of the certificate specified in the <code class=\"language-text\">HandlerSSLCert</code> option. The SHA1 hash of the certificate will be verified during the staging process, and also in the handler, if these options are specified in the listener. This feature requires the pre-generation of a unified SSL/TLS certificate in PEM format, with the private key followed by one or more certificates in the chain. If an incoming session connects through a man-in-the-middle proxy that presents a different certificate, the first connection will connect back, but then immediately terminate. The handler will detect a non-responsive connection and close the session automatically.</p>\n<p>The command below generates a custom unified PEM TLS certificate that works with the <code class=\"language-text\">HandlerSSLCert</code> option:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \\\n    -subj &quot;/C=US/ST=Texas/L=Austin/O=Development/CN=www.example.com&quot; \\\n    -keyout www.example.com.key \\\n    -out www.example.com.crt &amp;&amp; \\\ncat www.example.com.key  www.example.com.crt &gt; www.example.com.pem &amp;&amp; \\\nrm -f www.example.com.key  www.example.com.crt</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"the-application-protocol\" style=\"position:relative;\"><a href=\"#the-application-protocol\" aria-label=\"the application protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Application Protocol</h3>\n<p>Once the Meterpreter connect URL is requested, the actual dispatch loop starts to run. The Meterpreter payload will make repeated requests with a HTTP body consistent of \"RECV\". Any queued commands will be returned to the payload, which will process them individually, and return the results in a following request. If no commands were returned as a result of a \"RECV\" request, the payload will double the interval until the next request, with a maximum that is generally about 10 seconds.</p>\n<p>Additional details about the configuration of the HTTP transport can be found on the [[transport control|Meterpreter Transport Control]] wiki page.</p>"}},"pageContext":{"id":"581abca5-3f1a-5833-bd8c-b69861bfaa04"}}}