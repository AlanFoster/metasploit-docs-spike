{
  "name": "Veritas/Symantec Backup Exec SSL NDMP Connection Use-After-Free",
  "fullname": "exploit/windows/backupexec/ssl_uaf",
  "aliases": [

  ],
  "rank": 300,
  "disclosure_date": "2017-05-10",
  "type": "exploit",
  "author": [
    "Matthew Daley"
  ],
  "description": "This module exploits a use-after-free vulnerability in the handling of SSL NDMP\n        connections in Veritas/Symantec Backup Exec's Remote Agent for Windows. When SSL\n        is re-established on a NDMP connection that previously has had SSL established,\n        the BIO struct for the connection's previous SSL session is reused, even though it\n        has previously been freed.\n\n        This module supports 3 specific versions of the Backup Exec agent in the 14, 15\n        and 16 series on 64-bit and 32-bit versions of Windows and has been tested from\n        Vista to Windows 10. The check command can help narrow down what major and minor\n        revision is installed and the precise of version of Windows, but some other\n        information may be required to make a reliable choice of target.\n\n        NX, ASLR and Windows 8+ anti-ROP mitigations are bypassed. On Windows 8+, it has a\n        reliability of around 85%. On other versions of Windows, reliability is around 35%\n        (due to the need to win a race condition across the network in this case; this may\n        drop further depending on network conditions). The agent is normally installed on\n        all hosts in a domain that need to be backed up, so if one service crashes, try\n        again on another :) Successful exploitation will give remote code execution as the\n        user of the Backup Exec Remote Agent for Windows service, almost always\n        NT AUTHORITY\\SYSTEM.",
  "references": [
    "https://cvedetails.com/cve/CVE-2017-8895/",
    "VTS (17-006)",
    "https://www.veritas.com/content/support/en_US/security/VTS17-006.html"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Backup Exec 14 (14.1 / revision 9.1), Windows >= 8 x64",
    "Backup Exec 14 (14.1 / revision 9.1), Windows >= 8 x86",
    "Backup Exec 14 (14.1 / revision 9.1), Windows <= 7 x64",
    "Backup Exec 14 (14.1 / revision 9.1), Windows <= 7 x86",
    "Backup Exec 15 (14.2 / revision 9.2), Windows >= 8 x64",
    "Backup Exec 15 (14.2 / revision 9.2), Windows >= 8 x86",
    "Backup Exec 15 (14.2 / revision 9.2), Windows <= 7 x64",
    "Backup Exec 15 (14.2 / revision 9.2), Windows <= 7 x86",
    "Backup Exec 16 (16.0 / revision 9.2), Windows >= 8 x64",
    "Backup Exec 16 (16.0 / revision 9.2), Windows >= 8 x86",
    "Backup Exec 16 (16.0 / revision 9.2), Windows <= 7 x64",
    "Backup Exec 16 (16.0 / revision 9.2), Windows <= 7 x86"
  ],
  "path": "/modules/exploits/windows/backupexec/ssl_uaf.rb",
  "ref_name": "windows/backupexec/ssl_uaf",
  "check": true,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "addressrange",
      "name": "RHOSTS",
      "required": true,
      "default": null,
      "aliases": [
        "RHOST"
      ],
      "advanced": false,
      "description": "The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'"
    },
    {
      "type": "port",
      "name": "RPORT",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The target port"
    },
    {
      "type": "bool",
      "name": "SSL",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Negotiate SSL/TLS for outgoing connections"
    },
    {
      "type": "enum",
      "name": "SSLVersion",
      "required": true,
      "default": "Auto",
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the version of SSL/TLS to be used (Auto, TLS and SSL23 are auto-negotiate) (Accepted: Auto, TLS, SSL23, SSL3, TLS1, TLS1.1, TLS1.2)"
    },
    {
      "type": "enum",
      "name": "SSLVerifyMode",
      "required": false,
      "default": "PEER",
      "aliases": [

      ],
      "advanced": true,
      "description": "SSL verification method (Accepted: CLIENT_ONCE, FAIL_IF_NO_PEER_CERT, NONE, PEER)"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "string",
      "name": "Proxies",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "A proxy chain of format type:host:port[,type:host:port][...]"
    },
    {
      "type": "port",
      "name": "CPORT",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client port"
    },
    {
      "type": "address",
      "name": "CHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client address"
    },
    {
      "type": "integer",
      "name": "ConnectTimeout",
      "required": true,
      "default": 10,
      "aliases": [

      ],
      "advanced": true,
      "description": "Maximum number of seconds to establish a TCP connection"
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maxiumum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "NumSpraySockets",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Number of sockets to spray stage 1 with"
    },
    {
      "type": "integer",
      "name": "NumTLSSpraySockets",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Number of sockets to spray TLS extensions with"
    },
    {
      "type": "integer",
      "name": "NumTriggerAttempts",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Number of attempts to trigger the vulnerability (Windows 8+ only)"
    }
  ]
}