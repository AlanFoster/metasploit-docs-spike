{
  "name": "Authenticated WMI Exec via Powershell",
  "fullname": "exploit/windows/local/ps_wmi_exec",
  "aliases": [

  ],
  "rank": 600,
  "disclosure_date": "2012-08-19",
  "type": "exploit",
  "author": [
    "RageLtMan <rageltman@sempervictus>"
  ],
  "description": "This module uses WMI execution to launch a payload instance on a remote machine.\n        In order to avoid AV detection, all execution is performed in memory via psh-net\n        encoded payload. Persistence option can be set to keep the payload looping while\n        a handler is present to receive it. By default the module runs as the current\n        process owner. The module can be configured with credentials for the remote host\n        with which to launch the process.",
  "references": [

  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Universal"
  ],
  "path": "/modules/exploits/windows/local/ps_wmi_exec.rb",
  "ref_name": "windows/local/ps_wmi_exec",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "integer",
      "name": "SESSION",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The session to run this module on."
    },
    {
      "type": "bool",
      "name": "Powershell::persist",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Run the payload in a loop"
    },
    {
      "type": "integer",
      "name": "Powershell::prepend_sleep",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Prepend seconds of sleep"
    },
    {
      "type": "bool",
      "name": "Powershell::prepend_protections_bypass",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Prepend AMSI/SBL bypass"
    },
    {
      "type": "bool",
      "name": "Powershell::strip_comments",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Strip comments"
    },
    {
      "type": "bool",
      "name": "Powershell::strip_whitespace",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Strip whitespace"
    },
    {
      "type": "bool",
      "name": "Powershell::sub_vars",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Substitute variable names"
    },
    {
      "type": "bool",
      "name": "Powershell::sub_funcs",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Substitute function names"
    },
    {
      "type": "bool",
      "name": "Powershell::exec_in_place",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Produce PSH without executable wrapper"
    },
    {
      "type": "bool",
      "name": "Powershell::exec_rc4",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Encrypt PSH with RC4"
    },
    {
      "type": "bool",
      "name": "Powershell::remove_comspec",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Produce script calling powershell directly"
    },
    {
      "type": "bool",
      "name": "Powershell::noninteractive",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Execute powershell without interaction"
    },
    {
      "type": "bool",
      "name": "Powershell::encode_final_payload",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Encode final payload for -EncodedCommand"
    },
    {
      "type": "bool",
      "name": "Powershell::encode_inner_payload",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Encode inner payload for -EncodedCommand"
    },
    {
      "type": "bool",
      "name": "Powershell::wrap_double_quotes",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Wraps the -Command argument in single quotes"
    },
    {
      "type": "bool",
      "name": "Powershell::no_equals",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Pad base64 until no \"=\" remains"
    },
    {
      "type": "enum",
      "name": "Powershell::method",
      "required": true,
      "default": "reflection",
      "aliases": [

      ],
      "advanced": true,
      "description": "Payload delivery method (Accepted: net, reflection, old, msil)"
    },
    {
      "type": "integer",
      "name": "Powershell::Post::timeout",
      "required": true,
      "default": 15,
      "aliases": [

      ],
      "advanced": true,
      "description": "Powershell execution timeout, set < 0 to run async without termination"
    },
    {
      "type": "bool",
      "name": "Powershell::Post::log_output",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Write output to log file"
    },
    {
      "type": "bool",
      "name": "Powershell::Post::dry_run",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Return encoded output to caller"
    },
    {
      "type": "bool",
      "name": "Powershell::Post::force_wow64",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Force WOW64 execution"
    },
    {
      "type": "string",
      "name": "CERT_PATH",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Path on compiler host to .pfx fomatted certificate for signing"
    },
    {
      "type": "addressrange",
      "name": "RHOSTS",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Target address range or CIDR identifier"
    },
    {
      "type": "string",
      "name": "USERNAME",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Username to authenticate as"
    },
    {
      "type": "string",
      "name": "PASSWORD",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Password to authenticate with"
    },
    {
      "type": "string",
      "name": "DOMAIN",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Domain or machine name"
    },
    {
      "type": "bool",
      "name": "PowerShellPersist",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Run the payload in a loop"
    },
    {
      "type": "bool",
      "name": "RunRemoteWow64",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Execute powershell in 32bit compatibility mode, payloads need native arch"
    }
  ]
}