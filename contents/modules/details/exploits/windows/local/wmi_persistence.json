{
  "name": "WMI Event Subscription Persistence",
  "fullname": "exploit/windows/local/wmi_persistence",
  "aliases": [

  ],
  "rank": 300,
  "disclosure_date": "2017-06-06",
  "type": "exploit",
  "author": [
    "Nick Tyrer <@NickTyrer>"
  ],
  "description": "This module will create a permanent WMI event subscription to achieve file-less persistence using one\n          of five methods. The EVENT method will create an event filter that will query the event log for an EVENT_ID_TRIGGER\n          (default: failed logon request id 4625) that also contains a specified USERNAME_TRIGGER (note: failed logon auditing\n          must be enabled on the target for this method to work, this can be enabled using \"auditpol.exe /set /subcategory:Logon\n          /failure:Enable\"). When these criteria are met a command line event consumer will trigger an encoded powershell payload.\n          The INTERVAL method will create an event filter that triggers the payload after the specified CALLBACK_INTERVAL. The LOGON\n          method will create an event filter that will trigger the payload after the system has an uptime of 4 minutes. The PROCESS\n          method will create an event filter that triggers the payload when the specified process is started. The WAITFOR method\n          creates an event filter that utilizes the Microsoft binary waitfor.exe to wait for a signal specified by WAITFOR_TRIGGER\n          before executing the payload. The signal can be sent from a windows host on a LAN utilizing the waitfor.exe command\n          (note: requires target to have port 445 open). Additionally a custom command can be specified to run once the trigger is\n          activated using the advanced option CUSTOM_PS_COMMAND. This module requires administrator level privileges as well as a\n          high integrity process. It is also recommended not to use stageless payloads due to powershell script length limitations.",
  "references": [
    "https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf",
    "https://learn-powershell.net/2013/08/14/powershell-and-events-permanent-wmi-event-subscriptions/"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Windows"
  ],
  "path": "/modules/exploits/windows/local/wmi_persistence.rb",
  "ref_name": "windows/local/wmi_persistence",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "integer",
      "name": "SESSION",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The session to run this module on."
    },
    {
      "type": "bool",
      "name": "Powershell::persist",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Run the payload in a loop"
    },
    {
      "type": "integer",
      "name": "Powershell::prepend_sleep",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Prepend seconds of sleep"
    },
    {
      "type": "bool",
      "name": "Powershell::prepend_protections_bypass",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Prepend AMSI/SBL bypass"
    },
    {
      "type": "bool",
      "name": "Powershell::strip_comments",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Strip comments"
    },
    {
      "type": "bool",
      "name": "Powershell::strip_whitespace",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Strip whitespace"
    },
    {
      "type": "bool",
      "name": "Powershell::sub_vars",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Substitute variable names"
    },
    {
      "type": "bool",
      "name": "Powershell::sub_funcs",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Substitute function names"
    },
    {
      "type": "bool",
      "name": "Powershell::exec_in_place",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Produce PSH without executable wrapper"
    },
    {
      "type": "bool",
      "name": "Powershell::exec_rc4",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Encrypt PSH with RC4"
    },
    {
      "type": "bool",
      "name": "Powershell::remove_comspec",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Produce script calling powershell directly"
    },
    {
      "type": "bool",
      "name": "Powershell::noninteractive",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Execute powershell without interaction"
    },
    {
      "type": "bool",
      "name": "Powershell::encode_final_payload",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Encode final payload for -EncodedCommand"
    },
    {
      "type": "bool",
      "name": "Powershell::encode_inner_payload",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Encode inner payload for -EncodedCommand"
    },
    {
      "type": "bool",
      "name": "Powershell::wrap_double_quotes",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Wraps the -Command argument in single quotes"
    },
    {
      "type": "bool",
      "name": "Powershell::no_equals",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Pad base64 until no \"=\" remains"
    },
    {
      "type": "enum",
      "name": "Powershell::method",
      "required": true,
      "default": "reflection",
      "aliases": [

      ],
      "advanced": true,
      "description": "Payload delivery method (Accepted: net, reflection, old, msil)"
    },
    {
      "type": "integer",
      "name": "Powershell::Post::timeout",
      "required": true,
      "default": 15,
      "aliases": [

      ],
      "advanced": true,
      "description": "Powershell execution timeout, set < 0 to run async without termination"
    },
    {
      "type": "bool",
      "name": "Powershell::Post::log_output",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Write output to log file"
    },
    {
      "type": "bool",
      "name": "Powershell::Post::dry_run",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Return encoded output to caller"
    },
    {
      "type": "bool",
      "name": "Powershell::Post::force_wow64",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Force WOW64 execution"
    },
    {
      "type": "enum",
      "name": "PERSISTENCE_METHOD",
      "required": true,
      "default": "EVENT",
      "aliases": [

      ],
      "advanced": false,
      "description": "Method to trigger the payload. (Accepted: EVENT, INTERVAL, LOGON, PROCESS, WAITFOR)"
    },
    {
      "type": "integer",
      "name": "EVENT_ID_TRIGGER",
      "required": true,
      "default": 4625,
      "aliases": [

      ],
      "advanced": false,
      "description": "Event ID to trigger the payload. (Default: 4625)"
    },
    {
      "type": "string",
      "name": "USERNAME_TRIGGER",
      "required": true,
      "default": "BOB",
      "aliases": [

      ],
      "advanced": false,
      "description": "The username to trigger the payload. (Default: BOB)"
    },
    {
      "type": "string",
      "name": "PROCESS_TRIGGER",
      "required": true,
      "default": "CALC.EXE",
      "aliases": [

      ],
      "advanced": false,
      "description": "The process name to trigger the payload. (Default: CALC.EXE)"
    },
    {
      "type": "string",
      "name": "WAITFOR_TRIGGER",
      "required": true,
      "default": "CALL",
      "aliases": [

      ],
      "advanced": false,
      "description": "The word to trigger the payload. (Default: CALL)"
    },
    {
      "type": "integer",
      "name": "CALLBACK_INTERVAL",
      "required": true,
      "default": 1800000,
      "aliases": [

      ],
      "advanced": false,
      "description": "Time between callbacks (In milliseconds). (Default: 1800000)."
    },
    {
      "type": "string",
      "name": "CLASSNAME",
      "required": true,
      "default": "UPDATER",
      "aliases": [

      ],
      "advanced": false,
      "description": "WMI event class name. (Default: UPDATER)"
    },
    {
      "type": "string",
      "name": "CUSTOM_PS_COMMAND",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Custom powershell command to run once the trigger is activated. (Note: some commands will need to be encolsed in quotes)"
    }
  ]
}