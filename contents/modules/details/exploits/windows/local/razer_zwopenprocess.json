{
  "name": "Razer Synapse rzpnk.sys ZwOpenProcess",
  "fullname": "exploit/windows/local/razer_zwopenprocess",
  "aliases": [

  ],
  "rank": 300,
  "disclosure_date": "2017-03-22",
  "type": "exploit",
  "author": [
    "Spencer McIntyre"
  ],
  "description": "A vulnerability exists in the latest version of Razer Synapse\n        (v2.20.15.1104 as of the day of disclosure) which can be leveraged\n        locally by a malicious application to elevate its privileges to those of\n        NT_AUTHORITY\\SYSTEM. The vulnerability lies in a specific IOCTL handler\n        in the rzpnk.sys driver that passes a PID specified by the user to\n        ZwOpenProcess. This can be issued by an application to open a handle to\n        an arbitrary process with the necessary privileges to allocate, read and\n        write memory in the specified process.\n\n        This exploit leverages this vulnerability to open a handle to the\n        winlogon process (which runs as NT_AUTHORITY\\SYSTEM) and infect it by\n        installing a hook to execute attacker controlled shellcode. This hook is\n        then triggered on demand by calling user32!LockWorkStation(), resulting\n        in the attacker's payload being executed with the privileges of the\n        infected winlogon process. In order for the issued IOCTL to work, the\n        RazerIngameEngine.exe process must not be running. This exploit will\n        check if it is, and attempt to kill it as necessary.\n\n        The vulnerable software can be found here:\n        https://www.razerzone.com/synapse/. No Razer hardware needs to be\n        connected in order to leverage this vulnerability.\n\n        This exploit is not opsec-safe due to the user being logged out as part\n        of the exploitation process.",
  "references": [
    "https://cvedetails.com/cve/CVE-2017-9769/",
    "https://warroom.securestate.com/cve-2017-9769/"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Windows x64"
  ],
  "path": "/modules/exploits/windows/local/razer_zwopenprocess.rb",
  "ref_name": "windows/local/razer_zwopenprocess",
  "check": true,
  "post_auth": false,
  "default_credential": false,
  "notes": {
    "Stability": [
      "crash-service-restarts"
    ],
    "SideEffects": [
      "screen-effects"
    ],
    "Reliability": [
      "repeatable-session"
    ]
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "integer",
      "name": "SESSION",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The session to run this module on."
    }
  ]
}