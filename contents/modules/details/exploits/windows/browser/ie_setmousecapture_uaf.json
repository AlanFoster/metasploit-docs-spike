{
  "name": "MS13-080 Microsoft Internet Explorer SetMouseCapture Use-After-Free",
  "fullname": "exploit/windows/browser/ie_setmousecapture_uaf",
  "aliases": [

  ],
  "rank": 300,
  "disclosure_date": "2013-09-17",
  "type": "exploit",
  "author": [
    "Unknown",
    "sinn3r <sinn3r@metasploit.com>",
    "Rich Lundeen"
  ],
  "description": "This module exploits a use-after-free vulnerability that currents targets Internet\n          Explorer 9 on Windows 7, but the flaw should exist in versions 6/7/8/9/10/11.\n          It was initially found in the wild in Japan, but other regions such as English,\n          Chinese, Korean, etc, were targeted as well.\n\n          The vulnerability is due to how the mshtml!CDoc::SetMouseCapture function handles a\n          reference during an event. An attacker first can setup two elements, where the second\n          is the child of the first, and then setup a onlosecapture event handler for the parent\n          element. The onlosecapture event seems to require two setCapture() calls to trigger,\n          one for the parent element, one for the child. When the setCapture() call for the child\n          element is called, it finally triggers the event, which allows the attacker to cause an\n          arbitrary memory release using document.write(), which in particular frees up a 0x54-byte\n          memory.  The exact size of this memory may differ based on the version of IE. After the\n          free, an invalid reference will still be kept and pass on to more functions, eventuall\n          this arrives in function MSHTML!CTreeNode::GetInterface, and causes a crash (or arbitrary\n          code execution) when this function attempts to use this reference to call what appears to\n          be a PrivateQueryInterface due to the offset (0x00).\n\n          To mimic the same exploit found in the wild, this module will try to use the same DLL\n          from Microsoft Office 2007 or 2010 to leverage the attack.",
  "references": [
    "https://cvedetails.com/cve/CVE-2013-3893/",
    "OSVDB (97380)",
    "https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2013/MS13-080",
    "http://technet.microsoft.com/en-us/security/advisory/2887505",
    "http://blogs.technet.com/b/srd/archive/2013/09/17/cve-2013-3893-fix-it-workaround-available.aspx",
    "https://blog.rapid7.com/2013/09/30/metasploit-releases-cve-2013-3893-ie-setmousecapture-use-after-free"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Automatic",
    "Windows 7 with Office 2007|2010",
    "Windows XP with IE 8"
  ],
  "path": "/modules/exploits/windows/browser/ie_setmousecapture_uaf.rb",
  "ref_name": "windows/browser/ie_setmousecapture_uaf",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "address",
      "name": "SRVHOST",
      "required": true,
      "default": "0.0.0.0",
      "aliases": [

      ],
      "advanced": false,
      "description": "The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses."
    },
    {
      "type": "port",
      "name": "SRVPORT",
      "required": true,
      "default": 8080,
      "aliases": [

      ],
      "advanced": false,
      "description": "The local port to listen on."
    },
    {
      "type": "string",
      "name": "ListenerComm",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The specific communication channel to use for this service"
    },
    {
      "type": "bool",
      "name": "SSL",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Negotiate SSL for incoming connections"
    },
    {
      "type": "path",
      "name": "SSLCert",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Path to a custom SSL certificate (default is randomly generated)"
    },
    {
      "type": "bool",
      "name": "SSLCompression",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable SSL/TLS-level compression"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher spec - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maximum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "string",
      "name": "URIPATH",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The URI to use for this exploit (default is random)"
    },
    {
      "type": "bool",
      "name": "HTTP::no_cache",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Disallow the browser to cache HTTP content"
    },
    {
      "type": "bool",
      "name": "HTTP::chunked",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable chunking of HTTP responses via \"Transfer-Encoding: chunked\""
    },
    {
      "type": "bool",
      "name": "HTTP::header_folding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable folding of HTTP headers"
    },
    {
      "type": "bool",
      "name": "HTTP::junk_headers",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable insertion of random junk HTTP headers"
    },
    {
      "type": "enum",
      "name": "HTTP::compression",
      "required": false,
      "default": "none",
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable compression of HTTP responses via content encoding (Accepted: none, gzip, deflate)"
    },
    {
      "type": "string",
      "name": "HTTP::server_name",
      "required": true,
      "default": "Apache",
      "aliases": [

      ],
      "advanced": false,
      "description": "Configures the Server header of all outgoing replies"
    },
    {
      "type": "address",
      "name": "URIHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Host to use in URI (useful for tunnels)"
    },
    {
      "type": "port",
      "name": "URIPORT",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Port to use in URI (useful for tunnels)"
    },
    {
      "type": "bool",
      "name": "SendRobots",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Return a robots.txt file if asked for one"
    },
    {
      "type": "enum",
      "name": "HTML::unicode",
      "required": false,
      "default": "none",
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable HTTP obfuscation via unicode (Accepted: none, utf-16le, utf-16be, utf-16be-marker, utf-32le, utf-32be)"
    },
    {
      "type": "enum",
      "name": "HTML::base64",
      "required": false,
      "default": "none",
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable HTML obfuscation via an embeded base64 html object (IE not supported) (Accepted: none, plain, single_pad, double_pad, random_space_injection)"
    },
    {
      "type": "integer",
      "name": "HTML::javascript::escape",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable HTML obfuscation via HTML escaping (number of iterations)"
    },
    {
      "type": "integer",
      "name": "JsObfuscate",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Number of times to obfuscate JavaScript"
    },
    {
      "type": "string",
      "name": "JsIdentifiers",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Identifiers to preserve for JsObfu"
    },
    {
      "type": "bool",
      "name": "Retries",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Allow the browser to retry the module"
    },
    {
      "type": "string",
      "name": "CookieName",
      "required": false,
      "default": "__ua",
      "aliases": [

      ],
      "advanced": true,
      "description": "The name of the tracking cookie"
    },
    {
      "type": "string",
      "name": "CookieExpiration",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Cookie expiration in years (blank=expire on exit)"
    },
    {
      "type": "string",
      "name": "Custom404",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "An external custom 404 URL (Example: http://example.com/404.html)"
    }
  ]
}