{
  "name": "Mozilla Firefox \"nsTreeRange\" Dangling Pointer Vulnerability",
  "fullname": "exploit/windows/browser/mozilla_nstreerange",
  "aliases": [

  ],
  "rank": 300,
  "disclosure_date": "2011-02-02",
  "type": "exploit",
  "author": [
    "regenrecht",
    "xero"
  ],
  "description": "This module exploits a code execution vulnerability in Mozilla Firefox\n        3.6.x <= 3.6.16 and 3.5.x <= 3.5.17 found in nsTreeSelection.\n        By overwriting a subfunction of invalidateSelection it is possible to free the\n        nsTreeRange object that the function currently operates on.\n        Any further operations on the freed object can result in remote code execution.\n        Utilizing the call setup the function provides it's possible to bypass DEP\n        without the need for a ROP. Sadly this exploit is still either dependent\n        on Java or bound by ASLR because Firefox doesn't employ any ASLR-free\n        modules anymore.",
  "references": [
    "https://cvedetails.com/cve/CVE-2011-0073/",
    "OSVDB (72087)",
    "http://www.securityfocus.com/bid/47663",
    "http://www.zerodayinitiative.com/advisories/ZDI-11-157",
    "https://bugzilla.mozilla.org/show_bug.cgi?id=630919",
    "http://www.mozilla.org/security/announce/2011/mfsa2011-13.html"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Auto (Direct attack against Windows XP, otherwise through Java, if enabled)",
    "Firefox Runtime, fails with ASLR",
    "Java Runtime (7.10.3052.4), best against ASLR",
    "Java JVM (20.1.0.02)",
    "Java Regutils (6.0.260.3)"
  ],
  "path": "/modules/exploits/windows/browser/mozilla_nstreerange.rb",
  "ref_name": "windows/browser/mozilla_nstreerange",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "address",
      "name": "SRVHOST",
      "required": true,
      "default": "0.0.0.0",
      "aliases": [

      ],
      "advanced": false,
      "description": "The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses."
    },
    {
      "type": "port",
      "name": "SRVPORT",
      "required": true,
      "default": 8080,
      "aliases": [

      ],
      "advanced": false,
      "description": "The local port to listen on."
    },
    {
      "type": "string",
      "name": "ListenerComm",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The specific communication channel to use for this service"
    },
    {
      "type": "bool",
      "name": "SSL",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Negotiate SSL for incoming connections"
    },
    {
      "type": "path",
      "name": "SSLCert",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Path to a custom SSL certificate (default is randomly generated)"
    },
    {
      "type": "bool",
      "name": "SSLCompression",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable SSL/TLS-level compression"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher spec - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maximum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "string",
      "name": "URIPATH",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The URI to use for this exploit (default is random)"
    },
    {
      "type": "bool",
      "name": "HTTP::no_cache",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Disallow the browser to cache HTTP content"
    },
    {
      "type": "bool",
      "name": "HTTP::chunked",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable chunking of HTTP responses via \"Transfer-Encoding: chunked\""
    },
    {
      "type": "bool",
      "name": "HTTP::header_folding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable folding of HTTP headers"
    },
    {
      "type": "bool",
      "name": "HTTP::junk_headers",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable insertion of random junk HTTP headers"
    },
    {
      "type": "enum",
      "name": "HTTP::compression",
      "required": false,
      "default": "none",
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable compression of HTTP responses via content encoding (Accepted: none, gzip, deflate)"
    },
    {
      "type": "string",
      "name": "HTTP::server_name",
      "required": true,
      "default": "Apache",
      "aliases": [

      ],
      "advanced": false,
      "description": "Configures the Server header of all outgoing replies"
    },
    {
      "type": "address",
      "name": "URIHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Host to use in URI (useful for tunnels)"
    },
    {
      "type": "port",
      "name": "URIPORT",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Port to use in URI (useful for tunnels)"
    },
    {
      "type": "bool",
      "name": "SendRobots",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Return a robots.txt file if asked for one"
    },
    {
      "type": "enum",
      "name": "HTML::unicode",
      "required": false,
      "default": "none",
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable HTTP obfuscation via unicode (Accepted: none, utf-16le, utf-16be, utf-16be-marker, utf-32le, utf-32be)"
    },
    {
      "type": "enum",
      "name": "HTML::base64",
      "required": false,
      "default": "none",
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable HTML obfuscation via an embeded base64 html object (IE not supported) (Accepted: none, plain, single_pad, double_pad, random_space_injection)"
    },
    {
      "type": "integer",
      "name": "HTML::javascript::escape",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable HTML obfuscation via HTML escaping (number of iterations)"
    },
    {
      "type": "bool",
      "name": "SEHProlog",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Whether to prepend the payload with an SEH prolog, to catch crashes and enable a silent exit"
    },
    {
      "type": "bool",
      "name": "CreateThread",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Whether to execute the payload in a new thread"
    },
    {
      "type": "bool",
      "name": "OBFUSCATE",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable JavaScript obfuscation"
    },
    {
      "type": "integer",
      "name": "BaseOffset",
      "required": true,
      "default": 251658240,
      "aliases": [

      ],
      "advanced": true,
      "description": "The offset we hope to have overwritten with our heap spray"
    },
    {
      "type": "integer",
      "name": "SpraySize",
      "required": true,
      "default": 1048576,
      "aliases": [

      ],
      "advanced": true,
      "description": "The size of our heapspray blocks"
    },
    {
      "type": "integer",
      "name": "SprayCount",
      "required": true,
      "default": 200,
      "aliases": [

      ],
      "advanced": true,
      "description": "Number of blocks to be sprayed"
    },
    {
      "type": "bool",
      "name": "SetBP",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Set a breakpoint before payload execution"
    },
    {
      "type": "bool",
      "name": "Crash",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Usa an invalid offset to make the exploit crash (for debugging)"
    }
  ]
}