{
  "name": "LNK Code Execution Vulnerability",
  "fullname": "exploit/windows/fileformat/cve_2017_8464_lnk_rce",
  "aliases": [

  ],
  "rank": 600,
  "disclosure_date": "2017-06-13",
  "type": "exploit",
  "author": [
    "Uncredited",
    "Yorick Koster",
    "Spencer McIntyre"
  ],
  "description": "This module exploits a vulnerability in the handling of Windows Shortcut files (.LNK)\n          that contain a dynamic icon, loaded from a malicious DLL.\n\n          This vulnerability is a variant of MS15-020 (CVE-2015-0096). The created LNK file is\n          similar except an additional SpecialFolderDataBlock is included. The folder ID set\n          in this SpecialFolderDataBlock is set to the Control Panel. This is enough to bypass\n          the CPL whitelist. This bypass can be used to trick Windows into loading an arbitrary\n          DLL file.\n\n          If no PATH is specified, the module will use drive letters D through Z so the files\n          may be placed in the root path of a drive such as a shared VM folder or USB drive.",
  "references": [
    "https://cvedetails.com/cve/CVE-2017-8464/",
    "https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2017-8464",
    "http://www.vxjump.net/files/vuln_analysis/cve-2017-8464.txt",
    "https://msdn.microsoft.com/en-us/library/dd871305.aspx",
    "http://www.geoffchappell.com/notes/security/stuxnet/ctrlfldr.htm",
    "https://www.trendmicro.de/cloud-content/us/pdfs/security-intelligence/white-papers/wp-cpl-malware.pdf"
  ],
  "platform": "Windows",
  "arch": "x86, x64",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Automatic",
    "Windows x64",
    "Windows x86"
  ],
  "path": "/modules/exploits/windows/fileformat/cve_2017_8464_lnk_rce.rb",
  "ref_name": "windows/fileformat/cve_2017_8464_lnk_rce",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
    "Stability": [
      "crash-service-restarts"
    ]
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "string",
      "name": "FILENAME",
      "required": false,
      "default": "Flash Player.lnk",
      "aliases": [

      ],
      "advanced": false,
      "description": "The LNK file"
    },
    {
      "type": "bool",
      "name": "EXE::EICAR",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Generate an EICAR file instead of regular payload exe"
    },
    {
      "type": "path",
      "name": "EXE::Custom",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use custom exe instead of automatically generating a payload exe"
    },
    {
      "type": "path",
      "name": "EXE::Path",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The directory in which to look for the executable template"
    },
    {
      "type": "path",
      "name": "EXE::Template",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The executable template file name."
    },
    {
      "type": "bool",
      "name": "EXE::Inject",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Set to preserve the original EXE function"
    },
    {
      "type": "bool",
      "name": "EXE::OldMethod",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Set to use the substitution EXE generation method."
    },
    {
      "type": "bool",
      "name": "EXE::FallBack",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use the default template in case the specified one is missing"
    },
    {
      "type": "bool",
      "name": "MSI::EICAR",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Generate an EICAR file instead of regular payload msi"
    },
    {
      "type": "path",
      "name": "MSI::Custom",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use custom msi instead of automatically generating a payload msi"
    },
    {
      "type": "path",
      "name": "MSI::Path",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The directory in which to look for the msi template"
    },
    {
      "type": "path",
      "name": "MSI::Template",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The msi template file name"
    },
    {
      "type": "bool",
      "name": "MSI::UAC",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Create an MSI with a UAC prompt (elevation to SYSTEM if accepted)"
    },
    {
      "type": "string",
      "name": "DLLNAME",
      "required": false,
      "default": "FlashPlayerCPLApp.cpl",
      "aliases": [

      ],
      "advanced": false,
      "description": "The DLL file containing the payload"
    },
    {
      "type": "string",
      "name": "PATH",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "An explicit path to where the files will be hosted"
    },
    {
      "type": "string",
      "name": "LnkComment",
      "required": true,
      "default": "Manage Flash Player Settings",
      "aliases": [

      ],
      "advanced": true,
      "description": "The comment to use in the generated LNK file"
    },
    {
      "type": "string",
      "name": "LnkDisplayName",
      "required": true,
      "default": "Flash Player",
      "aliases": [

      ],
      "advanced": true,
      "description": "The display name to use in the generated LNK file"
    }
  ]
}