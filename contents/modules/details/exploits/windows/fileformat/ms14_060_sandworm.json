{
  "name": "MS14-060 Microsoft Windows OLE Package Manager Code Execution",
  "fullname": "exploit/windows/fileformat/ms14_060_sandworm",
  "aliases": [

  ],
  "rank": 600,
  "disclosure_date": "2014-10-14",
  "type": "exploit",
  "author": [
    "Unknown",
    "sinn3r <sinn3r@metasploit.com>",
    "juan vazquez <juan.vazquez@metasploit.com>"
  ],
  "description": "This module exploits a vulnerability found in Windows Object Linking and Embedding (OLE)\n        allowing arbitrary code execution, publicly known as \"Sandworm\". Platforms such as Windows\n        Vista SP2 all the way to Windows 8, Windows Server 2008 and 2012 are known to be\n        vulnerable. However, based on our testing, the most reliable setup is on Windows platforms\n        running Office 2013 and Office 2010 SP2. And please keep in mind that some other setups such\n        as using Office 2010 SP1 might be less stable, and sometimes may end up with a crash due to\n        a failure in the CPackage::CreateTempFileName function.\n\n        This module will generate three files: an INF, a GIF, and a PPSX file. You are required to\n        set up a SMB or Samba 3 server and host the INF and GIF there. Systems such as Ubuntu or an\n        older version of Windows (such as XP) work best for this because they require little\n        configuration to get going. The PPSX file is what you should send to your target.\n\n        In detail, the vulnerability has to do with how the Object Packager 2 component\n        (packager.dll) handles an INF file that contains malicious registry changes, which may be\n        leveraged for code execution. First of all, Packager does not load the INF file directly.\n        As an attacker, you can trick it to load your INF anyway by embedding the file path as\n        a remote share in an OLE object. The packager will then treat it as a type of media file,\n        and load it with the packager!CPackage::OLE2MPlayerReadFromStream function, which will\n        download it with a CopyFileW call, save it in a temp folder, and pass that information for\n        later. The exploit will do this loading process twice: first for a fake gif file that's\n        actually the payload, and the second for the INF file.\n\n        The packager will also look at each OLE object's XML Presentation Command, specifically the\n        type and cmd property. In the exploit, \"verb\" media command type is used, and this triggers\n        the packager!CPackage::DoVerb function. Also, \"-3\" is used as the fake gif file's cmd\n        property, and \"3\" is used for the INF. When the cmd is \"-3\", DoVerb will bail. But when \"3\"\n        is used (again, for the INF file), it will cause the packager to try to find appropriate\n        handler for it, which will end up with C:\\Windows\\System32\\infDefaultInstall.exe, and that\n        will install/run the malicious INF file, and finally give us arbitrary code execution.",
  "references": [
    "https://cvedetails.com/cve/CVE-2014-4114/",
    "OSVDB (113140)",
    "https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2014/MS14-060",
    "http://www.securityfocus.com/bid/70419",
    "http://www.isightpartners.com/2014/10/cve-2014-4114/",
    "http://blog.trendmicro.com/trendlabs-security-intelligence/an-analysis-of-windows-zero-day-vulnerability-cve-2014-4114-aka-sandworm/"
  ],
  "platform": "Windows",
  "arch": "x86",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Windows 7 SP1 / Office 2010 SP2 / Office 2013"
  ],
  "path": "/modules/exploits/windows/fileformat/ms14_060_sandworm.rb",
  "ref_name": "windows/fileformat/ms14_060_sandworm",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
    "AKA": [
      "sandworm"
    ]
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "string",
      "name": "FILENAME",
      "required": true,
      "default": "msf.ppsx",
      "aliases": [

      ],
      "advanced": false,
      "description": "The PPSX file"
    },
    {
      "type": "bool",
      "name": "EXE::EICAR",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Generate an EICAR file instead of regular payload exe"
    },
    {
      "type": "path",
      "name": "EXE::Custom",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use custom exe instead of automatically generating a payload exe"
    },
    {
      "type": "path",
      "name": "EXE::Path",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The directory in which to look for the executable template"
    },
    {
      "type": "path",
      "name": "EXE::Template",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The executable template file name."
    },
    {
      "type": "bool",
      "name": "EXE::Inject",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Set to preserve the original EXE function"
    },
    {
      "type": "bool",
      "name": "EXE::OldMethod",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Set to use the substitution EXE generation method."
    },
    {
      "type": "bool",
      "name": "EXE::FallBack",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use the default template in case the specified one is missing"
    },
    {
      "type": "bool",
      "name": "MSI::EICAR",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Generate an EICAR file instead of regular payload msi"
    },
    {
      "type": "path",
      "name": "MSI::Custom",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use custom msi instead of automatically generating a payload msi"
    },
    {
      "type": "path",
      "name": "MSI::Path",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The directory in which to look for the msi template"
    },
    {
      "type": "path",
      "name": "MSI::Template",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The msi template file name"
    },
    {
      "type": "bool",
      "name": "MSI::UAC",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Create an MSI with a UAC prompt (elevation to SYSTEM if accepted)"
    },
    {
      "type": "string",
      "name": "UNCPATH",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The UNC folder to use (Ex: \\\\192.168.1.1\\share)"
    }
  ]
}