{
  "name": "MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+",
  "fullname": "exploit/windows/smb/ms17_010_eternalblue_win8",
  "aliases": [

  ],
  "rank": 200,
  "disclosure_date": "2017-03-14",
  "type": "exploit",
  "author": [
    "Equation Group",
    "Shadow Brokers",
    "sleepya",
    "wvu <wvu@metasploit.com>"
  ],
  "description": "EternalBlue exploit for Windows 8, Windows 10, and 2012 by sleepya\n        The exploit might FAIL and CRASH a target system (depended on what is overwritten)\n        The exploit support only x64 target\n\n        Tested on:\n        - Windows 2012 R2 x64\n        - Windows 8.1 x64\n        - Windows 10 Pro Build 10240 x64\n        - Windows 10 Enterprise Evaluation Build 10586 x64\n\n\n        Default Windows 8 and later installation without additional service info:\n        - anonymous is not allowed to access any share (including IPC$)\n          - More info: https://support.microsoft.com/en-us/help/3034016/ipc-share-and-null-session-behavior-in-windows\n        - tcp port 445 is filtered by firewall\n\n\n        Reference:\n        - http://blogs.360.cn/360safe/2017/04/17/nsa-eternalblue-smb/\n        - \"Bypassing Windows 10 kernel ASLR (remote) by Stefan Le Berre\" https://drive.google.com/file/d/0B3P18M-shbwrNWZTa181ZWRCclk/edit\n\n\n        Exploit info:\n        - If you do not know how exploit for Windows 7/2008 work. Please read my exploit for Windows 7/2008 at\n            https://gist.github.com/worawit/bd04bad3cd231474763b873df081c09a because the trick for exploit is almost the same\n        - The exploit use heap of HAL for placing fake struct (address 0xffffffffffd00e00) and shellcode (address 0xffffffffffd01000).\n            On Windows 8 and Wndows 2012, the NX bit is set on this memory page. Need to disable it before controlling RIP.\n        - The exploit is likely to crash a target when it failed\n        - The overflow is happened on nonpaged pool so we need to massage target nonpaged pool.\n        - If exploit failed but target does not crash, try increasing 'GroomAllocations' value (at least 5)\n        - See the code and comment for exploit detail.\n\n\n        Disable NX method:\n        - The idea is from \"Bypassing Windows 10 kernel ASLR (remote) by Stefan Le Berre\" (see link in reference)\n        - The exploit is also the same but we need to trigger bug twice\n        - First trigger, set MDL.MappedSystemVa to target pte address\n        - Write '\\x00' to disable the NX flag\n        - Second trigger, do the same as Windows 7 exploit\n        - From my test, if exploit disable NX successfully, I always get code execution",
  "references": [
    "https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010",
    "https://cvedetails.com/cve/CVE-2017-0143/",
    "https://cvedetails.com/cve/CVE-2017-0144/",
    "https://cvedetails.com/cve/CVE-2017-0145/",
    "https://cvedetails.com/cve/CVE-2017-0146/",
    "https://cvedetails.com/cve/CVE-2017-0147/",
    "https://cvedetails.com/cve/CVE-2017-0148/",
    "https://www.exploit-db.com/exploits/42030",
    "https://github.com/worawit/MS17-010"
  ],
  "platform": "Windows",
  "arch": "x64",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "win x64"
  ],
  "path": "/modules/exploits/windows/smb/ms17_010_eternalblue_win8.py",
  "ref_name": "windows/smb/ms17_010_eternalblue_win8",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
    "AKA": [
      "ETERNALBLUE"
    ]
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "integer",
      "name": "GroomAllocations",
      "required": true,
      "default": 13,
      "aliases": [

      ],
      "advanced": false,
      "description": "Initial number of times to groom the kernel pool."
    },
    {
      "type": "string",
      "name": "SMBUser",
      "required": false,
      "default": "",
      "aliases": [

      ],
      "advanced": false,
      "description": "(Optional) The username to authenticate as"
    },
    {
      "type": "port",
      "name": "RPORT",
      "required": true,
      "default": 445,
      "aliases": [

      ],
      "advanced": false,
      "description": "Target server port"
    },
    {
      "type": "string",
      "name": "ProcessName",
      "required": false,
      "default": "spoolsv.exe",
      "aliases": [

      ],
      "advanced": false,
      "description": "Process to inject payload into."
    },
    {
      "type": "address",
      "name": "RHOST",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "Target server"
    },
    {
      "type": "string",
      "name": "SMBPass",
      "required": false,
      "default": "",
      "aliases": [

      ],
      "advanced": false,
      "description": "(Optional) The password for the specified username"
    }
  ]
}