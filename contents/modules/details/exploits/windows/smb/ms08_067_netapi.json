{
  "name": "MS08-067 Microsoft Server Service Relative Path Stack Corruption",
  "fullname": "exploit/windows/smb/ms08_067_netapi",
  "aliases": [

  ],
  "rank": 500,
  "disclosure_date": "2008-10-28",
  "type": "exploit",
  "author": [
    "hdm <x@hdm.io>",
    "Brett Moore <brett.moore@insomniasec.com>",
    "frank2 <frank2@dc949.org>",
    "jduck <jduck@metasploit.com>"
  ],
  "description": "This module exploits a parsing flaw in the path canonicalization code of\n        NetAPI32.dll through the Server Service. This module is capable of bypassing\n        NX on some operating systems and service packs. The correct target must be\n        used to prevent the Server Service (along with a dozen others in the same\n        process) from crashing. Windows XP targets seem to handle multiple successful\n        exploitation events, but 2003 targets will often crash or hang on subsequent\n        attempts. This is just the first version of this module, full support for\n        NX bypass on 2003, along with other platforms, is still in development.",
  "references": [
    "https://cvedetails.com/cve/CVE-2008-4250/",
    "OSVDB (49243)",
    "https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2008/MS08-067",
    "http://www.rapid7.com/vulndb/lookup/dcerpc-ms-netapi-netpathcanonicalize-dos"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [
    139,
    445
  ],
  "autofilter_services": [
    "netbios-ssn",
    "microsoft-ds"
  ],
  "targets": [
    "Automatic Targeting",
    "Windows 2000 Universal",
    "Windows XP SP0/SP1 Universal",
    "Windows 2003 SP0 Universal",
    "Windows XP SP2 English (AlwaysOn NX)",
    "Windows XP SP2 English (NX)",
    "Windows XP SP3 English (AlwaysOn NX)",
    "Windows XP SP3 English (NX)",
    "Windows XP SP2 Arabic (NX)",
    "Windows XP SP2 Chinese - Traditional / Taiwan (NX)",
    "Windows XP SP2 Chinese - Simplified (NX)",
    "Windows XP SP2 Chinese - Traditional (NX)",
    "Windows XP SP2 Czech (NX)",
    "Windows XP SP2 Danish (NX)",
    "Windows XP SP2 German (NX)",
    "Windows XP SP2 Greek (NX)",
    "Windows XP SP2 Spanish (NX)",
    "Windows XP SP2 Finnish (NX)",
    "Windows XP SP2 French (NX)",
    "Windows XP SP2 Hebrew (NX)",
    "Windows XP SP2 Hungarian (NX)",
    "Windows XP SP2 Italian (NX)",
    "Windows XP SP2 Japanese (NX)",
    "Windows XP SP2 Korean (NX)",
    "Windows XP SP2 Dutch (NX)",
    "Windows XP SP2 Norwegian (NX)",
    "Windows XP SP2 Polish (NX)",
    "Windows XP SP2 Portuguese - Brazilian (NX)",
    "Windows XP SP2 Portuguese (NX)",
    "Windows XP SP2 Russian (NX)",
    "Windows XP SP2 Swedish (NX)",
    "Windows XP SP2 Turkish (NX)",
    "Windows XP SP3 Arabic (NX)",
    "Windows XP SP3 Chinese - Traditional / Taiwan (NX)",
    "Windows XP SP3 Chinese - Simplified (NX)",
    "Windows XP SP3 Chinese - Traditional (NX)",
    "Windows XP SP3 Czech (NX)",
    "Windows XP SP3 Danish (NX)",
    "Windows XP SP3 German (NX)",
    "Windows XP SP3 Greek (NX)",
    "Windows XP SP3 Spanish (NX)",
    "Windows XP SP3 Finnish (NX)",
    "Windows XP SP3 French (NX)",
    "Windows XP SP3 Hebrew (NX)",
    "Windows XP SP3 Hungarian (NX)",
    "Windows XP SP3 Italian (NX)",
    "Windows XP SP3 Japanese (NX)",
    "Windows XP SP3 Korean (NX)",
    "Windows XP SP3 Dutch (NX)",
    "Windows XP SP3 Norwegian (NX)",
    "Windows XP SP3 Polish (NX)",
    "Windows XP SP3 Portuguese - Brazilian (NX)",
    "Windows XP SP3 Portuguese (NX)",
    "Windows XP SP3 Russian (NX)",
    "Windows XP SP3 Swedish (NX)",
    "Windows XP SP3 Turkish (NX)",
    "Windows 2003 SP1 English (NO NX)",
    "Windows 2003 SP1 English (NX)",
    "Windows 2003 SP1 Japanese (NO NX)",
    "Windows 2003 SP1 Spanish (NO NX)",
    "Windows 2003 SP1 Spanish (NX)",
    "Windows 2003 SP1 French (NO NX)",
    "Windows 2003 SP1 French (NX)",
    "Windows 2003 SP2 English (NO NX)",
    "Windows 2003 SP2 English (NX)",
    "Windows 2003 SP2 German (NO NX)",
    "Windows 2003 SP2 German (NX)",
    "Windows 2003 SP2 Portuguese - Brazilian (NX)",
    "Windows 2003 SP2 Spanish (NO NX)",
    "Windows 2003 SP2 Spanish (NX)",
    "Windows 2003 SP2 Japanese (NO NX)",
    "Windows 2003 SP2 French (NO NX)",
    "Windows 2003 SP2 French (NX)"
  ],
  "path": "/modules/exploits/windows/smb/ms08_067_netapi.rb",
  "ref_name": "windows/smb/ms08_067_netapi",
  "check": true,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "addressrange",
      "name": "RHOSTS",
      "required": true,
      "default": null,
      "aliases": [
        "RHOST"
      ],
      "advanced": false,
      "description": "The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'"
    },
    {
      "type": "port",
      "name": "RPORT",
      "required": true,
      "default": 445,
      "aliases": [

      ],
      "advanced": false,
      "description": "The SMB service port"
    },
    {
      "type": "bool",
      "name": "SSL",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Negotiate SSL/TLS for outgoing connections"
    },
    {
      "type": "enum",
      "name": "SSLVersion",
      "required": true,
      "default": "Auto",
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the version of SSL/TLS to be used (Auto, TLS and SSL23 are auto-negotiate) (Accepted: Auto, TLS, SSL23, SSL3, TLS1, TLS1.1, TLS1.2)"
    },
    {
      "type": "enum",
      "name": "SSLVerifyMode",
      "required": false,
      "default": "PEER",
      "aliases": [

      ],
      "advanced": true,
      "description": "SSL verification method (Accepted: CLIENT_ONCE, FAIL_IF_NO_PEER_CERT, NONE, PEER)"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "string",
      "name": "Proxies",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "A proxy chain of format type:host:port[,type:host:port][...]"
    },
    {
      "type": "port",
      "name": "CPORT",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client port"
    },
    {
      "type": "address",
      "name": "CHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client address"
    },
    {
      "type": "integer",
      "name": "ConnectTimeout",
      "required": true,
      "default": 10,
      "aliases": [

      ],
      "advanced": true,
      "description": "Maximum number of seconds to establish a TCP connection"
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maxiumum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "DCERPC::max_frag_size",
      "required": true,
      "default": 4096,
      "aliases": [

      ],
      "advanced": false,
      "description": "Set the DCERPC packet fragmentation size"
    },
    {
      "type": "bool",
      "name": "DCERPC::fake_bind_multi",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Use multi-context bind calls"
    },
    {
      "type": "integer",
      "name": "DCERPC::fake_bind_multi_prepend",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Set the number of UUIDs to prepend before the target"
    },
    {
      "type": "integer",
      "name": "DCERPC::fake_bind_multi_append",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Set the number of UUIDs to append the target"
    },
    {
      "type": "enum",
      "name": "DCERPC::smb_pipeio",
      "required": false,
      "default": "rw",
      "aliases": [

      ],
      "advanced": false,
      "description": "Use a different delivery method for accessing named pipes (Accepted: rw, trans)"
    },
    {
      "type": "integer",
      "name": "DCERPC::ReadTimeout",
      "required": true,
      "default": 10,
      "aliases": [

      ],
      "advanced": true,
      "description": "The number of seconds to wait for DCERPC responses"
    },
    {
      "type": "bool",
      "name": "NTLM::UseNTLMv2",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use NTLMv2 instead of NTLM2_session when 'Negotiate NTLM2' key is true"
    },
    {
      "type": "bool",
      "name": "NTLM::UseNTLM2_session",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Activate the 'Negotiate NTLM2 key' flag, forcing the use of a NTLMv2_session"
    },
    {
      "type": "bool",
      "name": "NTLM::SendLM",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Always send the LANMAN response (except when NTLMv2_session is specified)"
    },
    {
      "type": "bool",
      "name": "NTLM::UseLMKey",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Activate the 'Negotiate Lan Manager Key' flag, using the LM key when the LM response is sent"
    },
    {
      "type": "bool",
      "name": "NTLM::SendNTLM",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Activate the 'Negotiate NTLM key' flag, indicating the use of NTLM responses"
    },
    {
      "type": "bool",
      "name": "NTLM::SendSPN",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Send an avp of type SPN in the ntlmv2 client blob, this allows authentication on Windows 7+/Server 2008 R2+ when SPN is required"
    },
    {
      "type": "bool",
      "name": "SMB::pipe_evasion",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Enable segmented read/writes for SMB Pipes"
    },
    {
      "type": "integer",
      "name": "SMB::pipe_write_min_size",
      "required": true,
      "default": 1,
      "aliases": [

      ],
      "advanced": false,
      "description": "Minimum buffer size for pipe writes"
    },
    {
      "type": "integer",
      "name": "SMB::pipe_write_max_size",
      "required": true,
      "default": 1024,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maximum buffer size for pipe writes"
    },
    {
      "type": "integer",
      "name": "SMB::pipe_read_min_size",
      "required": true,
      "default": 1,
      "aliases": [

      ],
      "advanced": false,
      "description": "Minimum buffer size for pipe reads"
    },
    {
      "type": "integer",
      "name": "SMB::pipe_read_max_size",
      "required": true,
      "default": 1024,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maximum buffer size for pipe reads"
    },
    {
      "type": "integer",
      "name": "SMB::pad_data_level",
      "required": true,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Place extra padding between headers and data (level 0-3)"
    },
    {
      "type": "integer",
      "name": "SMB::pad_file_level",
      "required": true,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Obscure path names used in open/create (level 0-3)"
    },
    {
      "type": "integer",
      "name": "SMB::obscure_trans_pipe_level",
      "required": true,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Obscure PIPE string in TransNamedPipe (level 0-3)"
    },
    {
      "type": "bool",
      "name": "SMBDirect",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "The target port is a raw SMB service (not NetBIOS)"
    },
    {
      "type": "string",
      "name": "SMBUser",
      "required": false,
      "default": "",
      "aliases": [

      ],
      "advanced": true,
      "description": "The username to authenticate as"
    },
    {
      "type": "string",
      "name": "SMBPass",
      "required": false,
      "default": "",
      "aliases": [

      ],
      "advanced": true,
      "description": "The password for the specified username"
    },
    {
      "type": "string",
      "name": "SMBDomain",
      "required": false,
      "default": ".",
      "aliases": [

      ],
      "advanced": true,
      "description": "The Windows domain to use for authentication"
    },
    {
      "type": "string",
      "name": "SMBName",
      "required": true,
      "default": "*SMBSERVER",
      "aliases": [

      ],
      "advanced": true,
      "description": "The NetBIOS hostname (required for port 139 connections)"
    },
    {
      "type": "bool",
      "name": "SMB::VerifySignature",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enforces client-side verification of server response signatures"
    },
    {
      "type": "integer",
      "name": "SMB::ChunkSize",
      "required": true,
      "default": 500,
      "aliases": [

      ],
      "advanced": true,
      "description": "The chunk size for SMB segments, bigger values will increase speed but break NT 4.0 and SMB signing"
    },
    {
      "type": "string",
      "name": "SMB::Native_OS",
      "required": true,
      "default": "Windows 2000 2195",
      "aliases": [

      ],
      "advanced": true,
      "description": "The Native OS to send during authentication"
    },
    {
      "type": "string",
      "name": "SMB::Native_LM",
      "required": true,
      "default": "Windows 2000 5.0",
      "aliases": [

      ],
      "advanced": true,
      "description": "The Native LM to send during authentication"
    },
    {
      "type": "string",
      "name": "SMBPIPE",
      "required": true,
      "default": "BROWSER",
      "aliases": [

      ],
      "advanced": false,
      "description": "The pipe name to use (BROWSER, SRVSVC)"
    }
  ]
}