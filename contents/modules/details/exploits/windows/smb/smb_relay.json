{
  "name": "MS08-068 Microsoft Windows SMB Relay Code Execution",
  "fullname": "exploit/windows/smb/smb_relay",
  "aliases": [

  ],
  "rank": 600,
  "disclosure_date": "2001-03-31",
  "type": "exploit",
  "author": [
    "hdm <x@hdm.io>",
    "juan vazquez <juan.vazquez@metasploit.com>"
  ],
  "description": "This module will relay SMB authentication requests to another\n        host, gaining access to an authenticated SMB session if successful.\n        If the connecting user is an administrator and network logins are\n        allowed to the target machine, this module will execute an arbitrary\n        payload. To exploit this, the target system\tmust try to\tauthenticate\n        to this module. The easiest way to force a SMB authentication attempt\n        is by embedding a UNC path (\\\\SERVER\\SHARE) into a web page or\n        email message. When the victim views the web page or email, their\n        system will automatically connect to the server specified in the UNC\n        share (the IP address of the system running this module) and attempt\n        to authenticate.  Unfortunately, this\n        module is not able to clean up after itself. The service and payload\n        file listed in the output will need to be manually removed after access\n        has been gained. The service created by this tool uses a randomly chosen\n        name and description, so the services list can become cluttered after\n        repeated exploitation.\n\n        The SMB authentication relay attack was first reported by Sir Dystic on\n        March 31st, 2001 at @lanta.con in Atlanta, Georgia.\n\n        On November 11th 2008 Microsoft released bulletin MS08-068. This bulletin\n        includes a patch which prevents the relaying of challenge keys back to\n        the host which issued them, preventing this exploit from working in\n        the default configuration. It is still possible to set the SMBHOST\n        parameter to a third-party host that the victim is authorized to access,\n        but the \"reflection\" attack has been effectively broken.",
  "references": [
    "https://cvedetails.com/cve/CVE-2008-4037/",
    "OSVDB (49736)",
    "https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2008/MS08-068",
    "http://blogs.technet.com/swi/archive/2008/11/11/smb-credential-reflection.aspx",
    "http://en.wikipedia.org/wiki/SMBRelay",
    "http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx"
  ],
  "platform": "Windows",
  "arch": "x86, x64",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Automatic"
  ],
  "path": "/modules/exploits/windows/smb/smb_relay.rb",
  "ref_name": "windows/smb/smb_relay",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "address",
      "name": "SRVHOST",
      "required": true,
      "default": "0.0.0.0",
      "aliases": [

      ],
      "advanced": false,
      "description": "The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses."
    },
    {
      "type": "port",
      "name": "SRVPORT",
      "required": true,
      "default": 445,
      "aliases": [

      ],
      "advanced": false,
      "description": "The local port to listen on."
    },
    {
      "type": "string",
      "name": "ListenerComm",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The specific communication channel to use for this service"
    },
    {
      "type": "bool",
      "name": "SSLCompression",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable SSL/TLS-level compression"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher spec - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maximum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "SMBServerMaximumBuffer",
      "required": true,
      "default": 2,
      "aliases": [

      ],
      "advanced": true,
      "description": "The maximum number of data in megabytes to buffer"
    },
    {
      "type": "integer",
      "name": "SMBServerIdleTimeout",
      "required": true,
      "default": 120,
      "aliases": [

      ],
      "advanced": true,
      "description": "The maximum amount of time to keep an idle session open in seconds"
    },
    {
      "type": "bool",
      "name": "EXE::EICAR",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Generate an EICAR file instead of regular payload exe"
    },
    {
      "type": "path",
      "name": "EXE::Custom",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use custom exe instead of automatically generating a payload exe"
    },
    {
      "type": "path",
      "name": "EXE::Path",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The directory in which to look for the executable template"
    },
    {
      "type": "path",
      "name": "EXE::Template",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The executable template file name."
    },
    {
      "type": "bool",
      "name": "EXE::Inject",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Set to preserve the original EXE function"
    },
    {
      "type": "bool",
      "name": "EXE::OldMethod",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Set to use the substitution EXE generation method."
    },
    {
      "type": "bool",
      "name": "EXE::FallBack",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use the default template in case the specified one is missing"
    },
    {
      "type": "bool",
      "name": "MSI::EICAR",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Generate an EICAR file instead of regular payload msi"
    },
    {
      "type": "path",
      "name": "MSI::Custom",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use custom msi instead of automatically generating a payload msi"
    },
    {
      "type": "path",
      "name": "MSI::Path",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The directory in which to look for the msi template"
    },
    {
      "type": "path",
      "name": "MSI::Template",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The msi template file name"
    },
    {
      "type": "bool",
      "name": "MSI::UAC",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Create an MSI with a UAC prompt (elevation to SYSTEM if accepted)"
    },
    {
      "type": "address",
      "name": "SMBHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The target SMB server (leave empty for originating system)"
    },
    {
      "type": "string",
      "name": "SHARE",
      "required": true,
      "default": "ADMIN$",
      "aliases": [

      ],
      "advanced": false,
      "description": "The share to connect to"
    }
  ]
}