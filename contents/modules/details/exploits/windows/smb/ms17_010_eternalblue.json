{
  "name": "MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption",
  "fullname": "exploit/windows/smb/ms17_010_eternalblue",
  "aliases": [

  ],
  "rank": 200,
  "disclosure_date": "2017-03-14",
  "type": "exploit",
  "author": [
    "Sean Dillon <sean.dillon@risksense.com>",
    "Dylan Davis <dylan.davis@risksense.com>",
    "Equation Group",
    "Shadow Brokers",
    "thelightcosine"
  ],
  "description": "This module is a port of the Equation Group ETERNALBLUE exploit, part of\n          the FuzzBunch toolkit released by Shadow Brokers.\n\n          There is a buffer overflow memmove operation in Srv!SrvOs2FeaToNt. The size\n          is calculated in Srv!SrvOs2FeaListSizeToNt, with mathematical error where a\n          DWORD is subtracted into a WORD. The kernel pool is groomed so that overflow\n          is well laid-out to overwrite an SMBv1 buffer. Actual RIP hijack is later\n          completed in srvnet!SrvNetWskReceiveComplete.\n\n          This exploit, like the original may not trigger 100% of the time, and should be\n          run continuously until triggered. It seems like the pool will get hot streaks\n          and need a cool down period before the shells rain in again.\n\n          The module will attempt to use Anonymous login, by default, to authenticate to perform the\n          exploit. If the user supplies credentials in the SMBUser, SMBPass, and SMBDomain options it will use\n          those instead.\n\n          On some systems, this module may cause system instability and crashes, such as a BSOD or\n          a reboot. This may be more likely with some payloads.",
  "references": [
    "https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010",
    "https://cvedetails.com/cve/CVE-2017-0143/",
    "https://cvedetails.com/cve/CVE-2017-0144/",
    "https://cvedetails.com/cve/CVE-2017-0145/",
    "https://cvedetails.com/cve/CVE-2017-0146/",
    "https://cvedetails.com/cve/CVE-2017-0147/",
    "https://cvedetails.com/cve/CVE-2017-0148/",
    "https://github.com/RiskSense-Ops/MS17-010"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "Windows 7 and Server 2008 R2 (x64) All Service Packs"
  ],
  "path": "/modules/exploits/windows/smb/ms17_010_eternalblue.rb",
  "ref_name": "windows/smb/ms17_010_eternalblue",
  "check": true,
  "post_auth": false,
  "default_credential": false,
  "notes": {
    "AKA": [
      "ETERNALBLUE"
    ]
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "addressrange",
      "name": "RHOSTS",
      "required": true,
      "default": null,
      "aliases": [
        "RHOST"
      ],
      "advanced": false,
      "description": "The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'"
    },
    {
      "type": "port",
      "name": "RPORT",
      "required": true,
      "default": 445,
      "aliases": [

      ],
      "advanced": false,
      "description": "The target port"
    },
    {
      "type": "bool",
      "name": "SSL",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Negotiate SSL/TLS for outgoing connections"
    },
    {
      "type": "enum",
      "name": "SSLVersion",
      "required": true,
      "default": "Auto",
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the version of SSL/TLS to be used (Auto, TLS and SSL23 are auto-negotiate) (Accepted: Auto, TLS, SSL23, SSL3, TLS1, TLS1.1, TLS1.2)"
    },
    {
      "type": "enum",
      "name": "SSLVerifyMode",
      "required": false,
      "default": "PEER",
      "aliases": [

      ],
      "advanced": true,
      "description": "SSL verification method (Accepted: CLIENT_ONCE, FAIL_IF_NO_PEER_CERT, NONE, PEER)"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "string",
      "name": "Proxies",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "A proxy chain of format type:host:port[,type:host:port][...]"
    },
    {
      "type": "port",
      "name": "CPORT",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client port"
    },
    {
      "type": "address",
      "name": "CHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client address"
    },
    {
      "type": "integer",
      "name": "ConnectTimeout",
      "required": true,
      "default": 10,
      "aliases": [

      ],
      "advanced": true,
      "description": "Maximum number of seconds to establish a TCP connection"
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maxiumum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "DCERPC::max_frag_size",
      "required": true,
      "default": 4096,
      "aliases": [

      ],
      "advanced": false,
      "description": "Set the DCERPC packet fragmentation size"
    },
    {
      "type": "bool",
      "name": "DCERPC::fake_bind_multi",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Use multi-context bind calls"
    },
    {
      "type": "integer",
      "name": "DCERPC::fake_bind_multi_prepend",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Set the number of UUIDs to prepend before the target"
    },
    {
      "type": "integer",
      "name": "DCERPC::fake_bind_multi_append",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Set the number of UUIDs to append the target"
    },
    {
      "type": "enum",
      "name": "DCERPC::smb_pipeio",
      "required": false,
      "default": "rw",
      "aliases": [

      ],
      "advanced": false,
      "description": "Use a different delivery method for accessing named pipes (Accepted: rw, trans)"
    },
    {
      "type": "integer",
      "name": "DCERPC::ReadTimeout",
      "required": true,
      "default": 10,
      "aliases": [

      ],
      "advanced": true,
      "description": "The number of seconds to wait for DCERPC responses"
    },
    {
      "type": "string",
      "name": "CheckModule",
      "required": true,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Module to check with"
    },
    {
      "type": "bool",
      "name": "VERIFY_TARGET",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Check if remote OS matches exploit Target."
    },
    {
      "type": "bool",
      "name": "VERIFY_ARCH",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Check if remote architecture matches exploit Target."
    },
    {
      "type": "string",
      "name": "SMBUser",
      "required": false,
      "default": "",
      "aliases": [

      ],
      "advanced": false,
      "description": "(Optional) The username to authenticate as"
    },
    {
      "type": "string",
      "name": "SMBPass",
      "required": false,
      "default": "",
      "aliases": [

      ],
      "advanced": false,
      "description": "(Optional) The password for the specified username"
    },
    {
      "type": "string",
      "name": "SMBDomain",
      "required": false,
      "default": ".",
      "aliases": [

      ],
      "advanced": false,
      "description": "(Optional) The Windows domain to use for authentication"
    },
    {
      "type": "bool",
      "name": "ForceExploit",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Override check result"
    },
    {
      "type": "string",
      "name": "ProcessName",
      "required": true,
      "default": "spoolsv.exe",
      "aliases": [

      ],
      "advanced": true,
      "description": "Process to inject payload into."
    },
    {
      "type": "integer",
      "name": "MaxExploitAttempts",
      "required": true,
      "default": 3,
      "aliases": [

      ],
      "advanced": true,
      "description": "The number of times to retry the exploit."
    },
    {
      "type": "integer",
      "name": "GroomAllocations",
      "required": true,
      "default": 12,
      "aliases": [

      ],
      "advanced": true,
      "description": "Initial number of times to groom the kernel pool."
    },
    {
      "type": "integer",
      "name": "GroomDelta",
      "required": true,
      "default": 5,
      "aliases": [

      ],
      "advanced": true,
      "description": "The amount to increase the groom count by per try."
    }
  ]
}