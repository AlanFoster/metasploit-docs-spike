{
  "name": "MS09-004 Microsoft SQL Server sp_replwritetovarbin Memory Corruption",
  "fullname": "exploit/windows/mssql/ms09_004_sp_replwritetovarbin",
  "aliases": [

  ],
  "rank": 400,
  "disclosure_date": "2008-12-09",
  "type": "exploit",
  "author": [
    "jduck <jduck@metasploit.com>"
  ],
  "description": "A heap-based buffer overflow can occur when calling the undocumented\n        \"sp_replwritetovarbin\" extended stored procedure. This vulnerability affects\n        all versions of Microsoft SQL Server 2000 and 2005, Windows Internal Database,\n        and Microsoft Desktop Engine (MSDE) without the updates supplied in MS09-004.\n        Microsoft patched this vulnerability in SP3 for 2005 without any public\n        mention.\n\n        An authenticated database session is required to access the vulnerable code.\n        That said, it is possible to access the vulnerable code via an SQL injection\n        vulnerability.\n\n        This exploit smashes several pointers, as shown below.\n\n        1. pointer to a 32-bit value that is set to 0\n        2. pointer to a 32-bit value that is set to a length influenced by the buffer\n          length.\n        3. pointer to a 32-bit value that is used as a vtable pointer. In MSSQL 2000,\n          this value is referenced with a displacement of 0x38. For MSSQL 2005, the\n          displacement is 0x10. The address of our buffer is conveniently stored in\n          ecx when this instruction is executed.\n        4. On MSSQL 2005, an additional vtable ptr is smashed, which is referenced with\n          a displacement of 4. This pointer is not used by this exploit.\n\n        This particular exploit replaces the previous dual-method exploit. It uses\n        a technique where the value contained in ecx becomes the stack. From there,\n        return oriented programming is used to normalize the execution state and\n        finally execute the payload via a \"jmp esp\". All addresses used were found\n        within the sqlservr.exe memory space, yielding very reliable code execution\n        using only a single query.\n\n        NOTE: The MSSQL server service does not automatically restart by default. That\n        said, some exceptions are caught and will not result in terminating the process.\n        If the exploit crashes the service prior to hijacking the stack, it won't die.\n        Otherwise, it's a goner.",
  "references": [
    "OSVDB (50589)",
    "https://cvedetails.com/cve/CVE-2008-5416/",
    "http://www.securityfocus.com/bid/32710",
    "https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2009/MS09-004",
    "https://www.exploit-db.com/exploits/7501"
  ],
  "platform": "Windows",
  "arch": "",
  "autofilter_ports": [
    1433,
    1434,
    1435,
    14330,
    2533,
    9152,
    2638
  ],
  "autofilter_services": [
    "ms-sql-s",
    "ms-sql2000",
    "sybase"
  ],
  "targets": [
    "Automatic",
    "MSSQL 2000 / MSDE SP0 (8.00.194)",
    "MSSQL 2000 / MSDE SP1 (8.00.384)",
    "MSSQL 2000 / MSDE SP2 (8.00.534)",
    "MSSQL 2000 / MSDE SP3 (8.00.760)",
    "MSSQL 2000 / MSDE SP4 (8.00.2039)",
    "MSSQL 2005 SP0 (9.00.1399.06)",
    "MSSQL 2005 SP1 (9.00.2047.00)",
    "MSSQL 2005 SP2 (9.00.3042.00)",
    "CRASHER"
  ],
  "path": "/modules/exploits/windows/mssql/ms09_004_sp_replwritetovarbin.rb",
  "ref_name": "windows/mssql/ms09_004_sp_replwritetovarbin",
  "check": true,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "addressrange",
      "name": "RHOSTS",
      "required": true,
      "default": null,
      "aliases": [
        "RHOST"
      ],
      "advanced": false,
      "description": "The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'"
    },
    {
      "type": "port",
      "name": "RPORT",
      "required": true,
      "default": 1433,
      "aliases": [

      ],
      "advanced": false,
      "description": "The target port"
    },
    {
      "type": "port",
      "name": "CPORT",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client port"
    },
    {
      "type": "address",
      "name": "CHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client address"
    },
    {
      "type": "bool",
      "name": "SSL",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Negotiate SSL/TLS for outgoing connections"
    },
    {
      "type": "enum",
      "name": "SSLVersion",
      "required": true,
      "default": "Auto",
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the version of SSL/TLS to be used (Auto, TLS and SSL23 are auto-negotiate) (Accepted: Auto, TLS, SSL23, SSL3, TLS1, TLS1.1, TLS1.2)"
    },
    {
      "type": "enum",
      "name": "SSLVerifyMode",
      "required": false,
      "default": "PEER",
      "aliases": [

      ],
      "advanced": true,
      "description": "SSL verification method (Accepted: CLIENT_ONCE, FAIL_IF_NO_PEER_CERT, NONE, PEER)"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "string",
      "name": "Proxies",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "A proxy chain of format type:host:port[,type:host:port][...]"
    },
    {
      "type": "integer",
      "name": "ConnectTimeout",
      "required": true,
      "default": 10,
      "aliases": [

      ],
      "advanced": true,
      "description": "Maximum number of seconds to establish a TCP connection"
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maxiumum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "bool",
      "name": "NTLM::UseNTLMv2",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use NTLMv2 instead of NTLM2_session when 'Negotiate NTLM2' key is true"
    },
    {
      "type": "bool",
      "name": "NTLM::UseNTLM2_session",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Activate the 'Negotiate NTLM2 key' flag, forcing the use of a NTLMv2_session"
    },
    {
      "type": "bool",
      "name": "NTLM::SendLM",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Always send the LANMAN response (except when NTLMv2_session is specified)"
    },
    {
      "type": "bool",
      "name": "NTLM::UseLMKey",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Activate the 'Negotiate Lan Manager Key' flag, using the LM key when the LM response is sent"
    },
    {
      "type": "bool",
      "name": "NTLM::SendNTLM",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Activate the 'Negotiate NTLM key' flag, indicating the use of NTLM responses"
    },
    {
      "type": "bool",
      "name": "NTLM::SendSPN",
      "required": true,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Send an avp of type SPN in the ntlmv2 client blob, this allows authentication on Windows 7+/Server 2008 R2+ when SPN is required"
    },
    {
      "type": "string",
      "name": "USERNAME",
      "required": false,
      "default": "sa",
      "aliases": [

      ],
      "advanced": false,
      "description": "The username to authenticate as"
    },
    {
      "type": "string",
      "name": "PASSWORD",
      "required": false,
      "default": "",
      "aliases": [

      ],
      "advanced": false,
      "description": "The password for the specified username"
    },
    {
      "type": "bool",
      "name": "TDSENCRYPTION",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Use TLS/SSL for TDS data \"Force Encryption\""
    },
    {
      "type": "bool",
      "name": "USE_WINDOWS_AUTHENT",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": false,
      "description": "Use windows authentification (requires DOMAIN option set)"
    },
    {
      "type": "path",
      "name": "HEX2BINARY",
      "required": false,
      "default": "/Users/alan/Documents/code/metasploit-framework/data/exploits/mssql/h2b",
      "aliases": [

      ],
      "advanced": true,
      "description": "The path to the hex2binary script on the disk"
    },
    {
      "type": "string",
      "name": "DOMAIN",
      "required": true,
      "default": "WORKSTATION",
      "aliases": [

      ],
      "advanced": true,
      "description": "The domain to use for windows authentication"
    }
  ]
}