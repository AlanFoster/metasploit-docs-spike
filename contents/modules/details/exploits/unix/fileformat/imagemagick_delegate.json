{
  "name": "ImageMagick Delegate Arbitrary Command Execution",
  "fullname": "exploit/unix/fileformat/imagemagick_delegate",
  "aliases": [

  ],
  "rank": 600,
  "disclosure_date": "2016-05-03",
  "type": "exploit",
  "author": [
    "stewie",
    "Nikolay Ermishkin",
    "Tavis Ormandy",
    "wvu <wvu@metasploit.com>",
    "hdm <x@hdm.io>"
  ],
  "description": "This module exploits a shell command injection in the way \"delegates\"\n        (commands for converting files) are processed in ImageMagick versions\n        <= 7.0.1-0 and <= 6.9.3-9 (legacy).\n\n        Since ImageMagick uses file magic to detect file format, you can create\n        a .png (for example) which is actually a crafted SVG (for example) that\n        triggers the command injection.\n\n        The PostScript (PS) target leverages a Ghostscript -dSAFER bypass\n        (discovered by taviso) to achieve RCE in the Ghostscript delegate.\n        Ghostscript versions 9.18 and later are affected. This target is\n        provided as is and will not be updated to track additional vulns.\n\n        If USE_POPEN is set to true, a |-prefixed command will be used for the\n        exploit. No delegates are involved in this exploitation.",
  "references": [
    "https://cvedetails.com/cve/CVE-2016-3714/",
    "https://cvedetails.com/cve/CVE-2016-7976/",
    "https://imagetragick.com/",
    "https://seclists.org/oss-sec/2016/q2/205",
    "https://seclists.org/oss-sec/2016/q3/682",
    "https://github.com/ImageMagick/ImageMagick/commit/06c41ab",
    "https://github.com/ImageMagick/ImageMagick/commit/a347456",
    "http://permalink.gmane.org/gmane.comp.security.oss.general/19669"
  ],
  "platform": "Unix",
  "arch": "cmd",
  "autofilter_ports": [

  ],
  "autofilter_services": [

  ],
  "targets": [
    "SVG file",
    "MVG file",
    "PS file"
  ],
  "path": "/modules/exploits/unix/fileformat/imagemagick_delegate.rb",
  "ref_name": "unix/fileformat/imagemagick_delegate",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
    "AKA": [
      "ImageTragick"
    ],
    "RelatedModules": [
      "exploit/unix/fileformat/ghostscript_type_confusion",
      "exploit/multi/fileformat/ghostscript_failed_restore"
    ]
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "string",
      "name": "FILENAME",
      "required": true,
      "default": "msf.png",
      "aliases": [

      ],
      "advanced": false,
      "description": "Output file"
    },
    {
      "type": "bool",
      "name": "USE_POPEN",
      "required": false,
      "default": true,
      "aliases": [

      ],
      "advanced": false,
      "description": "Use popen() vector"
    }
  ]
}