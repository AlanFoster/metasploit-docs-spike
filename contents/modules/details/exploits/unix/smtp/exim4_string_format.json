{
  "name": "Exim4 string_format Function Heap Buffer Overflow",
  "fullname": "exploit/unix/smtp/exim4_string_format",
  "aliases": [

  ],
  "rank": 600,
  "disclosure_date": "2010-12-07",
  "type": "exploit",
  "author": [
    "jduck <jduck@metasploit.com>",
    "hdm <x@hdm.io>"
  ],
  "description": "This module exploits a heap buffer overflow within versions of Exim prior to\n        version 4.69. By sending a specially crafted message, an attacker can corrupt the\n        heap and execute arbitrary code with the privileges of the Exim daemon.\n\n        The root cause is that no check is made to ensure that the buffer is not full\n        prior to handling '%s' format specifiers within the 'string_vformat' function.\n        In order to trigger this issue, we get our message rejected by sending a message\n        that is too large. This will call into log_write to log rejection headers (which\n        is a default configuration setting). After filling the buffer, a long header\n        string is sent. In a successful attempt, it overwrites the ACL for the 'MAIL\n        FROM' command. By sending a second message, the string we sent will be evaluated\n        with 'expand_string' and arbitrary shell commands can be executed.\n\n        It is likely that this issue could also be exploited using other techniques such\n        as targeting in-band heap management structures, or perhaps even function pointers\n        stored in the heap. However, these techniques would likely be far more platform\n        specific, more complicated, and less reliable.\n\n        This bug was original found and reported in December 2008, but was not\n        properly handled as a security issue. Therefore, there was a 2 year lag time\n        between when the issue was fixed and when it was discovered being exploited\n        in the wild. At that point, the issue was assigned a CVE and began being\n        addressed by downstream vendors.\n\n        An additional vulnerability, CVE-2010-4345, was also used in the attack that\n        led to the discovery of danger of this bug. This bug allows a local user to\n        gain root privileges from the Exim user account. If the Perl interpreter is\n        found on the remote system, this module will automatically exploit the\n        secondary bug as well to get root.",
  "references": [
    "https://cvedetails.com/cve/CVE-2010-4344/",
    "https://cvedetails.com/cve/CVE-2010-4345/",
    "OSVDB (69685)",
    "OSVDB (69860)",
    "http://www.securityfocus.com/bid/45308",
    "http://www.securityfocus.com/bid/45341",
    "https://seclists.org/oss-sec/2010/q4/311",
    "http://www.gossamer-threads.com/lists/exim/dev/89477",
    "http://bugs.exim.org/show_bug.cgi?id=787",
    "http://git.exim.org/exim.git/commitdiff/24c929a27415c7cfc7126c47e4cad39acf3efa6b"
  ],
  "platform": "Unix",
  "arch": "cmd",
  "autofilter_ports": [
    25,
    465,
    587,
    2525,
    25025,
    25000
  ],
  "autofilter_services": [
    "smtp",
    "smtps"
  ],
  "targets": [
    "Automatic"
  ],
  "path": "/modules/exploits/unix/smtp/exim4_string_format.rb",
  "ref_name": "unix/smtp/exim4_string_format",
  "check": false,
  "post_auth": false,
  "default_credential": false,
  "notes": {
  },
  "needs_cleanup": null,
  "options": [
    {
      "type": "string",
      "name": "WORKSPACE",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the workspace for this module"
    },
    {
      "type": "bool",
      "name": "VERBOSE",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Enable detailed status messages"
    },
    {
      "type": "integer",
      "name": "WfsDelay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": true,
      "description": "Additional delay when waiting for a session"
    },
    {
      "type": "bool",
      "name": "EnableContextEncoding",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Use transient context when encoding payloads"
    },
    {
      "type": "path",
      "name": "ContextInformationFile",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The information file that contains context information"
    },
    {
      "type": "bool",
      "name": "DisablePayloadHandler",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Disable the handler code for the selected payload"
    },
    {
      "type": "addressrange",
      "name": "RHOSTS",
      "required": true,
      "default": null,
      "aliases": [
        "RHOST"
      ],
      "advanced": false,
      "description": "The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'"
    },
    {
      "type": "port",
      "name": "RPORT",
      "required": true,
      "default": 25,
      "aliases": [

      ],
      "advanced": false,
      "description": "The target port"
    },
    {
      "type": "bool",
      "name": "SSL",
      "required": false,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Negotiate SSL/TLS for outgoing connections"
    },
    {
      "type": "enum",
      "name": "SSLVersion",
      "required": true,
      "default": "Auto",
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify the version of SSL/TLS to be used (Auto, TLS and SSL23 are auto-negotiate) (Accepted: Auto, TLS, SSL23, SSL3, TLS1, TLS1.1, TLS1.2)"
    },
    {
      "type": "enum",
      "name": "SSLVerifyMode",
      "required": false,
      "default": "PEER",
      "aliases": [

      ],
      "advanced": true,
      "description": "SSL verification method (Accepted: CLIENT_ONCE, FAIL_IF_NO_PEER_CERT, NONE, PEER)"
    },
    {
      "type": "string",
      "name": "SSLCipher",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "String for SSL cipher - \"DHE-RSA-AES256-SHA\" or \"ADH\""
    },
    {
      "type": "string",
      "name": "Proxies",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "A proxy chain of format type:host:port[,type:host:port][...]"
    },
    {
      "type": "port",
      "name": "CPORT",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client port"
    },
    {
      "type": "address",
      "name": "CHOST",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The local client address"
    },
    {
      "type": "integer",
      "name": "ConnectTimeout",
      "required": true,
      "default": 10,
      "aliases": [

      ],
      "advanced": true,
      "description": "Maximum number of seconds to establish a TCP connection"
    },
    {
      "type": "integer",
      "name": "TCP::max_send_size",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Maxiumum tcp segment size.  (0 = disable)"
    },
    {
      "type": "integer",
      "name": "TCP::send_delay",
      "required": false,
      "default": 0,
      "aliases": [

      ],
      "advanced": false,
      "description": "Delays inserted before every send.  (0 = disable)"
    },
    {
      "type": "string",
      "name": "MAILFROM",
      "required": true,
      "default": "root@localhost",
      "aliases": [

      ],
      "advanced": false,
      "description": "FROM address of the e-mail"
    },
    {
      "type": "string",
      "name": "MAILTO",
      "required": true,
      "default": "postmaster@localhost",
      "aliases": [

      ],
      "advanced": false,
      "description": "TO address of the e-mail"
    },
    {
      "type": "string",
      "name": "EHLO_NAME",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": false,
      "description": "The name to send in the EHLO"
    },
    {
      "type": "string",
      "name": "SourceAddress",
      "required": false,
      "default": null,
      "aliases": [

      ],
      "advanced": true,
      "description": "The IP or hostname of this system as the target will resolve it"
    },
    {
      "type": "bool",
      "name": "SkipEscalation",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify this to skip the root escalation attempt"
    },
    {
      "type": "bool",
      "name": "SkipVersionCheck",
      "required": true,
      "default": false,
      "aliases": [

      ],
      "advanced": true,
      "description": "Specify this to skip the version check"
    }
  ]
}